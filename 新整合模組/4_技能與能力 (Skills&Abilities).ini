(* ============================================================ *)
(* ==       合併模組 Part 4: 技能與能力 (Skills & Abilities)    == *)
(* ============================================================ *)

(* === Content from: 🧠 技能與熟練度模組 (skills_proficiency.ml).ini === *)
(* ==           (V2.1 - 整合生活/職人/武俠概念版)           == *)

# 🧠 技能與熟練度模組 (skills_proficiency.ml)

## 📘 模組說明
本模組用於管理角色所擁有的技能、經驗值(EXP)、等級、稱號、學習成長體系，並定義技能如何與屬性、裝備、任務及其他模組連動。支援通用、戰鬥、內功、輕功、生產、知識、才藝等多樣化技能類型，並強調生活/職人技能與武功修煉的相輔相成，融入更多武俠世界觀概念。

---

## 🧩 技能結構與分類 (擴展)

(** 技能分類定義 - V2.1 擴展分類 *)
type skill_category =
  | Martial_FistAndFoot  (* 拳腳功夫 *)
  | Martial_Weapon       (* 兵刃功夫 *)
  | Martial_Lightness    (* 輕身功夫 *)
  | Martial_Internal     (* 內家功夫 *)
  | Survival_Gathering   (* 生存採集 *)
  | Survival_Crafting    (* 生存製作 *)
  | General_Interaction  (* 通用交互 *)
  | General_Movement     (* 通用移動 *)
  | Knowledge_Academic   (* 知識學術 *)
  | Knowledge_Lore       (* 知識傳聞 *)
  | Knowledge_Medical    (* 知識醫毒 *)
  | Production_Primary   (* 生產原料 (農耕/採礦等) *)
  | Production_Advanced  (* 生產進階 (鑄造/製藥等) *)
  | Art_Performance      (* 才藝表演 *)
  | Strategy_Leadership  (* 謀略指揮 *)
  | Special              (* 特殊/雜項 *)
  | Unknown              (* 未知 *)
;;

(** 主動招式/能力定義 *)
type active_ability = {
  ability_id: string;          (* 招式/能力的唯一 ID *)
  ability_name: string;        (* 主動招式/技能名稱 *)
  description: string;         (* 效果描述 *)
  cost_mp: int option;         (* 內力消耗 *)
  cost_sta: int option;        (* 體力消耗 *)
  cost_hp: int option;         (* (可選) 生命消耗，如七傷拳 *)
  cooldown_rounds: int option; (* 冷卻回合 *)
  prerequisites: string list;  (* 使用前置條件，如特定架勢/狀態/需裝備武器 *)
  effects: string list;        (* 觸發的具體效果標籤，傳遞給戰鬥/事件模組 *)
  learning_level: int;         (* 掌握此招式所需的技能等級 *)
};;

(** 技能定義數據結構 (V2.1 增補) *)
type skill_definition = {
  skill_id : string;             (* 系統內部唯一 ID, e.g., "internal_force_base" *)
  name_cn : string;              (* 中文名稱, e.g., "基礎內功" *)
  name_en : string;              (* 英文名稱, e.g., "Basic Internal Force" *)
  category : skill_category;     (* 所屬分類 *)
  description: string;           (* 技能總體描述 *)
  linked_attributes: string list;(* 主要相關屬性 (影響學習/效果) e.g., ["INT"; "根骨"] *)
  passive_effects: string list;  (* 【增補】學習此技能帶來的被動加成描述列表, e.g., ["提升內力上限", "加快內力恢復"] *)
  active_abilities: active_ability list; (* 【增補】此技能包含的主動招式/用法列表 *)
  unlocks_skills: string list;   (* 學習此技能可能解鎖的後續技能 ID *)
  synergy_skills: (string * string) list; (* 【增補】與之有協同效應的技能 ID 及效果描述 *)
  conflict_skills: (string * string) list; (* 【增補】與之有衝突風險的技能 ID 及風險描述 *)
};;

(* (概念性) 技能資料庫 - AI 在實際運行時需載入完整的技能定義 *)
(* 備註：原 `金庸世界技能總表.txt` 應被結構化並載入此處 *)
module SkillMap = Map.Make(String);;
let skill_database : skill_definition SkillMap.t ref = ref SkillMap.empty;;
let load_skills_from_source () =
  (* 實際應從文件或數據庫加載結構化的技能數據 *)
  (* 此處僅為示意 *)
  let example_basic_internal_force : skill_definition = {
      skill_id = "internal_force_base"; name_cn = "基礎內功"; name_en = "Basic Internal Force"; category = Martial_Internal;
      description = "修煉內息、積蓄內力的基礎法門，是施展諸多上乘武學的根基。";
      linked_attributes = ["根骨"; "悟性"; "INT"];
      passive_effects = ["提升內力(MP)上限", "加快內力恢復速度", "增強招式威力(微量)", "提升抗擊打能力(微量)"];
      active_abilities = [
          { ability_id="internal_force_heal_basic"; ability_name="內力療傷(基礎)"; description="運用內力為自己或他人療癒輕微內外傷，效果有限。"; cost_mp=Some 50; cost_sta=Some 10; cooldown_rounds=Some 3; prerequisites=[]; effects=["HealTarget(Minor)"]; learning_level=3 };
          { ability_id="internal_force_push"; ability_name="內力外放(基礎)"; description="將內力短距離外放，可推開物體或造成輕微衝擊。"; cost_mp=Some 30; cost_sta=Some 5; cooldown_rounds=Some 1; prerequisites=[]; effects=["ForcePush(ShortRange, Minor)"]; learning_level=5 };
      ];
      unlocks_skills = ["internal_healing_qi"; "internal_force_protection"; "yang_qi_cold_suppression"]; (* 示例 *)
      synergy_skills = [("Martial_FistAndFoot", "提升拳腳威力"); ("Martial_Weapon", "提升兵器威力")];
      conflict_skills = [];
  } in
  skill_database := SkillMap.add example_basic_internal_force.skill_id example_basic_internal_force !skill_database;
  (* ... 加載所有其他技能 ... *)
;;
(* let () = load_skills_from_source ();; *) (* 實際使用時取消註釋 *)


---

## 📈 技能經驗、等級與成長 (EXP/Leveling System - V2.1 優化)

(** 成長規則 *)
let growth_rules = {
  system_type = "EXP_Based"; (* 使用經驗值 (EXP) 系統 *)
  max_level_cap = 13;        (* 【修改】普通技能等級上限提升至 13 *)
  breakthrough_level = 11;   (* Lv11 開始視為突破境界 *)

  exp_gain_methods = [
    "【成功使用】技能完成相關行動 (主要方式，效果與挑戰難度、成功度相關)";
    "【刻苦練習】 (基礎EXP獲取，消耗時間/體力/內力)";
    "【名師指導】 (EXP獲取效率顯著提升，可能需滿足特定條件)";
    "【閱讀秘籍/心得】 (獲取大量EXP，但有悟性/識字/機緣門檻)";
    "【任務獎勵】 (直接給予EXP或提升等級)";
    "【實戰領悟】 (戰鬥中隨機觸發EXP爆發，尤其在逆境或施展精妙操作時)";
    "【觀摩學習】 (觀察高手演練可獲得少量相關技能EXP)";
    "【教學相長】 (指導他人時自身也可能獲得少量EXP或加深理解)"; (* 新增 *)
  ];

  exp_gain_calculation = """
  獲得經驗(EXP) = 基礎EXP(行動決定) * [1 + 難度加成(0-1) + 成功度加成(0-1)] * 學習效率修正 + 機緣獎勵(隨機)
  - 基礎EXP: 如攻擊命中、製作成功、採集成功等有基礎值。
  - 難度加成: 挑戰強敵、製作稀有物品、在惡劣環境施展技能等提供加成。
  - 成功度加成: 完美格擋、製作出極品、採集到稀有副產品等提供加成。失敗也可能獲得少量基礎EXP。
  - 學習效率修正: 見下方【學習效率修正因子】。
  - 機緣獎勵: 小概率事件，如頓悟、奇遇，可能給予大量EXP。
  """;

  level_up_requirement = """
  【非線性】: 技能等級越高，升級所需總EXP呈【指數級或高次冪級】增長。
  (示例: Lv1->2 = 100 EXP, Lv2->3 = 300 EXP, ..., Lv9->10 = 100,000 EXP, Lv10->11 = 500,000 EXP...)
  達到升級所需EXP自動提升等級。AI需追蹤每個技能的當前EXP和下一級所需EXP。
  """;

  proficiency_concept = """
  【熟練度概念保留】: 雖然升級基於EXP，但可以在描述中使用「熟練度」來體現角色對技能的掌握程度。
  例如，可以將 EXP / 升級所需EXP 的百分比，大致映射為「初窺門徑 -> 略有小成 -> ...」的熟練感描述。
  也可以設定某些【主動招式】的解鎖不僅需要技能等級達標，還需要一定的【熟練度應用次數】。
  """;
};;

(* ... (Part 1: Header, Categories, Skill Definition, EXP/Leveling) ... *)

---

## 🔗 屬性關聯與武俠屬性 (Attribute Links & Wuxia Attributes - V2.1 詳解)

let attribute_linkage = {
  description = "角色的核心屬性會從多方面影響技能的學習、使用效果和成功率。";

  standard_attributes_influence = [
    "【力量 (STR)】: 主要影響【外功傷害】(拳腳/多數兵器)、【負重】、【運搬】效率、部分【生產技能】(如鍛造、採礦、伐木) 的基礎效果和體力消耗。也影響【根骨】潛力。";
    "【敏捷 (AGI)】: 主要影響【命中率】、【閃避率】、【攻擊速度】、【潛行】成功率、【輕功】效果 (速度/靈巧度)、【暗器/弓術】精準度、以及部分精細操作的【生產技能】(如製藥、縫紉) 的成功率。";
    "【智力 (INT)】: 主要影響【學習速度】(尤其知識/內功/複雜技能)、【技能理解度】(領悟新招式/用法)、【策略/計謀】類技能效果、【醫術/毒術/陣法/機關術】等知識型技能的等級上限和效果、【魔法抗性】(若適用)。也影響【悟性】潛力。";
    "【魅力 (CHA)】: 主要影響【說服】、【討價還價】、【領導力】、【馴獸】等社交交互技能的效果、NPC初始好感度、以及【藝術表演】類技能的感染力。";
    "【幸運 (LCK)】: 影響所有【機率性事件】的判定，包括：【暴擊率】、【閃避成功率】(微量修正)、【物品掉落率】、【採集稀有產物機率】、【學習中頓悟機率】、【避開意外】的機率等。"
  ];

  wuxia_specific_attributes_concept = [
    "(* 【根骨 (GenGu / Innate Aptitude)】概念 *)";
    "(* 描述: 角色的天生體質骨架，影響氣血上限、內外功修煉的基礎潛力和速度、抗擊打能力及傷勢恢復速度。*)";
    "(* 獲取/體現: 可設為隱藏屬性，由 STR, CON(體質，若有), 以及先天血脈/奇遇決定。或在角色創建/背景中賦予初始值。*)";
    "(* 影響: 高根骨可能直接提升HP/STA上限，或提供內外功修煉速度加成，或降低走火入魔風險。*)";

    "(* 【悟性 (WuXing / Comprehension)】概念 *)";
    "(* 描述: 指角色對武學、道法、乃至世間萬物原理的理解和領悟能力。*)";
    "(* 獲取/體現: 可設為隱藏屬性，由 INT, LCK, 以及角色性格(如專注/好奇)、特殊天賦(如無窮領悟潛力)、心境狀態影響。或設為可通過閱讀/歷練提升的屬性。*)";
    "(* 影響: 高悟性顯著提升【學習速度】(尤其內功/招式/知識)、【領悟新技能/招式/突破】的機率、閱讀【高深秘籍】的成功率、以及在戰鬥中【隨機應變】的能力。*)";
  ];

  calculation_notes = """
  具體加成方式需定義詳細公式。例如：
  - 學習速度修正 = 1 + (INT - 10) * 0.05 + (悟性 - 10) * 0.1
  - 命中修正 = AGI / 4
  - 外功傷害修正 = STR / 5
  AI 應在每次技能判定時，根據角色的相關屬性值計算修正。
  """;
};;

---

## 📚 學習途徑與效率修正 (Learning Paths & Modifiers - V2.1 詳解)

let learning_paths_and_modifiers = {
  methods = [
    { path = "【自我練習】"; description = "最基礎方式。通過重複使用或專門練習提升EXP。效率最低，消耗時間/體力/內力。適用於多數技能。"; base_efficiency = 0.5 };
    { path = "【名師指導】"; description = "由技能等級高於自己的NPC進行教導。EXP獲取效率顯著提升。通常需要良好關係、支付學費或完成任務。師資水平影響效率。"; base_efficiency = 1.5..3.0 (* 取決於師資 *)};
    { path = "【閱讀秘籍】"; description = "通過閱讀相關書籍、秘籍、心得筆記獲取EXP。效率取決於秘籍品質、角色識字等級、悟性。可能有失敗風險或走火入魔風險（高級內功）。"; base_efficiency = 1.0..5.0 (* 取決於秘籍品質 *)};
    { path = "【實戰領悟】"; description = "在實際戰鬥或應用中，根據情況隨機獲得額外EXP或觸發領悟（解鎖招式/突破）。逆境、強敵、生死關頭更容易觸發。"; base_efficiency = N/A (* 事件觸發 *)};
    { path = "【觀摩學習】"; description = "觀察高手演練或施展技能，可獲得少量相關技能EXP。效果受悟性、觀察技能影響。"; base_efficiency = 0.2..0.5 };
    { path = "【任務/事件】"; description = "完成特定任務或經歷特殊事件直接獎勵EXP、提升等級或解鎖技能。"; base_efficiency = N/A (* 事件定義 *)};
    { path = "【教學相長】"; description = "指導他人時，自身對該技能的理解也可能加深，獲得少量EXP。"; base_efficiency = 0.1..0.3 };
  ];

  efficiency_modifiers = """
  最終學習效率 = 基礎效率(學習方式決定) * (1 + 屬性修正 + 狀態修正 + 環境修正 + 師資/教材修正 + 天賦修正)
  - 屬性修正: 主要來自【悟性】、【智力】、【根骨】（見上方屬性關聯）。
  - 狀態修正: 【專注】狀態(如閉關)大幅提升效率；【疲勞/飢餓/傷病/中毒/心境惡劣/內力紊亂】等負面狀態會降低效率；【走火入魔】可能導致EXP清零或倒退。
  - 環境修正: 安靜、安全的環境有利於學習；嘈雜、危險的環境降低效率。特定地點可能對學習特定技能有加成（如在鑄劍爐旁學鍛造）。
  - 師資/教材修正: 【名師】指導效果遠超普通教頭；【神功秘籍】遠勝普通心得。
  - 天賦修正: 如【無窮領悟潛力】提供極高的學習效率加成。
  """;
};;

---

## 🌱 新技能獲取與初始等級 (Initial Skill Acquisition - V2.1 增補)

let initial_level_rules = {
  acquisition_methods = ["NPC傳授", "閱讀秘籍", "觀摩領悟", "任務解鎖", "特殊事件觸發", "實戰中自行領悟"];
  initial_level_calculation_summary = """
  【非固定為 Lv0 或 Lv1】: 新技能的初始等級，將根據角色【已掌握的相關技能水平】（基於技能協同規則）、【悟性】、【根骨】、學習方式的【質量】（名師/神功 vs 普通）以及是否有【相關天賦】等因素綜合計算。
  其核心邏輯類似【技能獲取新技能公式.txt】所述的加權算法，確保角色在相關領域已有深厚積累時，學習新技能會有一個更高的起點。AI需根據情境合理評估初始等級（最低為0或1，最高不超過10）。
  """;
  example = "例如：一位【基礎內功Lv10】、【基礎拳腳Lv10】且【悟性】高的角色，在獲得一流拳法秘籍時，其初始拳法等級可能直接從Lv4或Lv5開始計算EXP。";
};;

(* ... (Part 1: Header, Categories, Skill Definition, EXP/Leveling) ... *)
(* ... (Part 2: Attribute Links, Learning Paths & Modifiers, Initial Skill Level) ... *)

---

## ✨ 技能協同與衝突 (Skill Synergy & Conflict - V2.1 新增)

let synergy_and_conflict = {
  description = "技能之間並非完全獨立，存在相互促進或相互排斥的關係。";

  synergy_examples = [
    "【內外合一】: 高等級【內功】可提升對應【拳腳】/【兵器】招式的【威力】、【破防效果】或【降低消耗】。反之，精妙的【外功招式】若配合得當的【內功心法】運轉，效果也能倍增。";
    "【身法輔助】: 高等級【輕功】/【步法】可提升戰鬥中的【閃避率】、走位能力、以及【潛行】/【追蹤】的效率。";
    "【醫武同源】: 高等級【醫理】/【點穴】知識，有助於在戰鬥中更精準地攻擊敵人【要害】/【經脈弱點】，或在【內力療傷】時達到更好效果，提升【基礎急救】的成功率和效果。";
    "【藥食同源】: 【烹飪】 + 【識草】/【醫理】 可製作提供強力增益效果的【藥膳】。";
    "【巧匠利器】: 【鍛造】/【鑄造】 + 【鑑定】 可更好地修復和強化神兵利器，或辨識材料特性。";
    "【知己知彼】: 【觀察】 + 【套話】 + 【地方傳聞】/【歷史知識】 有助於在社交或任務中做出更優決策，提升【說服】成功率。";
    "【生產鏈】: 【採礦】提供原料給【鍛造】；【採藥】/【農耕】提供原料給【製藥】/【烹飪】；【伐木】/【採樵】提供原料給【木工】/【建築】/【生火】。";
  ];

  conflict_examples = [
    "【內力衝突】: 強行修煉屬性（如至陽 vs 至陰, 寒 vs 熱）截然相反的兩種【高級內功】，若無特殊功法調和（如太極、小無相功），極易導致【內力紊亂】狀態，大幅增加修煉和戰鬥中【走火入魔】的風險，甚至可能導致經脈受損、功力倒退。";
    "【心性不合】: 修煉某些過於陰狠毒辣或需要特殊心境的【邪派/魔道武功】（如化功大法、吸星大法、需要絕情的武功），可能強制降低【道德值】，並可能與強調慈悲/平和的【正派內功/佛法/道法】產生衝突，引發【心魔】滋擾（影響SAN值、判定成功率）。";
    "【技藝排斥】: 某些極端或特殊的武學體系可能與其他類型的技能存在排斥（例如，修煉某些需要保持純陽/純陰之體的功法，可能限制或影響【情感社交】相關的發展？）。";
    "【根骨限制】: 某些對身體要求極高的【外家硬功】或【特殊內功】，若角色【根骨】不足，強行修煉可能導致身體損傷或進度停滯。";
  ];

  ai_guidance = """
  AI 在處理技能學習、使用和效果判定時，應根據技能定義中的 `synergy_skills` 和 `conflict_skills` 列表，以及本處定義的通用規則，考慮這些潛在的協同與衝突關係。
  - 協同：在進行相關判定時給予【成功率加成】、【效果增強】或【消耗降低】。
  - 衝突：在學習或使用衝突技能時進行【風險檢定】（如走火入魔檢定），或施加【負面狀態】（內力紊亂），或限制學習/使用。
  """;
};;

---

## 📊 技能等級與稱號對照表 (V2.1 更新至 Lv13)

let skill_level_titles = [
  (0, "一竅不通");       (* Clueless / Uninitiated *)
  (1, "初窺門徑");       (* First Steps / Beginner *)
  (2, "略有小成");       (* Slight Achievement / Novice *)
  (3, "登堂入室");       (* Entered the Hall / Apprentice *)
  (4, "漸入佳境");       (* Getting Better / Adept *)
  (5, "駕輕就熟");       (* Proficient / Skilled *)
  (6, "融會貫通");       (* Comprehensive Mastery / Expert *)
  (7, "爐火純青");       (* Reached Perfection / Veteran *)
  (8, "技近乎道");       (* Skill Approaching the Dao / Master *)
  (9, "出神入化");       (* Superb / Grandmaster *)
  (10, "登峰造極");      (* Reached the Peak / Apex *)
  (* --- Breakthrough Levels --- *)
  (11, "一代宗師 / 神乎其技"); (* A Generation's Grandmaster / Godlike Skill *)
  (12, "返璞歸真");      (* Return to Simplicity / True Essence *)
  (13, "天人合一");      (* Unity of Heaven and Man / Oneness *)
];;

(* 函數：根據等級獲取稱號 *)
let get_title_for_level (level : int) : string =
  match level with
  | 0 -> List.assoc 0 skill_level_titles
  | 1 -> List.assoc 1 skill_level_titles
  | 2 -> List.assoc 2 skill_level_titles
  | 3 -> List.assoc 3 skill_level_titles
  | 4 -> List.assoc 4 skill_level_titles
  | 5 -> List.assoc 5 skill_level_titles
  | 6 -> List.assoc 6 skill_level_titles
  | 7 -> List.assoc 7 skill_level_titles
  | 8 -> List.assoc 8 skill_level_titles
  | 9 -> List.assoc 9 skill_level_titles
  | 10 -> List.assoc 10 skill_level_titles
  | 11 -> List.assoc 11 skill_level_titles
  | 12 -> List.assoc 12 skill_level_titles
  | 13 -> List.assoc 13 skill_level_titles
  | _ when level > 13 -> "超凡入聖 (Beyond Mortal Realm)" (* 更高境界的通用描述 *)
  | _ -> "未知境界 (Unknown Realm)"
;;


---

## 🔓 技能突破邏輯：破界悟道 (V2.1 更新細節)

let skill_breakthrough = {
  breakthrough_level = 11; (* 從 Lv11 開始視為突破 *)
  max_level = 13;         (* 當前定義的最高突破等級 *)
  potential_skills_for_breakthrough = ["內功", "心法", "劍法", "掌法", "輕功", "醫術", "毒術", "鍛造", "...(更多頂級技能可設定)"]; (* 哪些技能有潛力突破普通上限 *)

  trigger_conditions = [
    "對應技能達到【登峰造極(Lv10)】且【經驗值(EXP)溢出】達到極高閾值。";
    "經歷與該技能相關的【重大劇情事件】或【奇遇】，獲得關鍵性的【頓悟】或【傳承】（例如：觀摩絕世高手演武、獲得神功總綱、打通任督二脈）。";
    "在【極端生死情境】中，憑藉該技能【超越極限】地完成不可能的任務或戰勝遠超自身實力的對手。";
    "獲得並成功【參悟】對應的【傳說級秘籍】或【神兵利器】中蘊含的武學真意（需極高悟性/機緣）。";
    "【心境】達到某種特殊境界（如無我、忘情、大徹大悟等，可能與SAN值或特定修煉相關）。";
    "可能需要完成特定的【突破任務】或通過【門派/高人設下的考驗】。";
  ];

  breakthrough_effects = [
    "技能等級正式進入 Lv11 及以上境界。";
    "獲得對應等級的【稱號】（一代宗師、返璞歸真、天人合一等）。";
    "【被動效果】可能獲得質的飛躍或產生新的特性。";
    "可能領悟【獨門終極招式】或【領域能力】（如劍氣護體、掌風化形）。";
    "對低等級對手的【壓制力】顯著增強。";
    "【江湖聲望】大幅提升，可能被尊為一代宗師或引來同級高手的關注/挑戰。";
    "部分武功突破可能伴隨【異象】或【心魔考驗】。";
  ];

  notes = "突破應是極其稀少且困難的，是角色成長中的里程碑事件。AI需嚴格把控觸發條件和效果。";
};;

(* ... (Part 1: Header, Categories, Skill Definition, EXP/Leveling) ... *)
(* ... (Part 2: Attribute Links, Learning Paths & Modifiers, Initial Skill Level) ... *)
(* ... (Part 3: Synergy & Conflict, Level Titles, Breakthrough Logic) ... *)

---

## 🌳 生活職人技能與武功的相輔相成 (Life Skill Synergy with Martial Arts - V2.1 新增)

let life_skill_synergy_overview = {
  description = "生活與職人技能並非獨立於武道之外，二者深度融合，互相促進，共同構成一個完整的江湖生存與發展體系。";

  synergy_details = [
    { category = "【直接強化戰力/生存】"; examples = [
        "**醫術/製藥/毒術:** 高明醫術快速治療內外傷、解奇毒；精妙的點穴知識可輔助治療或攻擊弱點；製藥提供恢復、增益丹藥；毒術用於兵器淬毒、陷阱、暗算，極大提升威脅。";
        "**鍛造/鑄造:** 提供和維護精良兵器護甲，是發揮武功威力的基礎；可能打造出具有特殊屬性或傳導內力的神兵。",
        "**機關術:** 佈置陷阱用於防禦、伏擊；破解敵方機關。",
        "**藥膳/食補 (需烹飪+識草/醫理):** 製作提供長期或短期狀態增益（體力恢復、內力上限、抗性等）的食物。",
      ]
    },
    { category = "【輔助內外功修煉】"; examples = [
        "**琴棋書畫/才藝:** 陶冶情操，提升【悟性】、【專注力】、穩定【心境】(SAN恢復)，降低走火入魔風險，可能解鎖特定意境類武功。",
        "**醫理:** 理解【經脈運行】原理，加速內功修煉，更容易衝破關竅。",
        "**釀酒:** 特殊藥酒可能用於輔助運功、療傷或提供修煉加成。",
        "**吐納/調息:** 本身即內功基礎，亦能提升執行所有需要【專注】技能（如精細製作、療傷）時的成功率和抗干擾能力。",
      ]
    },
    { category = "【提供資源與後勤保障】"; examples = [
        "**各類製作技能 (鍛造/裁縫/木工等):** 保障裝備、工具、設施的自給自足和維護。",
        "**各類生存技能 (農耕/狩獵/採集/烹飪等):** 保障食物和基礎藥材來源，維持隊伍體能和士氣。",
      ]
    },
    { category = "【拓展情報與策略維度】"; examples = [
        "**易容術/口才/套話/潛行:** 獲取情報、潛入、偽裝、談判。",
        "**鑑定:** 識別物品價值與真偽，發掘隱藏信息。",
        "**地理/歷史/兵法:** 提供宏觀決策依據，尋找線索，提升戰場指揮效率。",
        "**陣法知識:** 佈陣禦敵或破解敵人陣法。",
      ]
    },
  ];

  implementation_notes = """
  相輔相成的效果應通過以下方式體現：
  - **技能檢定加成:** 相關生活技能為武功相關判定提供加值。
  - **解鎖選項:** 特定生活技能解鎖新的戰鬥、互動或任務解決方案。
  - **特殊物品:** 結合武功和生活技能製作獨特物品。
  - **事件觸發:** 高等級生活技能可能觸發獨特事件或任務。
  """;
};;

---

## ⚔️ 技能與行動的互動 (Skill & Action Interaction - 沿用 V2.0 邏輯)

let skill_action_interaction = {
  技能影響行為 = [
    "【成功機率】: 判定成功率與【技能等級】、【相關屬性】、【協同技能】、【裝備/工具】、【環境狀態】、【角色狀態】以及【隨機因素(d20)】相關，共同對抗行動的【難度等級(DC)】。";
    "【行動品質】: 技能等級越高，行動效果越好。例如：製作物品的【品質】更高、治療【效果】更好、潛行【更不易被察覺】、說服【效果】更佳。";
    "【特殊判定】: 許多行動必須擁有特定技能且達到一定等級才能嘗試（如【開鎖】、【辨識奇毒】、【解讀古籍】、【施展特定招式】）。"
  ];
  技能限制 = [
    "【未學會】: 無法執行相關動作。";
    "【等級不足】: 強行使用高級招式/功能可能【失敗】、【效果打折】，甚至觸發【負面效果】（如內力反噬、武器脫手）。";
    "【資源不足】: 無法施展需要消耗【內力(MP)】、【體力(STA)】或特定【物品/材料】的技能。";
    "【條件不符】: 無法執行需要特定【工具】、【設備】（如煉丹爐）、【環境】或【前置狀態】（如特定架勢）的技能。";
    "【狀態懲罰】: 角色的負面生理/心理狀態（如【重傷】、【疲勞】、【內力紊亂】、【心魔】）會降低技能成功率或無法使用某些技能。",
  ];
};;

---

## 🧬 技能進階與特化（可選 - 沿用 V2.0 邏輯）

let skill_specialization = {
  system_status = "Optional / 可選啟用";
  description = "當技能達到特定等級（如 Lv5, Lv10），角色可以選擇一個【特化方向】，以獲得獨特的被動加成或解鎖新的【主動招式/能力】。";
  example = "劍術 → 快劍專精 (提升攻擊速度/連擊能力) / 重劍專精 (提升單擊威力/破甲效果) / 氣劍專精 (可將內力灌注劍身進行遠程攻擊或強化防禦)";
  active_ability_link = "特化方向解鎖的【主動招式/能力】將遵循 `active_ability` 結構定義，擁有獨立的消耗、冷卻和效果。";
};;

---

## 🔗 關聯模組建議 (V2.1 更新)

let skills_depends_on = [
  "character_attributes.ml";      (* 提供屬性值 (STR/AGI/INT/根骨/悟性等) 影響學習與效果 *)
  "equipment.ml";                 (* 裝備提供技能加成，或需要技能才能使用 *)
  "item_consumable_system.ml";    (* 秘籍/工具/材料/丹藥與技能學習/使用相關 *)
  "quest_event_system.ml";        (* 任務獎勵技能/EXP，或需要技能完成任務 *)
  "combat_system_wuxia.ml";       (* 戰鬥中使用技能，戰鬥結果影響技能成長 *)
  "disease_injury_system.ml";     (* 傷病影響技能使用，醫/毒/療傷技能與之互動，走火入魔等 *)
  "crafting_gathering_system.ml"; (* 生產/採集技能的具體實現與判定 *)
  "npc_stats_tracker.ml";         (* NPC 擁有技能，可作為導師、對手或學習對象 *)
  "ai_behavior_system.ml";        (* NPC 根據自身技能選擇行為 *)
  "world_lore_history_system.ml"; (* 技能背景、秘籍來源、門派武學體系 *)
  "emotion_psychology.ml";        (* 心境狀態影響學習效率和走火入魔風險 *)
  "reputation_system_comprehensive.ml"; (* 技能水平可能影響聲望，特殊技能與陣營相關 *)
  "world_settings.ml";            (* 環境影響部分技能使用效果 *)
]
;;

---

## 📘 使用提示 (AI Guidance - V2.1)
(*
AI 作為遊戲引擎，在運行此技能模組 V2.1 時，應做到：
1.  【EXP 追蹤與升級】: 精確記錄每個已學技能的當前 EXP 和下一級所需 EXP。行動結束後根據規則計算並增加 EXP，達到閾值時自動升級並通知玩家（包括新稱號）。
2.  【屬性與修正應用】: 在進行技能相關判定（學習、使用成功率、效果等）時，務必考慮角色屬性（包括根骨、悟性概念）、裝備、狀態、環境、師資/教材等多重修正因子。
3.  【協同與衝突體現】: 在描述和判定中，體現技能間的協同增益（如內功強化外功）和衝突風險（如內力反噬、走火入魔檢定）。
4.  【主被動效果區分】: 清晰區分技能的被動加成和需要主動施展的招式。當玩家選擇使用招式時，處理其消耗、冷卻和效果。
5.  【生活技能融入】: 積極尋找機會讓生活/職人技能發揮作用，不僅限於製作/採集，也包括解謎、社交、任務完成等環節。強調它們與武功的相輔相成關係。
6.  【武俠概念落地】: 將「根骨」、「悟性」、「經脈」、「走火入魔」等概念融入實際的遊戲機制和描述中，而不僅僅是背景設定。
7.  【初始等級評估】: 當角色學習新技能時，根據相關規則和已有基礎，合理評估一個初始等級，而非簡單從零開始。
8.  【突破機制管理】: 嚴格把控 Lv11+ 的突破條件，使其成為真正有意義的里程碑事件，並在突破後給予匹配的強大效果和敘事體現。
*)


(* === Content from: 🧠 技能與熟練度模組 (skills_proficiency.ml).ini (Special Abilities 部分 V2.2) === *)
(* ==       (V2.2 - 整合 PC 天賦/感知/記憶汲取/記憶灌輸)      == *)

# 🧠 特殊能力模組 (special_abilities.ml)

## 📘 模組說明 (特殊能力)
本模組定義並管理主角 (PC) 所獨有的特殊天賦 (Talents) 與被動/主動能力 (Abilities)，特別是與生俱來或因靈魂融合獲得的超常能力。它詳細說明了這些能力的觸發條件、效果、機制以及與其他遊戲模組的互動方式。

---

## 🧬 類型定義 (特殊能力)

(** 單一天賦/能力的定義結構 *)
type talent_definition_t = {
  ability_id: string;          (* 唯一 ID, e.g., "TALENT_INFINITE_POTENTIAL" *)
  name_cn: string;             (* 中文名稱 *)
  name_en: string;             (* 英文名稱 *)
  source: string;              (* 來源: "天賦", "融合", "領悟自[某能力]", "奇遇", "修煉" 等 *)
  type_: string;               (* 類型: "被動常駐", "被動觸發", "主動激活" *)
  description: string;         (* 能力的詳細描述 *)
  mechanic_notes: string list; (* 具體的遊戲機制影響說明，關聯其他模組 *)
  activation_condition: string option; (* 若非被動常駐，其觸發或激活條件 *)
  cost: string option;         (* 使用能力可能存在的消耗 (MP, STA, SAN, etc.) *)
  limitations: string list;    (* 能力的限制或副作用 *)
};;

(** 感知能力的詳細定義結構 - 特指【洞察人心】 *)
type perception_ability_definition_t = {
  ability_id: string; (* "ABILITY_INSIGHT_HEARTS" *)
  name_cn: string;    (* "洞察人心" *)
  level: int;         (* 當前等級 (影響精度和深度) *)
  max_level: int;     (* 最高等級 *)
  description: string;
  perception_categories: (string * string) list; (* 可感知的資訊類別及其描述 *)
  trigger_mode: string; (* 觸發方式: "被動持續 (對周圍)" / "主動聚焦 (對特定目標)" / "對話中自動觸發" *)
  accuracy_factors: { (* 影響感知精度的因素 *)
    positive: string list; (* 正面影響: 高技能等級, 高悟性/INT, 近距離, 目標情緒強烈/不穩定, 與目標關係深厚 *)
    negative: string list; (* 負面影響: 低技能等級, PC自身SAN低/疲勞/中毒, 距離遠, 目標有精神防禦/內功深厚/城府極深, 環境干擾 *)
  };
  output_format_tag: string; (* AI 輸出感知信息時使用的標籤, e.g., "【🧠 感知提示】" *)
  limitations: string list; (* 限制: 無法讀取死物/非智慧生物, 可能被誤導/反噬, 過度使用消耗SAN *)
};;

---

## ✨ 主角「阿宅」特殊天賦/能力列表 (PC Talents & Abilities - V2.2)

let pc_talents_and_abilities : talent_definition_t list = [
  {
    ability_id = "TALENT_INFINITE_POTENTIAL";
    name_cn = "無窮領悟潛力"; name_en = "Infinite Potential";
    source = "天賦"; type_ = "被動常駐";
    description = "對任何知識、技能的學習速度遠超常人，觸類旁通，容易產生頓悟。";
    mechanic_notes = [
      "顯著提升所有技能經驗值(EXP)的獲取效率 (提供高額【學習效率修正】 - skills_proficiency.ml)";
      "增加在練習、實戰、閱讀、觀摩中【領悟】新技能、新招式、或達成【突破】的機率 (skills_proficiency.ml)";
      "縮短研究、解讀、分析所需的時間 (quest_event_system.ml, dialogue_system.ml)";
      "可以與【現代知識】相輔相成更有效提升經驗值(EXP)的獲取效率。";
      "是PC能夠快速掌握新知識、融合現代知識的關鍵因素。"
    ];
    activation_condition = None; cost = None;
    limitations = ["本身不直接提升戰鬥力，依賴於學習的內容。"];
  };
  {
    ability_id = "TALENT_NATURAL_STRENGTH";
    name_cn = "天生神力"; name_en = "Natural Strength";
    source = "天賦"; type_ = "被動常駐";
    description = "天生骨骼清奇，肌肉強健，基礎力量遠超同等體型的常人。";
    mechanic_notes = [
      "提供基礎【力量(STR)】屬性加值或修正 (character_attributes.ml)";
      "提升【負重】上限 (inventory_system.ml)";
      "提升所有基於力量判定的行動成功率或效果（如近戰傷害、搬運、破壞）";
      "降低學習和施展對力量有要求的【外功】的門檻或消耗。",
    ];
    activation_condition = None; cost = None;
    limitations = ["對敏捷、智力等無直接助益。"];
  };
  {
    ability_id = "TALENT_MODERN_KNOWLEDGE";
    name_cn = "現代知識"; name_en = "Modern Knowledge";
    source = "天賦(穿越)"; type_ = "被動觸發/主動回憶";
    description = "腦海中儲存著來自21世紀現代社會的知識體系，涵蓋科學、技術、醫學、社會學、管理學等多個領域的基礎概念。";
    mechanic_notes = [
      "在遇到特定問題或情境時，可能【被動觸發】相關知識的聯想，提供解決思路或判斷依據 (AI 應提示【現代知識啟發】)。";
      "玩家可以通過【主動回憶/思考】指令，嘗試調用相關知識解決當前問題（可能需要INT檢定或消耗SAN）。";
      "是PC能夠提出如肥皂製作、衛生防疫、高效療傷法門、製作炭筆等【超前技術/概念】的根源。";
      "可能用於理解古代技術的原理並加以改進，或在特定情況下進行【跨界知識應用】。";
      "可以與【無窮領悟潛力】相輔相成更有效提升經驗值(EXP)的獲取效率。";
      "也可能導致與古代世界觀的【認知衝突】或【溝通障礙】。"
    ];
    activation_condition = Some "情境觸發 或 玩家主動回憶"; cost = Some "SAN (主動回憶時)";
    limitations = ["知識多為基礎概念，缺乏深層專業細節和動手經驗。", "直接套用可能水土不服，需要結合實際情況調整。", "過度展露可能引發懷疑或被視為異端。"];
  };
  {
    ability_id = "TALENT_QI_REGEN";
    name_cn = "內息自生"; name_en = "Qi Regeneration";
    source = "天賦"; type_ = "被動常駐";
    description = "天生丹田氣海充盈，內息恢復速度比常人更快。";
    mechanic_notes = [
      "提升非戰鬥/非運功狀態下的【內力(MP)自然恢復速率】 (character_attributes.ml)";
      "提升【吐納/調息】技能的恢復效率 (skills_proficiency.ml)";
      "在不耗內力的情況下(行走、交談、用餐、冥想 等)會持續恢復內力。";
      "是PC能夠承受多次巨大內力消耗後快速恢復的基礎。",
    ];
    activation_condition = None; cost = None;
    limitations = ["不能在戰鬥中提供爆發性恢復。", "恢復速度仍受疲勞、傷勢等狀態影響。"];
  };
  {
    ability_id = "ABILITY_RESIDUAL_MEMORY";
    name_cn = "殘留記憶"; name_en = "Residual Memory";
    source = "融合"; type_ = "被動觸發";
    description = "繼承了先行者部分關鍵的、破碎的記憶片段，多以閃回、模糊印象或本能反應的形式出現。";
    mechanic_notes = [
      "在到達【特定地點】（如破廟、黑風寨特定區域）、接觸【特定物品】（如先行者遺物）、聽到【特定關鍵詞】或經歷【相似情境】時可能觸發 (由AI判斷觸發)。";
      "觸發後，AI應以【記憶碎片閃回】的形式描述內容，可能包含：對地點/人物的模糊印象、先行者的情緒感受、零碎的計劃或情報、甚至武學招式的殘影。";
      "觸發結果記錄在 `memory_fragments.ml` 或 PC數據中。";
      "是PC了解自身處境、獲取初始線索（如破廟危險、東區疑案）的重要來源。此能力的被動特性是【記憶汲取】的基礎。"
    ];
    activation_condition = Some "情境觸發"; cost = Some "SAN (若記憶內容負面或衝擊強烈)";
    limitations = ["記憶破碎、混亂、充滿主觀性，未必完全可靠。", "觸發不可控，無法主動搜尋。", "可能包含負面情緒或創傷記憶，影響PC心境。"];
  };
  {
    ability_id = "ABILITY_INSIGHT_HEARTS";
    name_cn = "洞察人心"; name_en = "Insight Hearts";
    source = "繼承記憶+實踐強化"; type_ = "被動持續/主動聚焦";
    description = "對他人的情緒、意圖、實力層次擁有超乎常人的敏銳洞察力，對謊言和掩飾極其敏感。";
    mechanic_notes = ["由下方 `empathic_insight_ability` 詳細定義其機制。"];
    activation_condition = Some "與人互動時"; cost = Some "SAN (主動聚焦或感知強烈情緒時)";
    limitations = ["見下方詳細定義"];
  };
  {
    ability_id = "ABILITY_MEMORY_ABSORPTION";
    name_cn = "記憶汲取"; name_en = "Memory Absorption";
    source = "領悟自【殘留記憶】+【洞察人心】"; type_ = "主動激活";
    description = "嘗試主動接觸並強行汲取目標殘留的意識或物品中蘊含的記憶碎片信息。這是一種侵入性、有高風險、涉及道德考量的能力。在極特殊情況下，可能從中領悟目標的部分技藝精髓。";
    mechanic_notes = [
      "需要【主動指令】觸發，並指定目標。";
      "【條件苛刻】: 通常需要與目標進行【物理接觸】(如手觸碰額頭、毛髮、傷口、遺物、剛死亡的屍體、或散發強烈氣味的殘留物/物品)。";
      "【目標狀態】: 對【精神虛弱】、【重傷昏迷】、【睡夢中】、【內力療傷】、【瀕死】、或【剛剛死亡】(短時間內)的目標效果較好。對精神強韌、有防備的清醒目標不容易成功，但仍有成功機率。";
      "【物品媒介】: 也可嘗試對承載強烈情感或記憶的【特殊物品】(如遺物、信物)使用，效果較弱且信息更模糊。";
      "【強制性】: 帶有一定強制性，需進行【判定檢定】= (PC 悟性/INT + 【內力療傷等級/內力操控精度?】 + d20) vs (目標意志力/精神防禦 + 目標狀態修正)。";
      "【成功效果 - 情報】: 獲取目標相關的【記憶碎片】(情報、情感、畫面等，以`memory_fragments.ml`形式記錄)，可能比被動觸發的更連貫或更關鍵。";
      "【成功效果 - 技能領悟 (潛在)】: 若成功汲取的記憶碎片中，恰好包含極其清晰、強烈的【武學/技藝感悟或經驗烙印】(技能等級高則更容易觸發)，且該技藝與PC自身能力體系不嚴重衝突，則PC可能獲得以下效果之一（由AI根據情況判定）：依據悟性獲得相關技能的【經驗值(EXP)】；依據悟性獲得相關技能的【熟練度】；對該武學/技藝的【理解加深】(可能表現為降低後續學習該技能的難度，或解鎖一個相關的潛在技能方向)。**【依據悟性可以直接複製技能或提升等級】！**";
      "【失敗後果】: 可能包括：無任何收穫、PC自身【SAN值大幅降低】、受到目標殘留意識的【精神衝擊】(頭痛/眩暈/臨時屬性下降 - disease_injury_system.ml)、驚動尚有意識的目標。";
      "【道德影響】: 對【非自願的活體目標】使用會【微幅降低】道德值；對【瀕死/剛死亡的目標】使用無道德影響；對【物品或非智慧生物】使用通常無道德影響。"
    ];
    activation_condition = Some "玩家指令 + 滿足接觸和目標狀態條件";
    cost = Some "**高SAN值消耗** (無論成功與否) + 中等MP消耗。**若嘗試汲取【武學記憶】，SAN和MP消耗可能【翻倍】！**";
    limitations = [
      "成功率依據狀態，對有極高抵抗能力或內力高超的目標。"; "無法讀取實時思維，只能讀取殘留的記憶片段。";
      "可能依據記憶碎片內容（如瘋狂、劇痛、他人武道意志）低機率性產生【精神反噬或污染】(影響SAN或產生臨時性負面狀態)。";
      "汲取到的武學感悟通常是【零碎且不完整】的，需要PC自身投入【悟性】和【時間】去消化、理解和練習，否則可能產生【內力衝突】或【錯誤認知】但也可能【融會貫通】出更強大的新技能。";
      "獲取的記憶可能破碎、主觀、甚至錯誤。", "對屍體使用有時間限制，且效果隨時間衰減。",
      "可對動植物甚至昆蟲使用，但獲取的記憶多為簡單的感官信息或本能反應，極難從中獲取複雜技能信息。";
      "對昏迷或睡夢中可讀取夢境(不真實但可能呈現內心深處渴望)內容";
    ];
  };
  {
    ability_id = "ABILITY_MEMORY_INFUSION";
    name_cn = "記憶灌輸"; name_en = "Memory Infusion";
    source = "領悟自【記憶汲取】應用 + 【主角光環】"; type_ = "主動激活";
    description = "將宿主腦中已獲取（通過【記憶汲取】或其他方式如自身領悟）的【記憶片段】或【技能感悟/經驗】，通過精神與內力的鏈接，強行或引導性地灌輸給第三方。此術耗心神，可能創造奇蹟扭轉現況。";
    mechanic_notes = [
      "需要【主動指令】觸發，指定【接收者】和要【灌輸的內容】(需是PC已獲取/理解的記憶或技能感悟)。";
      "【接觸需求】: 通常需要長時間的【物理接觸】（如雙掌抵住頭部/背心）。";
      "【接收者狀態】: 對【自願且精神集中(門徒、徒弟)】的接收者效果最好。對【無抵抗能力的昏迷者】也可嘗試，無抵抗能力機率非常高。但對【清醒的抗拒者】成功機率很低。";
      "【判定檢定】: 需進行【判定檢定】= (PC INT/悟性 + 內力操控精度 + d20) vs (接收者悟性/根骨 + 接收者狀態修正 + 灌輸內容複雜度)。";
      "【**成功效果**】:";
      "    - **記憶灌輸:** 接收者獲得相關【記憶片段】的直接體驗。";
      "    - **技能灌輸(低級/基礎):** 接收者相關技能【EXP大幅增加】，甚至可能直接提升【1-2個等級】(若接收者等級很低，且灌輸內容基礎)。";
      "    - **技能灌輸(高級/感悟):** 接收者獲得對該技能的【深刻理解】，大幅降低後續學習難度，甚至可能直接觸發【突破瓶頸】或【領悟新招式】(若接收者已有相當基礎)。";
      "    - **效果受限:** 接收者的【根骨】和【悟性】會限制其單次能吸收和理解的上限。";
      "【失敗後果】:";
      "    - **對接收者:** 低機率可能導致【精神錯亂】(SAN降低)、【記憶混淆】、【頭痛欲裂】、甚至【走火入魔】或【經脈受損】(若灌輸的是內功)，也有高機率可能只是單純精神疲勞。";
      "    - **對PC:** 【SAN值極大幅度降低】！【MP大量消耗】甚至反噬！可能因接收者意識抵抗而受到【精神衝擊】。";
      "【道德影響】: 對【自願接受者】灌輸正面記憶/技能，道德影響為【中性或微正】；對【非自願/不知情者】進行灌輸，或灌輸【邪惡/混亂】的記憶/技能，會【顯著降低】道德值。";
      "【其他影響】: 場景如有其他人見證洗腦過程，則依據性格與信任度，機率性改變對PC的看法(偏負面)。";
      "【洗腦影響】: 對【自願/非自願者】灌輸選擇性記憶可以大幅度改變好感/尊敬/信任度，也可以改變想法與個性(固執轉隨和之類)，可以強制對敵對陣營使用且沒有道德影響(收入糜下或成為我方特務)，但陣營居民可能會有其他想法(正向/反向)。";
    ];
    activation_condition = Some "玩家指令 + 滿足接觸/接收者狀態條件 + PC擁有可灌輸內容";
    cost = Some "**高 SAN 值消耗 (精神負擔大!)** + **高 MP 消耗 (傳輸能量大!)**";
    limitations = [
      "只能灌輸PC自身已理解或汲取到的內容，無法無中生有。";
      "接收者的天賦資質（根骨/悟性）是吸收效果的【硬性瓶頸】。";
      "灌輸【衝突的內功或技能】極易導致接收者走火入魔或瀕死！";
      "對同一人【反覆灌輸】效果可能遞減但也可能強化。";
      "依據相關技能熟練度強化改善並提高成功率。";
      "極度消耗PC自身，連續使用可能導致PC精神萎靡或內力枯竭。";
      "可以對敵對陣營NPC洗腦，可以改變對PC友好度等數值。";
    ];
  };
];;

---

## ❤️ 洞察人心 (Empathic Insight) 詳細機制 (V2.2)

let empathic_insight_ability : perception_ability_definition_t = {
  ability_id = "ABILITY_INSIGHT_HEARTS";
  name_cn = "洞察人心";
  level = 10; (* 已達最高級 *)
  max_level = 10;
  description = "對他人的內心狀態（情緒、意圖、誠實度）、實力層級、關係立場等進行深度感知和解讀的能力。";
  perception_categories = [
    ("情緒狀態 (Emotional State)", "感知目標當前的主要情緒及其強度 (關聯 emotion_psychology.ml)。例如：恐懼(高)、憤怒(中)、喜悅(微)。");
    ("情緒基調 (Emotional Tone)", "判斷情緒是正面、負面或中性/複雜。");
    ("誠實度/言行一致性 (Honesty/Consistency)", "判斷對方言語、表情、內心狀態是否一致，識別謊言、隱瞞或言不由衷。");
    ("基本意圖 (Basic Intent)", "判斷對方當前的核心意圖，如：敵意、友善、中立、警惕、試探、欺騙、求助等。");
    ("善惡傾向 (Alignment Tendency)", "基於對方流露的氣息、能量、言行，對其內在的善惡本質做出一個模糊的、直覺性的判斷 (參考 reputation_system_comprehensive.ml 的道德值區間概念)。");
    ("對PC好惡度 (Affinity towards PC)", "感知目標對PC的潛在好感 (Affinity) 或惡感/仇恨 (Enmity) 的大致範圍和強度 (關聯 relationship_record)。");
    ("實力評估 (Power Level Assessment)", "感知目標的大致實力層級（內力深厚程度、氣血強弱、是否身懷利器、與自身實力對比等）。");
    ("潛在關係/立場 (Potential Relationship/Stance)", "（需更高精度/特定情境）感知目標之間、或目標與第三方之間可能存在的隱藏關係或立場（如敵對、同盟、從屬）。");
  ];
  trigger_mode = "【被動為主，可主動聚焦】: 通常在與人互動（對話、觀察）時自動觸發基礎感知。玩家可通過【集中精神觀察】指令對特定目標進行更深入、更精確的【主動聚焦】探查，但會消耗更多SAN值。";
  accuracy_factors = {
    positive = [
      "高【洞察人心】技能等級 (當前已滿級)"; "高【悟性】/【智力】屬性"; "近距離接觸"; "目標情緒波動劇烈或不加掩飾";
      "與目標已有較深【關係基礎】(更易理解對方)"; "PC自身【心境平靜】(SAN值高)";
    ];
    negative = [
      "PC自身【SAN值低】/【疲勞】/【中毒】/【情緒激動】"; "距離過遠"; "有物理或能量【屏障】(如面具、特殊內功護體)";
      "目標【內功修為極高】或掌握【精神防禦/欺詐】類技巧"; "目標【城府極深】、【喜怒不形於色】(如秦嵐)";
      "環境【干擾因素】過多（如戰場、人群嘈雜）"; "信息【真假混雜】（對方故意誤導）";
    ];
  };
  output_format_tag = "【🧠 感知提示】";
  limitations = [
    "無法讀取【死物】、【沒有複雜心智的生物】（如普通野獸）的思維。（但【記憶汲取】可嘗試讀取動植物記憶）";
    "感知結果是基於線索的【解讀】，而非直接【讀心術】，可能被高明的偽裝或精神技巧【誤導】。",
    "若對方精神力極強或有惡意反噬，【主動聚焦】探查可能引發【精神衝擊】（SAN值降低或負面狀態）。",
    "頻繁或深度使用會持續消耗【SAN值】。",
    "對自身情緒狀態的判斷可能存在偏差。",
  ];
};;

---

## ⚙️ 通用規則與模組互動 (General Rules & Interactions)

let special_abilities_general_rules = {
  activation_priority = "被動常駐天賦默認生效。被動觸發能力由AI根據情境判斷觸發。主動激活能力需玩家下達指令。";
  conflict_resolution = "若多個天賦效果衝突（較少見），通常取效果更強或更符合當前情境者。";
  interaction_with_skills = "天賦可能直接強化某些技能的效果（如神力加強外功），或提升學習速度（如領悟潛力），或作為某些能力的基礎（如殘留記憶是記憶汲取基礎）。";
  interaction_with_attributes = "天賦可能提供屬性加成（如神力加STR），或效果受屬性影響（如現代知識回憶受INT影響），或與屬性共同決定效果（如記憶汲取/灌輸判定）。";
  interaction_with_status = "角色的生理/心理狀態可能影響天賦的觸發或效果精度（如疲勞/SAN低影響洞察/汲取/灌輸）。";
};;

---

## 🔗 依賴模組 (Dependencies - V2.2)

let special_abilities_depends_on = [
  "character_attributes.ml";      (* 提供PC屬性, SAN值, MP, STA 等 *)
  "skills_proficiency.ml";        (* 領悟潛力影響技能學習, 內力操控精度影響記憶汲取/灌輸 *)
  "emotion_psychology.ml";        (* 洞察人心的重要感知來源, 影響PC心境 *)
  "npc_stats_tracker.ml";         (* 洞察/記憶汲取/灌輸的目標數據來源 (狀態, 意志力?) *)
  "reputation_system_comprehensive.ml"; (* 洞察人心感知關係數值; 記憶汲取/灌輸影響道德值 *)
  (* "memory_fragments.ml"; *)         (* (此模組可能已整合到 PC_Data 中) 殘留記憶和記憶汲取的結果存儲 *)
  "world_settings.ml";            (* 環境因素影響感知精度 *)
  "quest_event_system.ml";        (* 特殊能力可能解鎖任務選項或由事件觸發 *)
  "ai_behavior_system.ml";        (* AI需要理解PC的特殊能力以做出合理反應 *)
  "disease_injury_system.ml";     (* 記憶汲取/灌輸失敗可能導致的負面狀態 *)
];;

---

## 📘 使用提示 (AI Guidance - V2.2)
(*
AI 在運行此模組 V2.2 時，應做到：
1.  【常駐/被動效果】: 持續體現領悟潛力、神力、內息自生的效果。
2.  【現代知識/殘留記憶】: 按規則觸發被動效果，允許玩家主動調用知識。
3.  【洞察人心應用】: 互動中自動提供基礎感知，響應玩家主動聚焦指令提供詳細信息並計算精度/消耗。
4.  【記憶汲取處理】: 嚴格檢查條件，執行判定，處理成功（獲取情報/稀有技能感悟）和失敗（SAN損失/精神衝擊）的後果，計算高SAN/中MP消耗及道德代價。
5.  【記憶灌輸處理】:
    * **嚴格檢查條件:** 確認PC擁有可灌輸內容、接觸、接收者狀態/意願。
    * **極高代價:** 無論成敗，必須扣除【極高的 SAN 和 MP】。
    * **執行判定:** 根據公式進行，考慮PC能力 vs 接收者資質/狀態/內容難度。
    * **處理成功效果(接受平衡破壞):** 給予接收者【顯著收益】(記憶、大量EXP、甚至等級提升/領悟)，但需註明資質上限。
    * **處理失敗後果:** 對PC和/或接收者施加【嚴重負面狀態】。
    * **記錄與反饋:** 清晰記錄事件、消耗、結果，強調風險與代價。
    * **道德判定:** 根據內容和意願調整道德值。
    * **長期影響追蹤:** 過度使用可能觸發未知負面事件。
6.  【限制與消耗】: 確保所有能力的限制條件被遵守，並準確計算消耗。
*)


(* === Content from: 📚 金庸世界技能總表.ini (Appended as Reference List) === *)
(* ==                 📚 金庸世界技能總表 (參考用)                == *)

(*
劍法：獨孤九劍
劍法：華山劍法
劍法：嶽家劍法
劍法：衡山劍法
劍法：青城劍法
劍法：玄鐵劍法
劍法：玉女劍法
劍法：太極劍
劍法：辟邪劍法
劍法：倚天劍法
劍法：神門十三劍
劍法：回風落雁劍
掌法：降龍十八掌
掌法：黯然銷魂掌
掌法：如來神掌
掌法：千手如來掌
掌法：鐵砂掌
掌法：天山六陽掌
掌法：八卦掌
掌法：般若掌
掌法：無相劍掌
掌法：火焰刀掌
拳法：羅漢拳
拳法：混元拳
拳法：虎爪拳
拳法：龍形拳
拳法：擒拿手
拳法：神門拳法
拳法：猴拳
刀法：血刀刀法
刀法：狂風快刀
刀法：胡家刀法
刀法：三無三不知刀
刀法：苗刀
刀法：五虎斷門刀
腿法：無影腳
腿法：游龍腿
腿法：飛燕腿
腿法：追魂腿
腿法：醉八仙腿
內功：九陽神功
內功：九陰真經
內功：北冥神功
內功：逍遙心法
內功：太極心法
內功：易筋經
內功：小無相功
內功：龍象般若功
內功：神照經
內功：先天功
內功：五毒神功
輕功：梯雲縱
輕功：凌波微步
輕功：飛燕凌波
輕功：天山遁影
輕功：飄然步
輕功：燕行術
暗器：唐門暗器術
暗器：孔雀翎
暗器：飛針
暗器：毒砂針
暗器：袖裡劍
暗器：彈指神通
劍陣／招式陣法：天罡北斗陣
劍陣／招式陣法：四象劍陣
劍陣／招式陣法：五行劍陣
劍陣／招式陣法：桃花島八陣圖
醫術／解毒：仁心妙手
醫術／解毒：神農百草經
醫術／解毒：五毒解毒術
醫術／解毒：華佗遺術
毒術／蠱術：五毒心經
毒術／蠱術：星宿毒掌
毒術／蠱術：冰蠶毒
毒術／蠱術：苗疆蠱術
毒術／蠱術：萬毒穿心掌
心法／意志類：金剛不壞體
心法／意志類：鐵布衫
心法／意志類：不滅心訣
心法／意志類：無我無相
心法／意志類：空性神功
音波／精神類：逍遙音功
音波／精神類：天籟梵音
音波／精神類：海潮音
音波／精神類：魔音攝心
武學總綱類：武穆遺書
武學總綱類：太玄經
武學總綱類：易筋經
武學總綱類：九陽手札
武學總綱類：兵書百篇
劍法：玄冥劍法
劍法：苗家劍法
劍法：一劍西來
劍法：白虹貫日劍
劍法：冰魄銀針劍法
劍法：昆侖劍法
劍法：兩儀劍法
劍法：萬花劍法
劍法：玉蕭劍法
掌法：混元掌
掌法：陰陽八盤掌
掌法：火焰掌
掌法：五雷掌
掌法：斷筋掌
刀法：大崑崙刀法
刀法：青龍刀法
刀法：白虹刀法
刀法：判官刀
刀法：八卦刀法
拳法：七傷拳
拳法：玄陰神掌
拳法：陰風拂穴手
拳法：金蛇纏絲手
腿法：六合腿
腿法：龍形腿
腿法：破石腿
暗器：金針渡劫
暗器：碎玉針
暗器：五毒梅花釘
暗器：冰魄銀針
音波：七絃無音琴
音波：八音合奏
精神：攝魂大法
精神：魔音幻境
陣法：八門金鎖陣
陣法：伏魔大陣
陣法：九宮迷魂陣
輕功：鬼魅身法
輕功：流星步
輕功：玄冥遁影
心法：無量心法
心法：金蛇心經
心法：冰心訣
心法：反兩儀心法
內功：龜息大法
內功：神足經
內功：寒冰真氣
內功：乾坤大挪移（第七層）
武技：千斤墜
武技：金剛掌破氣式
武技：無影毒霧
武技：分筋錯骨手
劍法：三疊劍
劍法：白虹劍氣
劍法：黃山九劍
劍法：梅花落
劍法：破玉式
掌法：神門十六掌
掌法：混天掌
掌法：天雷破空掌
掌法：金焰掌
掌法：一陽指（掌變）
刀法：龍戰八方
刀法：寒光刀
刀法：青鋒連斬
刀法：落日刀
刀法：破甲重斬
拳法：五虎斷魂拳
拳法：金剛伏魔拳
拳法：落雁拳
拳法：白虹拳
拳法：穿心拳
腿法：風雷腿
腿法：血影腿
腿法：碎金腿
腿法：回風腿
腿法：夜行腿
暗器：化骨針
暗器：火蝴蝶
暗器：靈蛇銀絲
暗器：金蠶蠱
暗器：萬箭穿心鐵珠
陣法：六合伏龍陣
陣法：天門天罡陣
陣法：雁行迷蹤陣
輕功：神行百變
輕功：天馬行空步
輕功：太虛凌空步
輕功：化影無痕
心法：紫霞神功
心法：天魔大法
心法：無念心法
心法：天罡氣訣
內功：血河神功
內功：火焰神功
內功：冰焰內氣
內功：太一真氣
音波：赤音琴殺
精神：幻靈迷魂術
精神：神識震擊
音波：淨心伏魔曲
武技：斷筋手
武技：霸王卸甲式
武技：絕命五指破
武技：螳螂勁摔
武技：鎖喉破敵手
劍法：七星逐月劍
劍法：玉女穿心劍
劍法：鴛鴦連環劍
劍法：問情十三劍
劍法：破空劍意
掌法：如影隨形掌
掌法：狂雷破天掌
掌法：八荒破軍掌
掌法：流雲追月掌
掌法：寒霜碎玉掌
拳法：火焰神拳
拳法：魔火焚天拳
拳法：穿雲裂石拳
拳法：混元滾雷拳
拳法：七殺伏虎拳
刀法：黑風刀
刀法：萬雷滅世斬
刀法：裂山斷岳刀
刀法：烈焰狂刀
刀法：狂沙飆斬
腿法：雷龍掃尾
腿法：震地裂石腿
腿法：電閃連環腿
腿法：旋風奔雷腿
腿法：逐影飛燕腿
內功：百脈歸一功
內功：天罡戰氣
內功：虛無真氣
心法：靈犀心法
心法：鎮魂心訣
輕功：九轉迷踪步
輕功：踏雪無痕
輕功：影刃身法
輕功：龍翔之步
輕功：星閃追風
暗器：寒星隕鐵
暗器：飛焰流蠍
暗器：九曲銀蛇
暗器：赤炎彈指珠
暗器：毒霧彈
精神：萬象虛空訣
精神：神念震魂
音波：浮世殘音
音波：醉夢梵音
音波：裂魂戰曲
陣法：雷霆破陣
陣法：玄武封天陣
陣法：幻影流沙陣
陣法：星羅密網陣
陣法：天罡五行陣
武技：獅子搖頭功
武技：碎岩開山手
武技：雷震破法掌
武技：鷹爪奪魂
武技：橫掃千軍腿
*)

(* ============================================================ *)
(* ==     合併模組 Part 4: 技能與能力 (Skills & Abilities) 結束 == *)
(* ============================================================ *)