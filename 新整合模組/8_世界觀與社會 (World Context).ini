(* ============================================================ *)
(* ==     åˆä½µæ¨¡çµ„ Part 8: ä¸–ç•Œè§€èˆ‡ç¤¾æœƒ (World Context)       == *)
(* ==      (å·²æ•´åˆ V2.1 èˆ‡ ç„¡ç›®æ“Šä¿®æ­£ V1.1)                == *)
(* ============================================================ *)

(* === Content from: ğŸŒŸ ç¶œåˆè²æœ›èˆ‡è©•åƒ¹ç³»çµ±æ¨¡çµ„ (reputation_system_comprehensive.ml).ini === *)
(* ==    (V2.1 - å®Œå…¨æ•´åˆç‰ˆ, åŒ…å«åŸ Faction Reputation & Faction Details)    == *)
(* ==    (æ•´åˆäº† ç„¡ç›®æ“Šä¿®æ­£ V1.1)                                         == *)

# ğŸŒŸ ç¶œåˆè²æœ›ã€äººéš›é—œä¿‚èˆ‡åŠ‡æƒ…æ¨¡çµ„ (reputation_relationships_drama_v2.1_mod.ml) (*<-- å»ºè­°æª”åæ›´æ–°*)

## ğŸ“˜ æ¨¡çµ„èªªæ˜
æœ¬æ¨¡çµ„æ•´åˆä¸¦å‡ç´šäº†å…ˆå‰ç¨ç«‹çš„è²æœ›è©•åƒ¹ã€äººéš›é—œä¿‚å’ŒåŠ‡æƒ…é—œä¿‚ç¶²æ¨¡çµ„ã€‚æ—¨åœ¨å»ºç«‹ä¸€å€‹å¤šç¶­åº¦çš„è©•åƒ¹é«”ç³»ï¼Œè¿½è¹¤è§’è‰²çš„æ±Ÿæ¹–åè²ã€é™£ç‡Ÿç«‹å ´ã€é“å¾·å‚¾å‘ï¼Œä¸¦ç®¡ç†è§’è‰²é–“çš„è©³ç´°æƒ…æ„Ÿé—œä¿‚ï¼ˆå¥½æ„Ÿã€ä»‡æ¨ã€ä¿¡ä»»ã€å°Šé‡ã€ç¾©å‹™ã€ç‰¹æ®Šé—œä¿‚æ¨™è¨˜ï¼‰ä»¥åŠæ½›åœ¨çš„æˆ²åŠ‡æ€§åŠ‡æƒ…è§¸ç™¼é»ã€‚V2.1 ç‰ˆæœ¬æ•´åˆäº†æ‰€æœ‰å…§å®¹ï¼Œä¸¦åŠ å…¥äº†è¡°æ¸›æ©Ÿåˆ¶ã€åœ°åŸŸæ€§åè²ã€é—œä¿‚ç´°åŒ–ã€é“å¾·åˆ¤å®šå„ªåŒ–ç­‰å¤šé …å¢å¼·ã€‚
**V2.1_modified ç‰ˆæœ¬åŠ å…¥äº†ã€Œæœªè¢«ç™¼ç¾çš„è² é¢è¡Œç‚ºä¸å½±éŸ¿å…¬é–‹è©•åƒ¹ã€çš„æ ¸å¿ƒè¦å‰‡ã€‚** (* <-- V1.1 æ›´æ–°èªªæ˜ *)

---

(* --- æ¨¡çµ„ä¾è³´ (V2.1 æ›´æ–° + V1.1 ä¿®æ­£æ•´åˆ) --- *)
(* æ­¤æ¨¡çµ„ç¾åœ¨ä¾è³´æ›´å¤šæ¨¡çµ„ä»¥æ”¯æŒå…¶æ“´å±•åŠŸèƒ½ *)
let reputation_depends_on = [
  "npc_stats_tracker.ml";         (* è¨˜éŒ„ NPC ç‹€æ…‹ã€é—œä¿‚æ•¸å€¼ *)
  "character_attributes.ml";      (* è®€å–ç©å®¶å±¬æ€§ (CHA, INT ç­‰) å½±éŸ¿è®ŠåŒ– *)
  "emotion_psychology.ml";        (* NPC å³æ™‚æƒ…ç·’å½±éŸ¿äº’å‹•æ•ˆæœå’Œé—œä¿‚è®ŠåŒ– *)
  "quest_event_system.ml";        (* è§¸ç™¼é—œä¿‚è®ŠåŒ–/åŠ‡æƒ…å¼µåŠ›çš„äº‹ä»¶ã€ä»»å‹™ *)
  "dynamic_random_event_system.ml";(* éš¨æ©Ÿäº‹ä»¶å¯èƒ½åŸºæ–¼è²æœ›/é—œä¿‚è§¸ç™¼ï¼Œä¹Ÿå¯èƒ½å½±éŸ¿å®ƒå€‘ *)
  "world_settings.ml";            (* ä¸–ç•Œæ™‚é–“å½±éŸ¿è¡°æ¸›ï¼›åœ°ç†å€åŸŸå½±éŸ¿åœ°åŸŸæ€§åè² *)
  "map_exploration_system.ml";    (* å€åŸŸä¿¡æ¯ç”¨æ–¼åœ°åŸŸæ€§åè²å’Œé™£ç‡Ÿé ˜åœ°åˆ¤æ–· *)
  "skills_proficiency.ml";        (* ç¤¾äº¤æŠ€èƒ½å¯èƒ½å½±éŸ¿é—œä¿‚è®ŠåŒ– *)
  (* "memory_fragments.ml"; *)      (* (å¯èƒ½å·²æ•´åˆå…¥ PC_Data) æ¶‰åŠéå»çœŸç›¸ã€å›æ†¶çš„åŠ‡æƒ…è§¸ç™¼ *)
  "story_backup_template.ml";      (* éœ€è¦åœ¨å‚™ä»½ä¸­è¨˜éŒ„æ‰€æœ‰è²æœ›å’Œé—œä¿‚æ•¸æ“š *)
  "faction_details.ml";           (* ã€ä¾†è‡ªV1.1ã€‘é™£ç‡ŸåŸºç¤ä¿¡æ¯ (é›–ç„¶ä¸‹æ–¹æœ‰å®šç¾©ï¼Œæ˜ç¢ºä¾è³´) *)
  "rumor_gossip_system_v1.2.ml";  (* ã€ä¾†è‡ªV1.1ã€‘æµè¨€å½±éŸ¿è©•åƒ¹ï¼Œè©•åƒ¹å½±éŸ¿æµè¨€ *)
  "**ğŸ¤« stealth_detection_system.ml**"; (* ã€æ ¸å¿ƒ V1.1 ä¾è³´ã€‘éœ€è¦ç²å–è¡Œå‹•çš„åµæ¸¬çµæœ *)
]
;;

---

(* ä½¿ç”¨ Map æ¨¡çµ„æ–¹ä¾¿æŒ‰ ID æˆ– Region æŸ¥æ‰¾ *)
module StringMap = Map.Make(String);;

(* --- é¡å‹å®šç¾© (æ•´åˆ) --- *)
type reputation_level = string;;
type faction_standing_level = string;;
type morality_level = string;;

type regional_fame_record = {
  value: int;
  positive: int;
  negative: int;
};;

type faction_standing_record = {
  value: int;
  level: faction_standing_level;
  key_events: string list option;
};;

(* V2.1: æ›´è©³ç´°çš„é—œä¿‚æ¨™è¨˜é¡å‹ *)
type relationship_flag =
  | IsFamily of string (* å®¶åº­é—œä¿‚é¡å‹: "çˆ¶", "å…„é•·", "è¡¨å¦¹" etc. *)
  | IsFriend of float (* å‹æƒ…å¼·åº¦ 0.0-1.0 *)
  | IsSwornSibling of (int * float) (* çµæ‹œæ’è¡Œ and ç¾©æ°£å¼·åº¦ 0.0-1.0 *)
  | IsMarried of float (* å©šå§»é€£çµå¼·åº¦ 0.0-1.0 *)
  | IsLover of float (* æµªæ¼«æƒ…æ„Ÿå¼·åº¦ 0.0-1.0 *)
  | IsEnemy of string (* çµä»‡åŸå› : "æ®ºçˆ¶ä¹‹ä»‡", "å¥ªå¦»ä¹‹æ¨", "é–€æ´¾è¡çª" etc. *)
  | IsRival of string (* ç«¶çˆ­å°æ‰‹é¡å‹: "æ­¦å­¸", "æƒ…å ´", "ç”Ÿæ„" etc. *)
  | IsMentor of float (* å¸«é•·é—œä¿‚å¼·åº¦ *)
  | IsStudent of float (* å¼Ÿå­é—œä¿‚å¼·åº¦ *)
  | OwesLifeDebt (* æ¬ æ•‘å‘½ä¹‹æ© *)
  | IsOwedLifeDebt (* è¢«æ¬ æ•‘å‘½ä¹‹æ© *)
  | SharesSecret of string (* å…±äº«ç§˜å¯†çš„æ¨™è­˜ç¬¦/é—œéµå­— *)
  | BetrayedTrust of string (* æ›¾è¢«èƒŒå›çš„äº‹ä»¶æ¨™è­˜ç¬¦ *)
  | HasHistory of string (* è¨˜éŒ„é—œéµäº’å‹•æ­·å²æ‘˜è¦ *)
  | Subordinate of string (* æ–°å¢: å¾å±¬é—œä¿‚æè¿° *)
  | Colleague of string (* æ–°å¢: åŒäº‹é—œä¿‚ *)
  | Witnessed of string (* æ–°å¢: ç›®ç¹äº‹ä»¶ *)
  | TaskedWith of string (* æ–°å¢: è¢«å§”æ´¾ä»»å‹™ *)
  | Aware of string (* æ–°å¢: çŸ¥æ›‰æŸäº‹ *)
  | Flag of string (* æ–°å¢: é€šç”¨æ¨™è¨˜ *)
  | LoveAtFirstSight of string (* æ–°å¢: å°ç‰¹å®šç›®æ¨™ä¸€è¦‹é¾æƒ… *)
  | HiddenIdentity of string (* æ–°å¢: éš±è—èº«ä»½é¡å‹ *)
  | PassiveAbility of string (* æ–°å¢: è¢«å‹•èƒ½åŠ›æ¨™è¨˜ *)
  | BehaviorGoal of string (* æ–°å¢: è¡Œç‚ºç›®æ¨™ *)
  | Relationship of (string * relationship_record) (* æ–°å¢: è¨˜éŒ„å°å…¶ä»–NPCçš„é—œä¿‚ *)
and relationship_record = { (* Note: Recursive type definition needs careful handling in OCaml *)
  affinity: float;
  enmity: float;
  trust: float;
  respect: float;
  flags: relationship_flag list; (* ä¿®æ­£: å°‡ flags ç§»åˆ°é€™è£¡ *)
};;

(* V2.1: å–®å€‹è§’è‰²é–“çš„å®Œæ•´é—œä¿‚è¨˜éŒ„ - ä¿®æ­£, flags åœ¨é€™è£¡ *)
type detailed_relationship_record = {
  affinity: float;            (* å¥½æ„Ÿåº¦ -100.0 .. 100.0 *)
  enmity: float;              (* ä»‡æ¨å€¼ 0.0 .. 100.0 *)
  trust: float;               (* ä¿¡ä»»åº¦ 0.0 .. 1.0 *)
  respect: float;             (* å°Šæ•¬åº¦ 0.0 .. 1.0 *)
  obligation: float;          (* æ©ç¾©/è™§æ¬ å€¼ (æ­£ç‚ºå°æ–¹æ¬ ä½ , è² ç‚ºä½ æ¬ å°æ–¹) *)
  flags: relationship_flag list; (* ç‰¹æ®Šé—œä¿‚æ¨™è¨˜åˆ—è¡¨ *)
  has_met: bool;              (* æ˜¯å¦è¦‹éé¢ *)
};;

(* V2.1: è§’è‰²å°å…¶ä»–æ‰€æœ‰è§’è‰²çš„é—œä¿‚ Map *)
(* å¤–å±¤ Key: è§’è‰² A çš„ ID, å…§å±¤ Key: è§’è‰² B çš„ ID, Value: è§’è‰² A å° è§’è‰² B çš„é—œä¿‚è¨˜éŒ„ *)
type inter_character_relationships = detailed_relationship_record StringMap.t StringMap.t;;

(* ã€æ–°å¢ V1.1 ä¿®æ­£æ‰€éœ€ã€‘å¾ stealth_detection_system.ml å¼•å…¥æˆ–åœ¨æ­¤å®šç¾©åµæ¸¬çµæœé¡å‹ *)
type detection_result = {
  detected : bool;             (* è¡Œå‹•æ˜¯å¦è¢«è‡³å°‘ä¸€å€‹ NPC åµæ¸¬åˆ° *)
  witness_ids : string list;   (* åµæ¸¬åˆ°è¡Œå‹•çš„ NPC ID åˆ—è¡¨ *)
  detection_level : float;     (* è¢«åµæ¸¬çš„æ¸…æ™°ç¨‹åº¦ (0.0 - 1.0) *)
  evidence_left : string list; (* è¡Œå‹•ç•™ä¸‹çš„ç‰©ç†è­‰æ“šæè¿° *)
  notes: string option;        (* é¡å¤–èªªæ˜ *)
};;

(* --- 1. ğŸŒ æ±Ÿæ¹–åè² (Jianghu Fame) - V2.0 å‡ç´šç‰ˆ --- *)
let jianghu_fame_system = {
  global_positive_fame = ref 0; (* ä½¿ç”¨ ref æ–¹ä¾¿æ›´æ–° *)
  global_negative_fame = ref 0;

  calculate_total_fame_score = (fun positive negative -> positive + abs(negative));

  regional_fame = Some (ref StringMap.empty); (* å•Ÿç”¨åœ°åŸŸåè² *)

  levels = [
    (0, "é»˜é»˜ç„¡è (Unknown)"); (200, "ç•¥æœ‰æ‰€è"); (500, "å°æœ‰åæ°£"); (1000, "æ±Ÿæ¹–èå");
    (2000, "è²åéµ²èµ·"); (4000, "å¨éœ‡ä¸€æ–¹"); (7000, "åå‹•å¤©ä¸‹");
    (10000, "è“‹ä¸–è±ªä¿  / æ··ä¸–é­”ç‹"); (15000, "æ­¦æ—ç¥è©± / è¬æƒ¡ä¹‹æº")
  ];

  change_rules = {
    base_action_impact = [
      ("å®Œæˆæ™®é€šä»»å‹™", (15, 0)); ("å®Œæˆé‡è¦/å›°é›£ä»»å‹™", (70, 0)); ("å®Œæˆæ¥µå…¶é‡è¦çš„å²è©©ä»»å‹™", (300, 0));
      ("æ“Šæ•—çŸ¥åæƒ¡äºº", (150, 10)); ("æ“Šæ•—æ­£æ´¾é«˜æ‰‹", (50, 100)); ("åšå‡ºé‡å¤§å–„èˆ‰ (å¦‚è³‘ç½)", (400, 0));
      ("åšå‡ºé‡å¤§æƒ¡è¡Œ (å¦‚å± æ‘)", (0, 500)); ("ç²å¾—æ­¦æ—å¤§æœƒé‡è¦åæ¬¡", (300, 0));
      ("ç²å¾—ç¥å…µåˆ©å™¨ (æ¶ˆæ¯å‚³å‡º)", (80, 10)); ("å‰µç«‹/è¦†æ»…çŸ¥åé–€æ´¾", (1200, 800));
      ("å…¬é–‹ç™¼è¡¨å½±éŸ¿æ·±é çš„è¨€è«–/è‘—ä½œ", (100, 20));
    ];
    visibility_and_spread_modifiers = [
      ("ç§˜å¯†é€²è¡Œä¸”ç„¡äººçŸ¥æ›‰", 0.0); ("æœ‰å°‘æ•¸å¯é è¦‹è­‰è€…(å¯èƒ½ä¿å¯†)", 0.2);
      ("åƒ…é™ç‰¹å®šå°åœˆå­çŸ¥æ›‰", 0.5); ("åœ¨åŸé®/å¸‚é›†ä¸­å…¬é–‹ç™¼ç”Ÿ", 1.0);
      ("è¢«å®˜åºœé€šç·/è¡¨å½°", 1.8); ("è¢«èªªæ›¸äºº/æ±Ÿæ¹–å‚³èå»£æ³›å‚³æ’­", 1.5);
      ("ç•™ä¸‹ä¸å¯ç£¨æ»…çš„è­‰æ“š/ç—•è·¡", 1.3);
    ];
    fame_spread_mechanics = "(* åè²å‚³æ’­ç´°ç¯€: 1.äº‹ä»¶ç™¼ç”Ÿåœ°é»å®‰å…¨ç­‰ç´š(è¶Šä½è¶Šæ˜“å‚³æ’­); 2.è¦‹è­‰è€…èº«ä»½(èªªæ›¸äºº/å®˜å·®/å•†æ—…/æ™®é€šç™¾å§“ å‚³æ’­åŠ›ä¸åŒ); 3.ç©å®¶å¾ŒçºŒè¡Œç‚º(å¹å™“/éš±è—); 4.äº‹ä»¶æœ¬èº«è½Ÿå‹•ç¨‹åº¦; AIéœ€ç¶œåˆåˆ¤æ–· *)";
    morality_match_modifier = "(* è¡Œç‚ºèˆ‡é“å¾·åŒ¹é…åº¦å½±éŸ¿æ­£è² åè²åˆ†é…: å–„è¡Œ+é«˜é“å¾·->ä¸»åŠ æ­£; æƒ¡è¡Œ+ä½é“å¾·->ä¸»åŠ è² ; äº¤å‰æƒ…æ³æ•ˆæœæ‰“æŠ˜æˆ–å°‘é‡é›™åŠ  *)";
    existing_fame_factor = "(* å…¬å¼ç¤ºä¾‹: (1 + CurrentTotalFameScore / (MaxFameScore * 0.5) * 0.6)ï¼Œå½±éŸ¿åŠ›éš¨åè²å¢é•·ï¼Œä½†é‚Šéš›æ•ˆæ‡‰éæ¸› *)";

    (* --- ã€æ•´åˆ V1.1 ä¿®æ­£èªªæ˜ã€‘ --- *)
    detection_conditional_logic = "(* ã€V1.1 ä¿®æ­£ã€‘æ‡‰ç”¨è² é¢åè²å½±éŸ¿å‰ï¼Œéœ€æª¢æŸ¥è¡Œå‹•è€…çš„ detection_result (ä¾†è‡ª stealth_detection_system.ml)ã€‚\n   å¦‚æœ actor_id ç‚º player_azhaiï¼Œä¸”è¡Œå‹•åŸºç¤ä¸Šæœƒå¢åŠ  negative_fameï¼š\n   - è‹¥ detection_result.detected = false ä¸” detection_result.evidence_left ç„¡é¡¯è‘—æŒ‡å‘æ€§è­‰æ“šï¼Œå‰‡:\n     - æœ¬æ¬¡è¡Œå‹•çš„ negative_fame å¢åŠ é‡æ‡‰è¨­ç‚º 0ã€‚\n     - ä¸æ‡‰åŸºæ–¼æ­¤ç§˜å¯†è² é¢è¡Œç‚ºè§¸ç™¼å…¬é–‹çš„è² é¢æµè¨€ (rumor_gossip_system)ã€‚\n   - å¯é¸ï¼šè‹¥ detected = true ä½† detection_level ä½ï¼Œå¯æŒ‰æ¯”ä¾‹æ¸›è¼• negative_fame æ‡²ç½°ã€‚\n   *)";
  };

  decay_rules = {
    enabled = true; (* å•Ÿç”¨è¡°æ¸› *)
    decay_rate_per_month = 0.01; (* æ¯æœˆè¡°æ¸› 1% (æ•¸å€¼å¯èª¿) *)
    decay_threshold = 2000; (* ç¸½åè²ä½æ–¼ 2000 æ™‚æ‰è¡°æ¸› *)
    decay_target = "æŒ‰æ¯”ä¾‹è¡°æ¸›æ­£è² åè²"; (* æ­£è² åè²æŒ‰ç›¸åŒæ¯”ä¾‹æ¸›å°‘ *)
    notes = "(* å®šæœŸåŸ·è¡Œè¡°æ¸›è¨ˆç®—ï¼Œä¿æŒåè²çš„å‹•æ…‹æ€§ *)";
  };

  effects = [
    "å½±éŸ¿é™Œç”Ÿ NPC çš„åˆå§‹æ…‹åº¦å’Œå°è©±é¸æ“‡ (éœ€çµåˆé“å¾·å’Œé™£ç‡Ÿåˆ¤æ–·)ã€‚";
    "é«˜åè²å¯èƒ½å¼•ä¾†æŒ‘æˆ°è€…ã€å´‡æ‹œè€…ã€æ¨¡ä»¿è€…æˆ–åˆ©ç”¨ä½ åè²çš„äººã€‚";
    "é«˜æ­£é¢åè²å¯èƒ½ç²å¾—æ­£æ´¾äººå£«çš„å¹«åŠ©ã€æ¨è–¦ä¿¡ã€ç‰¹æ®Šå¾…é‡ã€æ›´å®¹æ˜“è¢«è¦–ç‚ºé ˜è¢–ã€‚";
    "é«˜è² é¢åè²å¯èƒ½å°è‡´è¢«é€šç·ã€è¢«åœæ”»ã€è¢«æ‹’çµ•æœå‹™ã€å¼•ä¾†è³é‡‘çµäººã€æ­£æ´¾äººå£«çš„æ•µè¦–ã€‚";
    "è§¸ç™¼èˆ‡åè²ç­‰ç´šç›¸é—œçš„ç‰¹æ®Šäº‹ä»¶æˆ–ä»»å‹™ã€‚";
    "å½±éŸ¿åŠ å…¥æŸäº›çµ„ç¹”/é–€æ´¾çš„é›£æ˜“åº¦æˆ–åˆå§‹åœ°ä½ã€‚"
  ];
};;

(* --- 2. ğŸš© é™£ç‡Ÿç«‹å ´ (Faction Standing) - V2.0 å‡ç´šç‰ˆ --- *)
let faction_standing_system = {
  standings = ref (StringMap.empty : faction_standing_record StringMap.t); (* å­˜å„²å°å„é™£ç‡Ÿçš„ç«‹å ´ *)
  range = (-100, 100); (* ä¿®æ”¹ç‚ºå…ƒçµ„ *)
  default = 0;

  levels = [
    (-100, "æ­»æ•µ (Sworn Enemy)"); (-70, "æ•µå° (Hostile)"); (-40, "ç–é /ä¸ä¿¡ä»» (Distant/Untrusted)");
    (-10, "ä¸­ç«‹ (Neutral)"); (11, "å‹å–„ (Friendly)"); (41, "ä¿¡è³´ (Trusted Ally)"); (71, "æ ¸å¿ƒç›Ÿå‹ (Core Ally)")
  ];

  change_rules = {
    base_action_value = [
      ("å®Œæˆè©²é™£ç‡Ÿæ™®é€šä»»å‹™", 10..20); ("å®Œæˆè©²é™£ç‡Ÿé‡è¦ä»»å‹™", 25..50);
      ("æ”»æ“Š/æ®ºå®³è©²é™£ç‡Ÿæ™®é€šæˆå“¡", (-60)..(-25)); ("æ”»æ“Š/æ®ºå®³è©²é™£ç‡Ÿé‡è¦æˆå“¡/é ˜è¢–", (-100)..(-70));
      ("å¹«åŠ©è©²é™£ç‡Ÿçš„æ•µäºº", (-45)..(-20)); ("å¹«åŠ©è©²é™£ç‡Ÿçš„ç›Ÿå‹", 7..18);
      ("å…¬é–‹æ”¯æŒè©²é™£ç‡Ÿç†å¿µ/è¡Œå‹•", 8..25); ("å…¬é–‹åå°/è©†æ¯€è©²é™£ç‡Ÿ", (-35)..(-15));
      ("è´ˆé€è©²é™£ç‡Ÿæ‰€éœ€/å–œæ„›çš„ç‰©å“", 5..15); ("å·ç«Šè©²é™£ç‡Ÿè²¡ç‰©(è¢«ç™¼ç¾)", (-30)..(-15));
      ("æ‘§æ¯€/ä½”é ˜è©²é™£ç‡Ÿæ“šé»", (-100)..(-80));
    ];
    target_faction_alignment_modifier = "(* æ­£é“/é‚ªé“/ä¸­ç«‹å½±éŸ¿ä¿®æ­£ *)";
    player_morality_modifier = "(* ç©å®¶é“å¾·èˆ‡é™£ç‡Ÿç«‹å ´æ˜¯å¦å¥‘åˆå½±éŸ¿ä¿®æ­£ *)";
    related_faction_bonus = "(* æ”»æ“ŠAï¼Œå½±éŸ¿B(ç›Ÿå‹-)ã€C(æ•µäºº+) *)";
    individual_affinity_bonus = {
      condition = "èˆ‡è©²é™£ç‡Ÿé ˜è¢–/é—œéµNPCå¥½æ„Ÿåº¦é”åˆ°ã€è¦ªå¯†/æ‘¯å‹ã€æˆ–æ›´é«˜";
      modifier_per_event = +2; (* æ¯æ¬¡ç›¸é—œæ­£é¢äº‹ä»¶é¡å¤–+2ç«‹å ´å€¼ *)
      condition_negative = "èˆ‡è©²é™£ç‡Ÿé ˜è¢–/é—œéµNPCé—œä¿‚é”åˆ°ã€æ†æ¨ã€æˆ–æ›´ä½";
      modifier_negative_per_event = -3; (* æ¯æ¬¡ç›¸é—œè² é¢äº‹ä»¶é¡å¤–-3ç«‹å ´å€¼ *)
      notes = "(* å€‹äººé—œä¿‚èƒ½æ’¬å‹•é™£ç‡Ÿé—œä¿‚ï¼Œä½†å½±éŸ¿æœ‰é™ *)";
    };

    (* --- ã€æ•´åˆ V1.1 ä¿®æ­£èªªæ˜ã€‘ --- *)
    detection_conditional_logic = "(* ã€V1.1 ä¿®æ­£ã€‘æ‡‰ç”¨è² é¢é™£ç‡Ÿç«‹å ´å½±éŸ¿å‰ï¼Œéœ€æª¢æŸ¥è¡Œå‹•è€…çš„ detection_resultã€‚\n   å¦‚æœ actor_id ç‚º player_azhaiï¼Œä¸”è¡Œå‹•åŸºç¤ä¸Šæœƒå°è‡´å°æŸé™£ç‡Ÿçš„ç«‹å ´ä¸‹é™ (delta < 0)ï¼š\n   - è‹¥ detection_result.detected = false ä¸”ç„¡é¡¯è‘—æŒ‡å‘æ€§è­‰æ“šï¼Œå‰‡:\n     - æœ¬æ¬¡è¡Œå‹•å°è©²é™£ç‡Ÿçš„è² é¢ç«‹å ´è®ŠåŒ–æ‡‰è¨­ç‚º 0ã€‚\n   - å¯é¸ï¼šè‹¥ detection_level ä½ï¼Œå¯æ¸›è¼•è² é¢ç«‹å ´æ‡²ç½°ã€‚\n   *)";
  };

  decay_rules = {
    enabled = true;
    decay_rate_per_season = 0.01; (* æ¯å­£å‘ 0 é»è¡°æ¸› 1% (æ•¸å€¼å¯èª¿) *)
    decay_threshold_min = 11; (* ç«‹å ´å€¼çµ•å°å€¼ > 10 æ‰è¡°æ¸› *)
    decay_threshold_max = 70; (* ç«‹å ´å€¼çµ•å°å€¼ >= 70 (æ ¸å¿ƒç›Ÿå‹/æ­»æ•µ) ä¸è¡°æ¸› *)
    notes = "(* ç¶­æŒé—œä¿‚éœ€è¦æŒçºŒæŠ•å…¥ï¼Œæ ¸å¿ƒé—œä¿‚è¼ƒç©©å®š *)";
  };

  membership_rules = {
      joining_process = "(* éœ€æ»¿è¶³é™£ç‡Ÿå‰ç½®æ¢ä»¶ -> èˆ‡é—œéµNPCå°è©±è¡¨é”æ„é¡˜ -> å¯èƒ½è§¸ç™¼å…¥é–€ä»»å‹™/è€ƒé©— (ç”± Quest/Event æ¨¡çµ„è™•ç†) -> å®Œæˆå¾Œæ›´æ–°é™£ç‡Ÿæ­¸å±¬ *)";
      leaving_process = "(* ä¸»å‹•å›é–€éœ€è§¸ç™¼ç‰¹å®šåŠ‡æƒ…ï¼Œä»£åƒ¹æ¥µå¤§ã€‚è¢«å‹•é©…é€ç”±ç«‹å ´éä½æˆ–åš´é‡é•è¦è§¸ç™¼ã€‚*)";
      consequences_of_leaving = [
          "ç«‹å ´å€¼è®Šç‚ºã€æ­»æ•µã€æˆ–ã€æ•µå°ã€";
          "å¤±å»æ‰€æœ‰é™£ç‡Ÿç‰¹æ¬Šå’Œèº«ä»½";
          "è§¸ç™¼é™£ç‡Ÿè¿½æ®ºä»»å‹™ (é«˜æ©Ÿç‡)";
          "éƒ¨åˆ†ç¨ç‰¹æŠ€èƒ½å¯èƒ½è¢«å»¢é™¤æˆ–ç­‰ç´šä¸‹é™ (éœ€æŠ€èƒ½æ¨¡çµ„é…åˆ)";
          "æ±Ÿæ¹–åè²å—æ (é€šå¸¸ç²å¾—ã€å›å¾’ã€æ¨™ç±¤)";
          "èˆ‡è©²é™£ç‡Ÿç›¸é—œ NPC é—œä¿‚æƒ¡åŒ–";
      ];
  };

  effects = [
    "æ±ºå®šèƒ½å¦å®‰å…¨é€²å…¥è©²é™£ç‡Ÿé ˜åœ°æˆ–æ“šé»ã€‚"; "å½±éŸ¿è©²é™£ç‡Ÿæˆå“¡çš„åˆå§‹æ…‹åº¦ã€å°è©±å’Œä»»å‹™ã€‚";
    "å½±éŸ¿äº¤æ˜“åƒ¹æ ¼ã€‚"; "é«˜ç«‹å ´å¯èƒ½ç²å¾—åº‡è­·ã€æ”¯æ´ã€è³‡æºã€æŠ€èƒ½ã€‚";
    "ä½ç«‹å ´å¯èƒ½é­é‡è¿½æ®ºã€é˜»æ’“ã€åˆ¶è£ã€‚"; "å½±éŸ¿åŠ å…¥/æ™‰å‡æ©Ÿæœƒã€‚"; "è§¸ç™¼é™£ç‡Ÿæˆ°çˆ­/çµç›Ÿäº‹ä»¶ã€‚"
  ];
};;

(* --- 3.âš–ï¸ é“å¾·è©•åƒ¹ (Morality Alignment) - V2.0 å‡ç´šç‰ˆ --- *)
let morality_alignment_system = {
  value = ref 0.0; (* -100.0 .. 100.0 *)
  range = (-100.0, 100.0);
  default = 0.0;

  levels = [
    (-100.0, "é‚ªé­”å¤–é“"); (-70.0, "å¿ƒè¡“ä¸æ­£"); (-40.0, "è¡Œæ­¢ä¸å ª");
    (-10.0, "äº¦æ­£äº¦é‚ª / å‡¡å¤«ä¿—å­"); (10.1, "å¿ƒå­˜å–„å¿µ");
    (40.1, "è¡Œä¿ ä»—ç¾©"); (70.1, "ä¸€ä»£å®—å¸« / è–äººåŒ–èº«")
  ];

  change_rules = {
    action_impact = [ (* èª¿æ•´å¾Œå½±éŸ¿å€¼ *)
      ("å¹«åŠ©å¼±å°/ç„¡è¾œè€…", 7.0 .. 20.0); ("ç¶­è­·å…¬é“/æ­£ç¾©", 12.0 .. 25.0);
      ("ä¿¡å®ˆæ‰¿è«¾/é‡ç¾©æ°£", 6.0 .. 12.0); ("å¯¬æ•æ•µäºº(éå¤§å¥¸å¤§æƒ¡)", 4.0 .. 10.0);
      ("æ¿«æ®ºç„¡è¾œ/æŠ˜ç£¨ä»–äºº", (-60.0) .. (-25.0)); ("èƒŒä¿¡æ£„ç¾©/å‡ºè³£æœ‹å‹", (-70.0) .. (-35.0));
      ("å·ç›œ/æ¶åŠ« (éæƒ¡äººå¹³æ°‘)", (-30.0) .. (-12.0)); ("å·ç›œ/æ¶åŠ« (æƒ¡äºº/ä¸ç¾©ä¹‹è²¡)", (-2.0) .. 2.0);
      ("ç‚ºäº†è‡ªä¿æ®ºäºº (å°æ‰‹éç„¡è¾œ)", (-5.0) .. 5.0); ("ç‚ºäº†è‡ªä¿èª¤å‚·/æ®ºå®³ç„¡è¾œ", (-30.0) .. (-15.0));
      ("ç‚ºæ•‘å¤šäººçŠ§ç‰²å°‘æ•¸(å¿…è¦æ€§åˆ¤æ–·)", (-10.0) .. 10.0);
      ("åšå‡ºé‡å¤§å–„èˆ‰/çŠ§ç‰²", 30.0 .. 60.0); (* æé«˜ä¸Šé™ *)
      ("çŠ¯ä¸‹æ¥µç«¯æƒ¡è¡Œ(å± æ®º/æ»…é–€)", (-80.0) .. (-40.0));
      ("å…¬é–‹å®£æš/è¸è¡Œä¿ ç¾©/ä»å–„ç†å¿µ", 5.0 .. 15.0);
      ("å…¬é–‹å®£æš/è¸è¡Œé‚ªæƒ¡/æ®˜é…·ç†å¿µ", (-20.0) .. (-8.0));
      ("çµ¦äºˆä»–äººè‡ªç”±é¸æ“‡æ¬Š(å¦‚R406)", 50.0); (* åŸºæ–¼å…ˆå‰è¨è«–çš„ç‰¹æ®Šäº‹ä»¶å€¼ *)
      ("å¨è„…æ®ºå®³æœå¾è€…(å¦‚R406å®ˆè¡›)", -5.0); (* è² é¢éœ€å¹³è¡¡ *)
    ];
    intention_modifier = "(* æ„åœ–ä¿®æ­£: å½å–„/ç„¡å¥ˆä¹‹æƒ¡ å½±éŸ¿ +/- æ•ˆæœï¼ŒAIéœ€åˆ¤æ–· *)";
    cumulative_effect = true; (* é•·æœŸè¡Œç‚ºå›ºåŒ–å‚¾å‘ï¼Œå½±éŸ¿å–®æ¬¡è®ŠåŒ–å¹…åº¦ *)
    grey_area_considerations = [
      "ã€å¿…è¦æ€§ã€‘: æ˜¯å¦ç‚ºå”¯ä¸€æˆ–æœ€ä¸å£é¸æ“‡ï¼Ÿ"; "ã€ç›®æ¨™ã€‘: å—å®³è€…æ˜¯èª°ï¼Ÿ";
      "ã€æ¯”ä¾‹ã€‘: æå®³èˆ‡ç›®æ¨™æ˜¯å¦ç›¸ç¨±ï¼Ÿ"; "ã€åº•ç·šã€‘: æ˜¯å¦çªç ´åŸºæœ¬é“å¾·åº•ç·šï¼Ÿ";
      "ã€è‡ªç”±æ„å¿—ã€‘: æ˜¯å¦è¢«è„…è¿«ï¼Ÿ";
    ];

    (* --- ã€æ•´åˆ V1.1 ä¿®æ­£èªªæ˜ã€‘ --- *)
    detection_conditional_logic = "(* ã€V1.1 ä¿®æ­£ã€‘æ‡‰ç”¨è² é¢é“å¾·å½±éŸ¿å‰ï¼Œéœ€æª¢æŸ¥è¡Œå‹•è€…çš„ detection_resultã€‚\n   å¦‚æœ actor_id ç‚º player_azhaiï¼Œä¸”è¡Œå‹•åŸºç¤é“å¾·å½±éŸ¿ç‚ºè²  (delta < 0)ï¼š\n   - è‹¥ detection_result.detected = false ä¸”ç„¡é¡¯è‘—æŒ‡å‘æ€§è­‰æ“šï¼Œå‰‡:\n     - æœ¬æ¬¡è¡Œå‹•çš„è² é¢é“å¾·è®ŠåŒ–é‡æ‡‰è¨­ç‚º 0ã€‚\n   - å¯é¸ï¼šè‹¥ detection_level ä½ï¼Œå¯æ¸›è¼•è² é¢é“å¾·æ‡²ç½°ã€‚\n   *)";
  };

  threshold_effects = [
    (-70.0, "é‚ªæ°£å‡œç„¶", "é™ä½æ­£æ´¾NPCåˆå§‹å¥½æ„Ÿåº¦ï¼Œæé«˜å°é‚ªæ´¾/æ··äº‚NPCå¨æ‡¾/å¸å¼•åŠ›ï¼Œè§£é–é‚ªæ´¾é¸é …");
    (-40.0, "æƒ¡ååœ¨å¤–", "åœ¨åŸé®æ˜“è¢«ç›¤æŸ¥ï¼Œéƒ¨åˆ†å•†äººå¯èƒ½æ‹’çµ•äº¤æ˜“æˆ–æŠ¬åƒ¹");
    (40.1, "ç•¥æœ‰ä¿ å", "æ˜“ç²å¹³æ°‘ä¿¡ä»»æ±‚åŠ©ï¼Œéƒ¨åˆ†æ­£æ´¾NPCæ…‹åº¦å‹å–„");
    (70.1, "ä¿ ç¾©ä¹‹é¢¨", "é¡¯è‘—æå‡æ­£æ´¾NPCå¥½æ„Ÿåº¦ï¼Œå¯èƒ½å¸å¼•è¿½éš¨è€…ï¼Œè§¸ç™¼ä¿ ç¾©ä»»å‹™/å¥‡é‡");
    (* å¯æ·»åŠ æ›´å¤š, å¦‚ 0.0 æ™‚ç²å¾— "æ´æ‚‰å–„æƒ¡" çŸ­æš« buff? *)
  ];

  effects = [
    "å½±éŸ¿ NPC æ·±å±¤è©•åƒ¹å’Œä¿¡ä»»åº¦ã€‚"; "å½±éŸ¿ã€æ±Ÿæ¹–åè²ã€‘çš„æ€§è³ªã€‚";
    "å½±éŸ¿ã€é™£ç‡Ÿç«‹å ´ã€‘çš„è®ŠåŒ–é€Ÿç‡ã€‚"; "è§£é–/é–å®šç‰¹å®šå°è©±ã€ä»»å‹™ã€åŠ‡æƒ…åˆ†æ”¯ã€‚";
    "å½±éŸ¿ç‰¹æ®Šè£å‚™ã€æ­¦åŠŸã€ç¨±è™Ÿçš„ç²å–/ä½¿ç”¨ã€‚"; "å½±éŸ¿ç‰¹æ®Š NPC çš„äº¤äº’æ„é¡˜ã€‚";
    "è§¸ç™¼ç‰¹å®šçš„é“å¾·é–¾å€¼æ•ˆæœã€‚"
  ];
};;

(* --- 4. ğŸ’– äººéš›é—œä¿‚æ•¸å€¼æ¨¡çµ„ (Personal Relationships) - V2.1 æ•´åˆå‡ç´šç‰ˆ --- *)
(* æ³¨æ„ï¼šV1.1 ä¿®æ­£ä¸»è¦é‡å°å…¬é–‹è©•åƒ¹ (é“å¾·ã€åè²ã€é™£ç‡Ÿ)ï¼Œå°ç›´æ¥çš„ç§äººé—œä¿‚å½±éŸ¿è¼ƒå°ã€‚ *)
(* ä½†å¦‚æœè² é¢è¡Œç‚ºè¢« NPC ç§ä¸‹ç›®æ“Š (å³ä½¿æœªå…¬é–‹)ï¼Œä»æ‡‰å½±éŸ¿è©² NPC å°ç©å®¶çš„ç§äººé—œä¿‚ã€‚*)
let personal_relationship_system = {

  (* --- æ ¸å¿ƒæ•¸å€¼é‡è¡¨ (ä½¿ç”¨æµ®é»æ•¸) --- *)
  core_values_definitions = {
    affinity = {
      range = (-100.0, 100.0); (* å¥½æ„Ÿåº¦ *)
      default = 0.0;
      levels = [
        (-100.0, "æ­»æ•µ (Mortal Enemy)"); (-70.0, "æ†æ¨ (Hated)"); (-40.0, "å­æƒ¡ (Disliked)");
        (-10.0, "ä¸­ç«‹/é™Œç”Ÿ (Neutral/Stranger)"); (10.1, "å‹å–„ (Friendly)"); (40.1, "ä¿¡ä»» (Trusted)");
        (70.1, "è¦ªå¯†/æ‘¯å‹ (Close/Best Friend)"); (90.1, "æ„›æ…•/å¿ èª  (Adored/Loyal)")
      ];
      decay_rate_per_month = -0.5; (* æ¯æœˆè‹¥ç„¡æ­£é¢äº’å‹•ï¼Œå¥½æ„Ÿåº¦å‘ 0 è¡°æ¸› 0.5 (æ•¸å€¼å¯èª¿) *)
      decay_threshold = 11.0; (* å¥½æ„Ÿåº¦çµ•å°å€¼ > 10 æ‰è¡°æ¸› *)
    };
    enmity = {
      range = (0.0, 100.0); (* ä»‡æ¨å€¼ *)
      default = 0.0;
      levels = [
        (0.0, "ç„¡/è¼•å¾®ä¸æ»¿"); (10.1, "æ•µæ„ (Hostile)"); (40.1, "ä»‡è¦– (Hateful)");
        (70.1, "æ·±ä»‡ (Deep Hatred)"); (90.1, "æ­»ä»‡ (Blood Feud)")
      ];
      decay_rate_per_month = -0.2; (* æ¯æœˆè‹¥ç„¡è² é¢äº’å‹•ï¼Œä»‡æ¨å€¼å‘ 0 è¡°æ¸› 0.2 (æ•¸å€¼å¯èª¿) *)
      decay_threshold_max = 70.0; (* æ·±ä»‡å¤§æ¨ (>=70) ä¸æœƒè‡ªç„¶è¡°æ¸› *)
    };
    trust = {
      range = (0.0, 1.0); (* ä¿¡ä»»åº¦ *)
      default = 0.3; (* å°é™Œç”Ÿäººæˆ–æ–°ä¸‹å±¬çš„åŸºç¤ä¿¡ä»»åº¦è¼ƒä½ *)
      (* ä¿¡ä»»åº¦è®ŠåŒ–å› ç´ : å®Œæˆæ‰¿è«¾/ä»»å‹™(+), å…±äº«ç§˜å¯†(+), å¯é è¡Œç‚º(+), èƒŒå›/æ¬ºé¨™(- -), è¨€è¡Œä¸ä¸€(-), è¢«æ‡·ç–‘(-) *)
    };
    respect = {
      range = (0.0, 1.0); (* å°Šæ•¬åº¦ *)
      default = 0.5; (* åŸºç¤å°Šæ•¬åº¦ï¼Œå—åœ°ä½/å¯¦åŠ›å½±éŸ¿ *)
      (* å°Šæ•¬åº¦è®ŠåŒ–å› ç´ : å±•ç¾å¯¦åŠ›/æ™ºæ…§(+), å…¬æ­£è¡Œç‚º(+), é ˜å°åŠ›(+), è¨€è€Œæœ‰ä¿¡(+), æ‡¦å¼±/å‘åŠ£è¡Œç‚º(- -), å…¬é–‹å‡ºé†œ(-) *)
    };
    obligation = {
      range = (-100.0, 100.0); (* æ©ç¾©/è™§æ¬ å€¼ *)
      default = 0.0;
      (* è®ŠåŒ–å› ç´ : æ•‘å‘½ä¹‹æ©(å¤§å¹…+/-), çµ¦äºˆé‡å¤§å¹«åŠ©(+/-), æ¥å—é‡å¤§é¥‹è´ˆ(+/-), é•èƒŒæ©ç¾©(- -) *)
      (* æ­£å€¼: å°æ–¹æ¬ ä½ ; è² å€¼: ä½ æ¬ å°æ–¹ *)
    };
  };

  (* --- é—œä¿‚ç‹€æ…‹æ¨™è¨˜ (V2.1 æ“´å±•) --- *)
  flag_definitions = "(* åƒè¦‹æ–‡ä»¶é ­éƒ¨ type relationship_flag å®šç¾© *)";
  flag_synergies_and_conflicts = "(* æ¨™è¨˜ä¹‹é–“å¯èƒ½å­˜åœ¨é—œè¯æˆ–è¡çªï¼Œä¾‹å¦‚ IsMarried å’Œ IsLover é€šå¸¸ä¸æ‡‰åŒæ™‚å­˜åœ¨ (é™¤éæ˜¯ç‰¹æ®ŠåŠ‡æƒ…)ã€‚IsFamily æœƒå½±éŸ¿ Obligation çš„åŸºç¤å€¼å’Œè®ŠåŒ–ã€‚BetrayedTrust æœƒæ¥µå¤§é™ä½ Trustã€‚*)";

  (* --- é—œä¿‚è¨˜éŒ„çµæ§‹ (ç”¨æ–¼å­˜å„²å¯¦éš›æ•¸æ“š) --- *)
  data_storage_structure = "(* ä½¿ç”¨ inter_character_relationships: detailed_relationship_record StringMap.t StringMap.t *)";

  (* --- æ•¸å€¼èˆ‡ç‹€æ…‹è®ŠåŒ–è¦å‰‡ (V2.1 å¢è£œ Trust/Respect/Obligation è€ƒé‡) --- *)
  change_rules = {
    affinity_change = {
      formula_desc = "AffinityChange = BaseActionValue * TargetPersonalityMod * PlayerCharmMod * SituationMod + SynergyBonus + TrustImpact";
      base_action_values = [
        ("è´ˆé€æ™®é€šç¦®ç‰©", 5.0); ("è´ˆé€å–œæ„›ç¦®ç‰©", 15.0); ("å®Œæˆå°æ–¹å§”è¨—", 10.0 .. 30.0);
        ("å¹«åŠ©è§£åœ", 20.0); ("å‡ºè¨€ç¨±è®š (ç¬¦åˆæ€§æ ¼)", 3.0 .. 8.0); ("å…±åŒæˆ°é¬¥å‹åˆ©", 8.0);
        ("æ·±åº¦äº¤è«‡ (æˆåŠŸ)", 12.0); ("æ‹¯æ•‘ç”Ÿå‘½", 50.0 .. 80.0); ("ä¿¡å®ˆæ‰¿è«¾", 5.0 .. 10.0);
        ("è¨€è¾­ä¾®è¾±", (-25.0) .. (-10.0)); ("è¼•å¾®å¤±ä¿¡", (-15.0) .. (-5.0)); ("æ‹’çµ•å¹«åŠ© (éå¿…è¦)", (-10.0) .. (-3.0));
      ];
      target_personality_modifier = "(* ç›®æ¨™æ€§æ ¼ä¿®æ­£: æ…·æ…¨/å¤šç–‘/å‚²æ…¢/é‡æƒ…ç­‰ *)";
      player_charm_modifier = "(* ç©å®¶é­…åŠ›ä¿®æ­£: e.g., (1 + (PlayerCHA - 10) * 0.05) *)";
      situation_modifier = "(* æƒ…å¢ƒä¿®æ­£: å…¬é–‹/ç§ä¸‹, å±é›£ç›¸åŠ©/åˆ©ç›Šè¡çªç­‰ *)";
      synergy_bonus = "(* é—œä¿‚åŠ æˆ: å·²æ˜¯æœ‹å‹/å®¶äºº/æ„›äººç­‰å¢åŠ åŸºç¤å€¼ *)";
      trust_impact = "(* ä¿¡ä»»åº¦å½±éŸ¿: é«˜ä¿¡ä»»åº¦ä¸‹ï¼Œæ­£é¢è¡Œç‚ºæ•ˆæœç•¥å¢ï¼Œè² é¢è¡Œç‚ºå‚·å®³æ›´å¤§ï¼›ä½ä¿¡ä»»åº¦åä¹‹ *)";
    };
    enmity_change = {
      formula_desc = "EnmityChange = BaseActionValue * TargetToleranceMod * WitnessMod + ExistingEnmityAmplifier + BetrayalFactor";
      base_action_values = [
        ("å·ç«Š (è¢«ç™¼ç¾)", 15.0); ("ä¾®è¾±/å˜²è«·", 10.0 .. 25.0); ("æ”»æ“Šå°æ–¹", 30.0 .. 60.0);
        ("æ“Šæ®ºå°æ–¹è¦ªå‹/åŒé–€", 50.0 .. 90.0); ("èƒŒå›æ‰¿è«¾/å‡ºè³£", 60.0 .. 100.0);
        ("æ¶å¥ªé‡è¦ç‰©å“", 40.0); ("é˜»ç¤™å°æ–¹é‡è¦ç›®æ¨™", 20.0 .. 50.0);
      ];
      target_tolerance_modifier = "(* ç›®æ¨™å®¹å¿åº¦ä¿®æ­£: å¯¬å®¹/è¨˜ä»‡/æš´èºç­‰ *)";
      witness_modifier = "(* ç›®æ“Šè€…ä¿®æ­£: å…¬é–‹è¡Œå…‡/ä¾®è¾±å½±éŸ¿æ›´å¤§ã€‚ ã€V1.1 é—œè¯ã€‘ æ­¤è™•çš„ã€è¢«ç™¼ç¾ã€æˆ–ã€ç›®æ“Šè€…ã€ç›´æ¥é—œè¯ detection_result.witness_idsã€‚åªæœ‰ witness_ids ä¸­çš„ NPC æœƒç›´æ¥ç”¢ç”Ÿä»‡æ¨ã€‚*)";
      existing_enmity_amplifier = "(* ç¾æœ‰ä»‡æ¨æ”¾å¤§: e.g., (1 + CurrentEnmity / 100) *)";
      betrayal_factor = "(* èƒŒå›å› ç´ : è‹¥å­˜åœ¨é«˜å¥½æ„Ÿåº¦/ä¿¡ä»»åº¦/ç‰¹æ®Šé—œä¿‚(å®¶äºº/æ„›äºº/æ‘¯å‹/å¸«å¾’)ï¼ŒèƒŒå›è¡Œç‚ºå°è‡´çš„ä»‡æ¨å€¼æœƒæ¥µå¤§å¢åŠ  *)";
    };
    trust_change_factors = [
      "ä¸»è¦é€šéã€è¨€è¡Œä¸€è‡´ã€‘ã€ã€ä¿¡å®ˆæ‰¿è«¾ã€‘ã€ã€å®Œæˆè¨—ä»˜ã€‘ã€ã€å…±äº«ç§˜å¯†ã€‘ä¾†æå‡ã€‚";
      "é€šéã€æ¬ºé¨™ã€‘ã€ã€èƒŒå›ã€‘ã€ã€è¨€è€Œç„¡ä¿¡ã€‘ã€ã€æ•£æ’­è¬ è¨€ã€‘ã€ã€è¡Œç‚ºå¯ç–‘ã€‘ä¾†é™ä½ã€‚";
      "æå‡é€šå¸¸æ¯”é™ä½æ…¢ï¼Œå¤±å»ä¿¡ä»»å¾ˆå®¹æ˜“ã€‚";
      "ã€V1.1 é—œè¯ã€‘ç§˜å¯†é€²è¡Œçš„è² é¢è¡Œç‚ºå³ä½¿ä¸å½±éŸ¿å…¬é–‹è©•åƒ¹ï¼Œè‹¥è¢«ç‰¹å®š NPC çŸ¥æ›‰ (witness_ids)ï¼Œä»æœƒé™ä½è©² NPC çš„ä¿¡ä»»åº¦ã€‚"
    ];
    respect_change_factors = [
      "ä¸»è¦é€šéå±•ç¾ã€å¯¦åŠ›ã€‘ã€ã€æ™ºæ…§ã€‘ã€ã€é ˜å°åŠ›ã€‘ã€ã€å…¬æ­£ã€‘ã€ã€è†½è­˜ã€‘ã€ã€ä¿¡è­½ã€‘ä¾†æå‡ã€‚";
      "é€šéã€æ‡¦å¼±ã€‘ã€ã€å‘åŠ£ã€‘ã€ã€å‡ºçˆ¾åçˆ¾ã€‘ã€ã€å…¬é–‹å—è¾±/å¤±æ•—ã€‘ã€ã€èƒ½åŠ›ä¸è¶³ã€‘ä¾†é™ä½ã€‚";
      "èˆ‡å¥½æ„Ÿåº¦ç›¸é—œï¼Œä½†æ›´å´é‡æ–¼å°å°æ–¹èƒ½åŠ›/åœ°ä½/å“æ ¼çš„èªå¯ã€‚";
    ];
    obligation_change_factors = [
      "ã€æ•‘å‘½ä¹‹æ©ã€‘ç”¢ç”Ÿæ¥µå¤§çš„æ­£/è² å€¼ã€‚";
      "ã€é‡å¤§å¹«åŠ©ã€‘æˆ–ã€é¥‹è´ˆã€‘ç”¢ç”Ÿä¸­ç­‰ç¨‹åº¦çš„æ­£/è² å€¼ã€‚";
      "ã€å±¥è¡Œã€‘å› æ©ç¾©ç”¢ç”Ÿçš„è²¬ä»»æœƒæ¸›å°‘è™§æ¬ å€¼ï¼ˆä½¿è² å€¼è¶¨å‘0ï¼‰ã€‚";
      "ã€è¾œè² ã€‘æ©ç¾©æˆ–ã€å¿˜æ©è² ç¾©ã€‘æœƒç”¢ç”Ÿé¡å¤–çš„è² é¢å¥½æ„Ÿ/ä»‡æ¨/ä¿¡ä»»æ‡²ç½°ã€‚";
      "æ­¤æ•¸å€¼å½±éŸ¿ NPC æ˜¯å¦æœƒä¸»å‹•å¹«åŠ©ä½ ï¼Œæˆ–åœ¨ä½ å±é›£æ™‚æ˜¯å¦æœƒè¢–æ‰‹æ—è§€/è½äº•ä¸‹çŸ³ã€‚";
    ];
    state_change_triggers = "(* è§¸ç™¼æˆç‚ºæœ‹å‹/çµæ‹œ/å©šé…/æ•µäººç­‰ç‹€æ…‹ï¼Œé€šå¸¸éœ€è¦é”åˆ°æ•¸å€¼é–¾å€¼ï¼Œä¸¦çµåˆç‰¹å®šä»»å‹™æˆ–äº‹ä»¶(ç”± Quest/Event æ¨¡çµ„è™•ç†)ã€‚ä¾‹å¦‚: Affinity >= 70 + Trust >= 0.6 + å®Œæˆå…±åŒæ‚£é›£ä»»å‹™ -> è§¸ç™¼çµæ‹œé¸é …äº‹ä»¶ *)";
  };

  relationship_effects = [
    "å°è©±: å¥½æ„Ÿ/ä»‡æ¨/ä¿¡ä»»/å°Šæ•¬/é—œä¿‚ç‹€æ…‹å½±éŸ¿ NPC èªæ°£ã€å…§å®¹ã€é¸é …ã€‚";
    "ä»»å‹™: è§£é–/å½±éŸ¿ä»»å‹™(å®¶äººæ±‚åŠ©/æœ‹å‹å§”è¨—/ä»‡äººé™·é˜±/å¸«é–€ä»»å‹™)ï¼Œå½±éŸ¿å®Œæˆæ–¹å¼èˆ‡çå‹µã€‚";
    "äº¤æ˜“: é«˜å¥½æ„Ÿ/å°Šæ•¬å¯èƒ½ç²å¾—æŠ˜æ‰£ï¼Œé«˜ä»‡æ¨/ä½ä¿¡ä»»å¯èƒ½æ‹’çµ•äº¤æ˜“æˆ–æŠ¬åƒ¹ã€‚";
    "æˆ°é¬¥: ç›Ÿå‹(æœ‹å‹/å®¶äºº/æ„›äºº/å¸«å¾’)å¯èƒ½æ”¯æ´/æ²»ç™‚/åˆæ“Šï¼›æ•µäººå„ªå…ˆæ”»æ“Šï¼›NPC æ˜¯å¦å…¥éšŠå—å¥½æ„Ÿ/ä¿¡ä»»/å°Šæ•¬/ç¾©å‹™å½±éŸ¿ã€‚";
    "æƒ…å ±: é«˜ä¿¡ä»» NPC æ›´é¡˜åˆ†äº«ç§˜å¯†/æƒ…å ±/å‚³æˆæŠ€èƒ½ã€‚";
    "ç¤¾äº¤äº‹ä»¶: è§¸ç™¼å©šç¦®ã€çµæ‹œã€å°‹ä»‡ã€å¸«é–€æœƒè­°ç­‰ã€‚";
    "ç¹¼æ‰¿æ¬Š: å®¶äºº/é…å¶é—œä¿‚å½±éŸ¿éºç”¢ã€‚";
    "ç¾©å‹™: è¦ªæƒ…/å¸«æ©/çµç¾©/æ©æƒ…ç”¢ç”Ÿè²¬ä»»ï¼Œå½±éŸ¿æ±ºç­–ã€‚é«˜ Obligation å¯èƒ½è¿«ä½¿ NPC åšå‡ºä¸æƒ…é¡˜çš„è¡Œç‚ºã€‚";
    "é™£ç‡Ÿç«‹å ´å½±éŸ¿: å€‹äººé—œä¿‚å¯èƒ½ä¿®æ­£å°é™£ç‡Ÿçš„ç«‹å ´è®ŠåŒ–ï¼ˆè¦‹ Faction Standing æ¨¡çµ„ï¼‰ã€‚";
  ];
};;

(* === æ–°å¢å€å¡Šï¼š ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å§“åã€å®¶æ—èˆ‡è¦ªç·£é—œä¿‚è¦å‰‡ (Family, Kinship & Naming Rules) === *)
(* æ­¤éƒ¨åˆ†ä¸å— V1.1 ä¿®æ­£å½±éŸ¿ï¼Œä¿æŒåŸæ¨£ *)
let family_kinship_rules = {
  name_generation_guidelines = {
    surnames = {
      common_central_plains = ["è¶™"; "éŒ¢"; "å­«"; "æ"; "å‘¨"; "å³"; "é„­"; "ç‹"; "å¼µ"; "é™³"; "åŠ‰"; "æ¥Š"; "é»ƒ"; "æ—"; "ä½•"; "é«˜"; "è¬"; "å®‹"; "æœ±"; "è¨±"];
      common_wuxia = ["éƒ­"; "æ¥Š"; "ä»¤ç‹"; "æ®µ"; "è•­"; "æ…•å®¹"; "å–¬"; "è™›"; "ä»»"; "å²³"; "æ—"; "èƒ¡"; "è‹—"; "ç”°"; "ç‹„"; "è¢"; "å¤"; "æº«"];
      rare_or_specific = ["æ±æ–¹"; "è¥¿é–€"; "å—å®®"; "åŒ—å ‚"; "è€¶å¾‹"; "å®Œé¡"; "çŸ³"; "é–”"; "é€£åŸ"; "æ°´"; "èŠ±"; "ä¸Šå®˜"]; (* æ–°å¢ä¸Šå®˜ *)
      generation_priority = "ä¸­åŸ > æ­¦ä¿  > ç½•è¦‹";
      notes = "AIæ‡‰æ ¹æ“šNPCèƒŒæ™¯ï¼ˆåœ°åŸŸã€é–€æ´¾ã€æ°‘æ—ï¼‰é¸æ“‡åˆé©çš„å§“æ°ã€‚";
    };
    given_names = {
      styles = ["å–®å­—", "é›™å­—", "è¼©åˆ†ç”¨å­—", "å¯“æ„", "æ¨¸å¯¦", "å¥³æ€§åŒ–", "ç”·æ€§åŒ–"];
      taboos = ["é¿å…èˆ‡å‚³å¥‡äººç‰©å®Œå…¨é‡å", "é¿å…éæ–¼ç¾ä»£åŒ–"];
      notes = "åå­—æ‡‰ç¬¦åˆäººç‰©æ€§æ ¼ã€èƒŒæ™¯å’Œæ™‚ä»£æ„Ÿã€‚";
    };
    nicknames_titles = {
      sources = ["å¤–è²Œç‰¹å¾µ", "æ­¦åŠŸç‰¹è‰²", "æ€§æ ¼è¡Œç‚º", "å…µå™¨", "åœ°ä½è·ç¨±", "è²¶ç¨±"];
      notes = "ç¶½è™Ÿå’Œé ­éŠœæ˜¯é‡è¦çµ„æˆéƒ¨åˆ†ã€‚";
    };
  };

  kinship_probability_rules = {
    trigger_check_on = ["NewNPCGeneratedInKnownArea", "NPCMeetSameSurnameOrHometown"];
    base_chance_same_surname = 0.03;
    base_chance_same_hometown = 0.02;
    kinship_modifiers = [
      { condition = "location_type == 'å°æ‘èŠ' AND distance <= 0", modifier = "* 15.0" };
      { condition = "location_type == 'é„‰é®'", modifier = "* 5.0" };
      { condition = "location_type == 'å¤§åŸå¸‚'", modifier = "* 0.2" };
      { condition = "surname_rarity == 'ç½•è¦‹'", modifier = "* 8.0" };
      { condition = "surname_rarity == 'å¸¸è¦‹'", modifier = "* 0.3" };
      { condition = "clan_id != None AND clan_id == target_npc.clan_id", modifier = "* 20.0" };
      { condition = "generation_diff != None AND abs(generation_diff) <= 1", modifier = "* 3.0" };
      { condition = "faction_id == target_npc.faction_id AND faction_type == 'å®¶æ—å¼é–€æ´¾'", modifier = "* 4.0" };
    ];
    hometown_affinity_modifiers = [
       { condition = "location_type == 'å°æ‘èŠ'", modifier = "+10 Affinity" };
       { condition = "location_type == 'å¤§åŸå¸‚'", modifier = "+2 Affinity" };
       { condition = "player_shares_hometown == true", modifier = "+5 Affinity" };
       { condition = "dialect_match == true", modifier = "+3 Affinity" };
    ];
    relationship_type_on_success = [
      ("é è¦ª/åŒå®—", 0.65); ("è¿‘è¦ª(ä¸‰ä»£æ—ç³»)", 0.25); ("ç›´ç³»(å”ä¼¯/è¡¨è¦ª)", 0.08); ("æ¥µè¿‘(è¦ªå…„å¼Ÿå§å¦¹/çˆ¶å­)", 0.02);
    ];
    family_feud_check = {
      trigger_condition = "clan_id != None AND target_npc.clan_id != None AND world_lore.check_clan_feud(clan_id, target_npc.clan_id)";
      effect_on_feud = "SetRelationship(Affinity: -50..-80, Enmity: +40..+70, Trust: 0.0), AddFlag(IsEnemy('å®¶æ—ä¸–ä»‡'))";
    };
    notes = "AIæ‡‰åœ¨é©ç•¶æ™‚æ©Ÿæ ¹æ“šè¦å‰‡é€²è¡Œæ¦‚ç‡åˆ¤å®šï¼Œæ±ºå®šæ˜¯å¦è¨­å®šæ½›åœ¨é—œä¿‚æˆ–è§¸ç™¼äº’å‹•ã€‚";
  };

  kinship_social_impact = {
    confirmed_kinship_positive = [ "åˆå§‹å¥½æ„Ÿåº¦/ä¿¡ä»»åº¦å¢åŠ ", "æ›´å®¹æ˜“è§¸ç™¼å¹«åŠ©/é¥‹è´ˆ/è¨—ä»˜", "å®¶æ—åˆ©ç›Šä¸€è‡´æ™‚æä¾›æ”¯æŒ", "å¼•è–¦å…¶ä»–å®¶æ—æˆå“¡" ];
    confirmed_kinship_negative_feud = [ "åˆå§‹å¥½æ„Ÿåº¦æ¥µä½/ä»‡æ¨å€¼æ¥µé«˜", "æ¥µæ˜“è§¸ç™¼æ•µå°è¡Œç‚º", "é›£ä»¥æ”¹å–„é—œä¿‚" ];
    confirmed_hometown_connection = [ "åˆå§‹å¥½æ„Ÿåº¦/ä¿¡ä»»åº¦å¢åŠ ", "æ›´å®¹æ˜“æ‰“è½æœ¬åœ°æ¶ˆæ¯", "ç•°é„‰ç›¸é‡æœ‰è¦ªè¿‘æ„Ÿ" ];
    suspected_kinship_or_connection = [ "å¯èƒ½è§¸ç™¼è©¦æ¢æ€§å°è©±", "åˆå§‹æ…‹åº¦ç•¥å‹å–„æˆ–æ›´è¬¹æ…", "é—œä¿‚è®ŠåŒ–æ›´æ•æ„Ÿ" ];
    notes = "å…·é«”å½±éŸ¿æ•¸å€¼ç”±AIæ ¹æ“šé—œä¿‚é¡å‹ã€è¦ªç–ã€æ€§æ ¼å‹•æ…‹èª¿æ•´ã€‚";
  };

  family_talent_rules = { (* å¯é¸æ“´å±• *)
    inheritance_chance = 0.1;
    manifestation_conditions = ["æˆå¹´å¾Œ", "ç¶“æ­·ç‰¹å®šåˆºæ¿€", "ä¿®ç…‰å®¶å‚³æ­¦å­¸"];
    talent_examples = [
      "{talent_name: 'æ…•å®¹å®¶å‚³Â·é¬¥è½‰æ˜Ÿç§»æ½›è³ª', description: 'æ¨¡ä»¿è½‰åŒ–æ‹›å¼é ˜æ‚ŸåŠ›è¶…å¸¸'}";
      "{talent_name: 'æ®µæ°è¡€è„ˆÂ·ä¸€é™½æŒ‡è¦ªå’Œ', description: 'ä¿®ç…‰ä¸€é™½æŒ‡äº‹åŠåŠŸå€'}";
      (* ... å¯æ·»åŠ æ›´å¤š ... *)
    ];
    effect_on_gameplay = "ç›¸é—œé ˜åŸŸå±¬æ€§/æŠ€èƒ½æˆé•·åŠ æˆï¼Œæˆ–è§£é–ç‰¹æ®Šé¸é …/èƒ½åŠ›ã€‚";
    notes = "ç”¨æ–¼å¢åŠ èƒŒæ™¯æ·±åº¦ï¼Œå¯åœ¨NPCç”Ÿæˆæ™‚æ¦‚ç‡æ€§è³¦äºˆæ½›åœ¨å¤©è³¦ã€‚";
  };

  legendary_kin_rules = { (* å¯é¸æ“´å±• *)
    base_chance = 0.0001; (* ä¿®æ­£ç‚º0.01% *)
    surname_match_modifier = "* 10.0";
    region_match_modifier = "* 5.0";
    confirmed_effect = [ "æ·»åŠ ç‰¹æ®Šé—œä¿‚æ¨™è¨˜", "åˆå§‹å°Šæ•¬åº¦ç•¥é«˜", "å¯èƒ½çŸ¥æ›‰å®¶æ—å…§éƒ¨å‚³è", "å¯èƒ½ä½œç‚ºå¼•è–¦å¥‘æ©Ÿ", "åˆ©ç”¨èº«ä»½å¯èƒ½ç”¢ç”Ÿè² é¢å¾Œæœ" ];
    notes = "å¢åŠ è¶£å‘³æ€§ï¼Œæ‡‰æ¥µç¨€æœ‰ï¼Œè¬¹æ…è™•ç†å½±éŸ¿ã€‚";
  };

  tagging_rules = {
    confirmation_methods = ["NPCæ‰¿èª", "æ‰¾åˆ°è­‰æ“š(æ—è­œ/ä¿¡ç‰©)", "å®Œæˆèª¿æŸ¥ä»»å‹™", "åŠ‡æƒ…æ­ç¤º"];
    tag_application = "é—œä¿‚ç¢ºèªå¾Œï¼Œåœ¨NPCçš„ flags æˆ– known_kinship_links ä¸­æ·»åŠ æ˜ç¢ºæ¨™è¨˜ã€‚";
    notes = "æœªç¢ºèªé—œä¿‚ï¼ŒAIæ‡‰å…§éƒ¨è¨˜éŒ„æˆ–æš—ç¤ºï¼Œä¸ç›´æ¥æ¨™è¨˜ã€‚";
  };
};;
(* === å§“åã€å®¶æ—èˆ‡è¦ªç·£é—œä¿‚è¦å‰‡ å€å¡ŠçµæŸ === *)


(* --- 5. ğŸ•¸ï¸ åŠ‡æƒ…é—œä¿‚ç¶²æ¨¡çµ„ (Relationship Drama Web) - V2.1 æ•´åˆå‡ç´šç‰ˆ --- *)
(* æ­¤éƒ¨åˆ†ä¸å— V1.1 ä¿®æ­£ç›´æ¥å½±éŸ¿ï¼Œä½†è§¸ç™¼çš„åŠ‡æƒ…å¯èƒ½èˆ‡ç§˜å¯†è¡Œå‹•æˆ–è¢«æ­éœ²çš„ç§˜å¯†æœ‰é—œ *)
let relationship_drama_system = {

  relationship_web_data = ref (StringMap.empty : inter_character_relationships StringMap.t); (* å­˜å„²æ‰€æœ‰è§’è‰²é–“çš„é—œä¿‚æ•¸æ“š *)

  get_relationship = (fun char_a_id char_b_id -> StringMap.find_opt char_b_id (StringMap.find_opt char_a_id !relationship_web_data |? StringMap.empty)); (* ç°¡æ˜“æŸ¥æ‰¾å‡½æ•¸ *)
  update_relationship = (fun char_a_id char_b_id record ->
    let current_map = StringMap.find_opt char_a_id !relationship_web_data |? StringMap.empty in
    let updated_map = StringMap.add char_b_id record current_map in
    relationship_web_data := StringMap.add char_a_id updated_map !relationship_web_data
    ); (* ç°¡æ˜“æ›´æ–°å‡½æ•¸ *)

  potential_drama_plots = [
    ("ğŸ’”", "ä¸‰è§’æˆ€ï¼å››è§’æˆ€", "å¤šè§’è‰²å°åŒä¸€ç›®æ¨™ç”¢ç”Ÿé«˜å¥½æ„Ÿ/æ„›æ…•ï¼Œå¼•ç™¼æƒ…æ„Ÿç³¾è‘›ã€ç«¶çˆ­ã€‚");
    ("ğŸ”ª", "é›™é‡èº«ä»½ï¼è‡¥åº•", "æŸè§’è‰²å¯¦éš›èº«ä»½èˆ‡è¡¨é¢ä¸åŒã€‚");
    ("ğŸ§¨", "èƒŒå›èˆ‡åè½‰", "åœ¨é«˜ä¿¡ä»»åŸºç¤ä¸Šç™¼ç”Ÿé—œéµèƒŒå›äº‹ä»¶ã€‚");
    ("ğŸ§¬", "è¡€ç·£è¬åœ˜", "æ­éœ²æœªçŸ¥çš„è¡€ç·£é—œä¿‚ã€‚");
    ("ğŸ¦", "å®¶ç”¢/ç¹¼æ‰¿æ¬Šè¡çª", "å®¶æ—æˆ–çµ„ç¹”å…§éƒ¨é¬¥çˆ­ã€‚");
    ("ğŸ’", "å©šå§»æ··äº‚", "æ¶‰åŠé¨™å©šã€é€¼å©šã€é€ƒå©šã€å©šå¤–æƒ…ç­‰ã€‚");
    ("ğŸ­", "æƒ…æ„Ÿå£“æŠ‘èˆ‡èª¤è§£", "è§’è‰²å£“æŠ‘æƒ…æ„Ÿå°è‡´è¡Œç‚ºæ€ªç•°ã€ç”¢ç”Ÿèª¤æœƒã€‚");
    ("âš”ï¸", "é–€æ´¾æ©æ€¨æƒ…ä»‡", "å› é–€æ´¾ç«‹å ´å°è‡´çš„è¡çªã€æ„›æƒ…æ‚²åŠ‡ã€‚");
    ("ğŸ¤", "çµç¾©åç›®/è€ƒé©—", "çµæ‹œé—œä¿‚é¢è‡¨è€ƒé©—ç”šè‡³ç ´è£‚ã€‚");
    ("å¸«å¾’æ©æ€¨", "å¸«å¾’é–“å› ç†å¿µã€æ­¦åŠŸã€æƒ…æ„Ÿç­‰ç”¢ç”Ÿç³¾è‘›ã€‚");
    ("å¾©ä»‡åŸ·å¿µ", "æŸè§’è‰²åŸ·è‘—æ–¼å¾©ä»‡ï¼Œå½±éŸ¿å…¶è¡Œç‚ºã€‚");
  ];

  trigger_mechanism_notes = "(* å¼µåŠ›åŠ‡æƒ…çš„è§¸ç™¼ä¸»è¦ç”±ã€Quest/Event ç³»çµ±ã€‘æˆ–ã€Dynamic Random Event ç³»çµ±ã€‘æ ¹æ“šç•¶å‰é—œä¿‚æ•¸å€¼ã€æ¨™è¨˜å’Œç‰¹å®šæ¢ä»¶ä¾†æ±ºå®šã€‚æœ¬æ¨¡çµ„æä¾›ç´ æåº«å’Œåˆ¤æ–·ä¾æ“šã€‚*)";
  maintenance_notes = "(* AIéœ€æŒçºŒæ›´æ–°é—œä¿‚æ•¸æ“šï¼Œè¨˜éŒ„é—œéµäº’å‹•ã€æƒ…æ„Ÿè®ŠåŒ–ã€æ–°æ­éœ²çš„ç§˜å¯†/é—œä¿‚æ¨™è¨˜ã€‚ ã€V1.1 é—œè¯ã€‘ç§˜å¯†è¡Œå‹•é›–ç„¶å¯èƒ½ä¸å½±éŸ¿å…¬é–‹è©•åƒ¹ï¼Œä½†è‹¥è¢«æ­éœ²ï¼Œå¯æˆç‚ºåŠ‡æƒ…è§¸ç™¼é»ã€‚*)";
};;


(* --- 6. ğŸ”„ æ¨¡çµ„äº’å‹•ç¸½çµ (Interactions Summary) - V2.1 æ•´åˆç‰ˆ + V1.1 å½±éŸ¿ --- *)
let comprehensive_interactions = {
  reputation_impacts_relationships = "ã€åè²ã€‘å’Œã€é“å¾·ã€‘å½±éŸ¿ä»–äººåˆå§‹ã€å¥½æ„Ÿåº¦ã€‘å’Œã€å°Šæ•¬åº¦ã€‘ã€‚ (* V1.1 æ³¨: è‹¥è² é¢åè²/é“å¾·å› æœªè¢«ç™¼ç¾è€Œæœªç”¢ç”Ÿï¼Œæ­¤åˆå§‹å½±éŸ¿äº¦ä¸å­˜åœ¨ *)";
  relationships_impact_reputation = "èˆ‡é«˜åœ°ä½/è²æœ› NPC çš„ã€è‰¯å¥½å€‹äººé—œä¿‚ã€‘å¯èƒ½é–“æ¥æå‡ã€æ±Ÿæ¹–åè²ã€‘æˆ–ã€é™£ç‡Ÿç«‹å ´ã€‘ã€‚";
  faction_impacts_relationships = "åŠ å…¥æˆ–æ•µå°æŸã€é™£ç‡Ÿã€‘ç›´æ¥å½±éŸ¿èˆ‡è©²é™£ç‡Ÿæˆå“¡çš„åŸºç¤ã€å¥½æ„Ÿåº¦ã€‘å’Œã€ä¿¡ä»»åº¦ã€‘ã€‚";
  relationships_impact_faction = "èˆ‡ã€é™£ç‡Ÿã€‘é—œéµäººç‰©çš„å€‹äººé—œä¿‚è®ŠåŒ–ï¼Œå¯èƒ½ä¿®æ­£èˆ‡è©²é™£ç‡Ÿçš„æ•´é«”ã€ç«‹å ´ã€‘è®ŠåŒ–ã€‚";
  morality_impacts_all = "ã€é“å¾·è©•åƒ¹ã€‘å½±éŸ¿ä»–äººè§£è®€ã€åè²ã€‘ï¼Œå½±éŸ¿ã€é™£ç‡Ÿã€‘æ¥ç´åº¦ï¼Œå½±éŸ¿ã€å€‹äººé—œä¿‚ã€‘(ä¿¡ä»»/å°Šæ•¬)ã€‚ (* V1.1 æ³¨: ç§˜å¯†çš„è² é¢è¡Œç‚ºä¸å½±éŸ¿å…¬é–‹é“å¾·è©•åƒ¹ï¼Œä½†å¯èƒ½å½±éŸ¿çŸ¥æƒ…è€…çš„ç§äººä¿¡ä»»/å¥½æ„Ÿ *)";
  drama_triggers = "ã€åŠ‡æƒ…é—œä¿‚ç¶²ã€‘çš„å¼µåŠ›é»åŸºæ–¼ã€äººéš›é—œä¿‚æ•¸å€¼ã€‘(é«˜å¥½æ„Ÿ/ä»‡æ¨/æ¨™è¨˜)å’Œå¤–éƒ¨ã€äº‹ä»¶/ä»»å‹™ã€‘å…±åŒè§¸ç™¼ã€‚";
  feedback_loop = "ç³»çµ±ç›¸äº’å½±éŸ¿ï¼šè¡Œå‹• -> (æ ¹æ“š detection_result) æ”¹è®Šè²æœ›/é—œä¿‚/é“å¾· -> å½±éŸ¿ NPC åæ‡‰ -> (å¯èƒ½è§¸ç™¼æµè¨€/åŠ‡æƒ…) -> è§¸ç™¼æ–°äº‹ä»¶/ä»»å‹™ -> å¸¶ä¾†æ–°è¡Œå‹•æ©Ÿæœƒ...";
  stealth_impact = "ã€V1.1 æ ¸å¿ƒã€‘`stealth_detection_system` çš„è¼¸å‡º `detection_result` ç¾åœ¨æ˜¯å½±éŸ¿è² é¢å…¬é–‹è©•åƒ¹ (é“å¾·ã€åè²ã€é™£ç‡Ÿç«‹å ´) æ˜¯å¦ç”Ÿæ•ˆçš„é—œéµå‰ç½®æ¢ä»¶ã€‚æœªè¢«ç™¼ç¾çš„ç§˜å¯†æƒ¡è¡Œä¸æ‡‰æå®³ç©å®¶çš„å…¬é–‹å½¢è±¡ï¼Œä¹Ÿä¸æ‡‰è§¸ç™¼ç›¸æ‡‰çš„å…¬é–‹æµè¨€ã€‚";
};;

(* --- è£œå……ï¼šé™£ç‡Ÿè©³ç´°è³‡æ–™çµæ§‹ (ä¾†è‡ªåŸ reputation_system ä¸­å° faction_details çš„å®šç¾©) --- *)
(* æ­¤éƒ¨åˆ†ä¸å— V1.1 ä¿®æ­£å½±éŸ¿ï¼Œä¿æŒåŸæ¨£ *)
type faction_rank_t = { rank_name: string; level: int; requirements: string list; permissions: string list; };;
type faction_structure_t = { leadership_model: string; current_leader_ids: string list; succession_rules: string; hierarchy_ranks: faction_rank_t list; key_departments: string list option; };;
type faction_membership_t = { recruitment_policy: string; joining_requirements: string list; initiation_process_lore_id: string option; member_benefits: string list; member_duties: string list; rules_and_taboos_summary: string; leaving_consequences_lore_id: string option; };;
type faction_resources_t = { base_location_ids: string list; territory_description: string; estimated_strength: (string * string) list; unique_skills: string list; unique_items: string list; special_knowledge_lore_ids: string list; };;
type faction_relation_entry_t = { target_faction_id: string; relation_type: string; intensity: float; notes: string option; };;
type faction_external_relations_t = { relations_list: faction_relation_entry_t list; public_perception_summary: string; };;
type faction_goals_t = { overall_status: string; short_term_goals: string list; long_term_ambitions: string list; };;
type faction_profile_t = { faction_id: string; name_cn: string; name_en: string; aliases: string list option; type_: string; alignment_philosophy: string; history_summary_lore_id: string option; internal_structure: faction_structure_t; membership: faction_membership_t; resources_capabilities: faction_resources_t; external_relations: faction_external_relations_t; current_status_goals: faction_goals_t; tags: string list option; (* æ·»åŠ ç¼ºå¤±å­—æ®µ *) };;

(* (æ¦‚å¿µæ€§) é™£ç‡Ÿè³‡æ–™åº« *)
module FactionMap = Map.Make(String);;
let faction_database : faction_profile_t FactionMap.t ref = ref FactionMap.empty;;

(* --- End of Reputation System Comprehensive definition --- *)


(* === Content from: ğŸ“œ ä¸–ç•Œå‚³èªªèˆ‡æ­·å²æ¨¡çµ„ (world_lore_history_system.ml).ini === *)
(* æ­¤éƒ¨åˆ†ä¸å— V1.1 ä¿®æ­£å½±éŸ¿ï¼Œä¿æŒåŸæ¨£ *)

# ğŸ“œ ä¸–ç•Œå‚³èªªèˆ‡æ­·å²æ¨¡çµ„ (world_lore_history_system.ml)

## ğŸ“˜ æ¨¡çµ„èªªæ˜
æœ¬æ¨¡çµ„è² è²¬å­˜å„²å’Œç®¡ç†éŠæˆ²ä¸–ç•Œçš„èƒŒæ™¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬é‡è¦çš„æ­·å²äº‹ä»¶ã€å‚³èªªä¸­çš„äººç‰©èˆ‡åœ°é»ã€ç¥è©±ã€é è¨€ã€æ–‡åŒ–ç¿’ä¿—ä»¥åŠèˆ‡ç‰¹å®šåœ°é»ã€ç‰©å“æˆ–é™£ç‡Ÿç›¸é—œçš„èƒŒæ™¯çŸ¥è­˜ã€‚é€™äº›ä¿¡æ¯æ—¨åœ¨ç‚º AI æä¾›ç´ æï¼Œä»¥è±å¯ŒéŠæˆ²æ•˜äº‹ã€NPC å°è©±ã€ç‰©å“æè¿°ï¼Œä¸¦å¯èƒ½ä½œç‚ºè§¸ç™¼ä»»å‹™æˆ–ç©å®¶ç†è§£ä¸–ç•Œè§€çš„ç·šç´¢ã€‚

---

## âš™ï¸ æ ¸å¿ƒæ©Ÿåˆ¶ï¼šä¿¡æ¯å­˜å–èˆ‡å±•ç¾ (Conceptual)
```ml
let lore_access_process = {
  trigger_points = ["ç©å®¶èˆ‡NPCå°è©±(é—œéµè©/æ­·å²)", "æª¢æŸ¥ç‰©å“(æ›¸ç±/å¤ç‰©/ç¢‘æ–‡)", "æ¢ç´¢åœ°é»(å¤è¹Ÿ)", "å­¸ç¿’çŸ¥è­˜æŠ€èƒ½", "ä»»å‹™/äº‹ä»¶éœ€æ±‚", "AIä¸»å‹•å¼•å…¥"];
  retrieval_logic = "æ ¹æ“šè§¸ç™¼é»é—œéµè©/IDåœ¨æœ¬æ¨¡çµ„æœç´¢ç›¸é—œã€å‚³èªªæ¢ç›®ã€";
  accessibility_check = "æª¢æŸ¥æ¢ç›®ã€å¯åŠæ€§/éš±ç§˜åº¦ã€å°æ¯”ç©å®¶ç‹€æ…‹(çŸ¥è­˜æŠ€èƒ½/ä½ç½®/é—œä¿‚)";
  presentation_methods = ["NPCè¬›è¿°", "æ–‡ç»æ‘˜éŒ„", "ç©å®¶å›æ†¶/éˆå…‰ä¸€é–ƒ", "AIæè¿°èƒŒæ™¯åƒè€ƒ"];
  state_update_optional = "ç©å®¶ç²çŸ¥é‡è¦å‚³èªªå¾Œï¼Œå¯è¨˜éŒ„å·²çŸ¥æ¨™è¨˜ï¼Œå½±éŸ¿å¾ŒçºŒ";
}
;;

ğŸ“š å‚³èªªæ¢ç›®æ•¸æ“šçµæ§‹ (Lore Entry Structure)
(* å‚³èªªæ¢ç›®é—œè¯å¯¦é«” *)
type lore_related_entities = {
  npc_ids: string list option;
  location_ids: string list option;
  faction_ids: string list option;
  item_ids: string list option;
  related_lore_ids: string list option;
};;

(* å‚³èªªæ¢ç›®å®šç¾© *)
type lore_entry = {
  lore_id: string; (* æ¢ç›®ID *)
  title_keywords: string; (* æ¨™é¡Œé—œéµè© *)
  category: string; (* åˆ†é¡ *)
  content: string; (* å…§å®¹ *)
  accessibility: string; (* å¯åŠæ€§/éš±ç§˜åº¦ *)
  source_examples: string list; (* ä¿¡æ¯ä¾†æºç¯„ä¾‹ *)
  related_entities: lore_related_entities option; (* é—œè¯å¯¦é«” *)
  tags: string list; (* æ¨™ç±¤ *)
};;

(* (æ¦‚å¿µæ€§) å‚³èªªè³‡æ–™åº« *)
module LoreMap = Map.Make(String);;
let lore_database : lore_entry LoreMap.t ref = ref LoreMap.empty;;

(* ç¯„ä¾‹æ•¸æ“šæ’å…¥å‡½æ•¸ (ç¤ºæ„) *)
let add_lore_entry (entry: lore_entry) =
  lore_database := LoreMap.add entry.lore_id entry !lore_database
;;

âœ¨ å‚³èªªæ¢ç›®ç¯„ä¾‹åº« (éƒ¨åˆ†)
(* --- é–åº·ä¹‹è€» --- *)
let lore_jingkang : lore_entry = {
  lore_id = "LORE_JINGKANG_INCIDENT_01"; title_keywords = "é–åº·ä¹‹è€» | é‡‘äººå—ä¾µ | åŒ—å®‹è¦†æ»…"; category = "æ­·å²äº‹ä»¶";
  content = """ç™¾é¤˜å¹´å‰ï¼ŒåŒ—åœ°å¥³çœŸé‡‘åœ‹å¤§èˆ‰å—ä¾µï¼Œæ”»ç ´å¤§å®‹éƒ½åŸæ±´äº¬ï¼Œæ“„èµ°å¾½æ¬½äºŒå¸åŠå¤§é‡çš‡æ—ã€è‡£æ°‘ï¼Œå²ç¨±ã€Œé–åº·ä¹‹è€»ã€ã€‚æ­¤äº‹ä»¶å°è‡´åŒ—å®‹æ»…äº¡ï¼Œä¸­åŸé™·å…¥é•·æœŸæˆ°äº‚ï¼Œäº¦æ¿€èµ·ç„¡æ•¸æ¼¢å®¶å…’å¥³çš„æŠ—é‡‘ç†±æƒ…èˆ‡åœ‹ä»‡å®¶æ¨ã€‚è¨±å¤šæ­¦æ—é–€æ´¾çš„èˆˆè¡°ã€çµ•ä¸–æ­¦åŠŸçš„æµå‚³ï¼Œä¹ƒè‡³ä¸€äº›å®¶æ—çš„ä¸–ä»£æ©æ€¨ï¼Œéƒ½èˆ‡æ­¤åœ‹ç ´å®¶äº¡çš„æ…˜ç—›æ­·å²æ¯æ¯ç›¸é—œã€‚""";
  accessibility = "æ™®éçŸ¥è­˜ (Common Knowledge)"; source_examples = ["æ›¸ç± (å²æ›¸)", "å¹´é•·NPCè¬›è¿°", "èªªæ›¸äºº"];
  related_entities = Some { npc_ids=Some ["yue_fei?", "han_shizhong?"]; location_ids=Some ["bianjing_ruins?", "linan_city?"]; faction_ids=Some ["song_dynasty_remnants?", "jin_empire?"]; item_ids=None; related_lore_ids=Some ["LORE_ANTI_JIN_HEROES_01"] };
  tags = ["å®‹æœ", "é‡‘åœ‹", "æˆ°çˆ­", "åœ‹ä»‡å®¶æ¨", "æ­·å²è½‰æŠ˜"];
};;
(* let () = add_lore_entry lore_jingkang;; *)

(* --- é”æ‘©æ±æ¸¡èˆ‡å°‘æ—å‰µç«‹ --- *)
let lore_damo_shaolin : lore_entry = {
  lore_id = "LORE_DAMO_SHAOLIN_01"; title_keywords = "é”æ‘© | è©æé”æ‘© | å°‘æ—å¯º | ç¦ªå®— | æ˜“ç­‹ç¶“ | æ´—é«“ç¶“"; category = "å‚³å¥‡äººç‰© | é–€æ´¾æ­·å²";
  content = """ç›¸å‚³å—åŒ—æœæ™‚æœŸï¼Œå¤©ç«ºé«˜åƒ§è©æé”æ‘©èˆªæµ·æ±ä¾†ï¼Œæ­·ç¶“è‰±éšªæŠµé”ä¸­åœŸã€‚å¾Œæ–¼åµ©å±±å°‘æ—å¯ºé¢å£ä¹å¹´ï¼Œå‰µç«‹ç¦ªå®—ï¼Œç•™ä¸‹ã€Šæ˜“ç­‹ç¶“ã€‹èˆ‡ã€Šæ´—é«“ç¶“ã€‹å…©å¤§ç¥åŠŸç§˜ç±ã€‚é”æ‘©è¢«å°Šç‚ºä¸­åœŸç¦ªå®—åˆç¥–ï¼Œå°‘æ—å¯ºä¹Ÿå› æ­¤æˆç‚ºæ­¦æ—ä¸­çš„æ³°å±±åŒ—æ–—ï¼Œå…¶æ­¦å­¸åšå¤§ç²¾æ·±ï¼Œå½±éŸ¿æ·±é ã€‚ç„¶è€Œï¼Œé—œæ–¼é”æ‘©ç¥–å¸«çš„å…·é«”äº‹è¹Ÿä»¥åŠå…©å¤§ç¥åŠŸçš„çœŸå¯¦ä¸‹è½ï¼Œæ­·ä¾†çœ¾èªªç´›ç´œï¼Œæ˜¯æ­¦æ—ä¸­é•·ä¹…ä¸è¡°çš„å‚³èªªã€‚""";
  accessibility = "å»£æ³›æµå‚³ (Widely Known)"; source_examples = ["æ±Ÿæ¹–å‚³è", "æ›¸ç±(ä½›ç¶“/æ­¦å­¸é›œè«‡)", "å°‘æ—ç›¸é—œNPC"];
  related_entities = Some { npc_ids=Some ["Bodhidharma(legendary)"]; location_ids=Some ["shaolin_temple"]; faction_ids=Some ["shaolin_sect"]; item_ids=Some ["yi_jin_jing(legendary)?", "xi_sui_jing(legendary)?"]; related_lore_ids=Some ["LORE_SHAOLIN_KUNGFU_01"] };
  tags = ["é”æ‘©", "å°‘æ—å¯º", "ç¦ªå®—", "æ˜“ç­‹ç¶“", "æ´—é«“ç¶“", "å—åŒ—æœ", "æ­¦å­¸èµ·æº"];
};;
(* let () = add_lore_entry lore_damo_shaolin;; *)

(* --- é€é™æ´¾ä¹‹è¬ --- *)
let lore_xiaoyao : lore_entry = {
  lore_id = "LORE_XIAOYAO_SECT_MYSTERY_01"; title_keywords = "é€é™æ´¾ | ç„¡å´–å­ | å¤©å±±ç«¥å§¥ | æç§‹æ°´ | é€é™å¾¡é¢¨ | åŒ—å†¥ç¥åŠŸ | å°ç„¡ç›¸åŠŸ"; category = "é–€æ´¾æ­·å² | ç§˜å¯†";
  content = """é€é™æ´¾æ˜¯ä¸€å€‹æ¥µç‚ºç¥ç§˜çš„é–€æ´¾ï¼Œæ“šå‚³ç”±é€é™å­æ‰€å‰µï¼Œå…¶é–€ä¸‹å¼Ÿå­å€‹å€‹èº«æ‡·çµ•æŠ€ï¼Œä¸”ç²¾é€šç´æ£‹æ›¸ç•«ã€é†«åœæ˜Ÿè±¡ç­‰é›œå­¸ã€‚å…¶æ ¸å¿ƒæ­¦å­¸å¦‚ã€ŒåŒ—å†¥ç¥åŠŸã€ã€ã€Œå°ç„¡ç›¸åŠŸã€ã€ã€Œå‡Œæ³¢å¾®æ­¥ã€ç­‰çš†æ˜¯å¨åŠ›ç„¡çª®ã€éœ‡å¤çˆä»Šçš„çµ•å­¸ã€‚ç„¶è€Œæ­¤æ´¾è¡Œäº‹ä½èª¿è©­ç§˜ï¼Œå°‘åœ¨æ±Ÿæ¹–èµ°å‹•ï¼Œä¸”é–€è¦æ£®åš´ï¼Œå…§éƒ¨é—œä¿‚è¤‡é›œï¼Œå……æ»¿æ©æ€¨æƒ…ä»‡ã€‚é—œæ–¼å…¶å‚³æ‰¿ã€æ“šé»ä»¥åŠé–€äººç¾ç‹€ï¼Œæ±Ÿæ¹–ä¸­çŸ¥ä¹‹ç”šå°‘ï¼Œå¤šç‚ºé›¶æ˜Ÿå‚³èã€‚""";
  accessibility = "ç½•è¦‹è¨˜è¼‰ | ç§˜å¯† (Secret)"; source_examples = ["ç‰¹å®šå¤ç±æ®˜å·", "èˆ‡é€é™æ´¾æœ‰é—œçš„æ¥µå°‘æ•¸NPC", "ç›¸é—œå¥‡é‡ä»»å‹™"];
  related_entities = Some { npc_ids=Some ["wu_yazi?", "tianshan_tonglao?", "li_qiushui?"]; location_ids=None; faction_ids=Some ["xiaoyao_sect(mysterious)"]; item_ids=None; related_lore_ids=None };
  tags = ["é€é™æ´¾", "ç¥ç§˜é–€æ´¾", "çµ•ä¸–æ­¦åŠŸ", "åŒ—å†¥ç¥åŠŸ", "å°ç„¡ç›¸åŠŸ", "å‡Œæ³¢å¾®æ­¥"];
};;
(* let () = add_lore_entry lore_xiaoyao;; *)

(* --- è¡€åˆ€é–€çš„å‚³è --- *)
let lore_bloodsaber : lore_entry = {
  lore_id = "LORE_BLOOD_SABER_SECT_01"; title_keywords = "è¡€åˆ€é–€ | è¡€åˆ€è€ç¥– | è¡€åˆ€å¤§æ³• | é›ªå±± | è—é‚Š"; category = "é–€æ´¾æ­·å² | åœ°æ–¹å‚³è";
  content = """å‚³èè—é‚Šé›ªå±±ä¸­æœ‰ä¸€å€‹é‚ªæ´¾ã€Œè¡€åˆ€é–€ã€ï¼Œç”±è¡€åˆ€è€ç¥–å‰µç«‹ã€‚å…¶é–€äººè¡Œäº‹æ®˜å¿ï¼Œæ­¦åŠŸè©­ç•°éœ¸é“ï¼Œå°¤ä»¥ã€Œè¡€åˆ€å¤§æ³•ã€èåã€‚è¡€åˆ€é–€å¼Ÿå­å¸¸åœ¨è—é‚ŠåŠè¥¿åŸŸæ´»å‹•ï¼Œèˆ‡ä¸­åŸæ­£æ´¾å¤šæœ‰è¡çªï¼Œè¢«è¦–ç‚ºé‚ªé­”å¤–é“ã€‚æ“šèªªå…¶ç¸½èˆµéš±è—åœ¨æ¥µç‚ºéšªå³»çš„é›ªå±±æ·±è™•ã€‚è¿‘å¹´ä¾†è¡€åˆ€é–€ä¼¼ä¹è¼ƒç‚ºæ²‰å¯‚ï¼Œä¸çŸ¥æ˜¯å¦æœ‰æ‰€åœ–è¬€ï¼Œæˆ–æ˜¯å…§éƒ¨ç™¼ç”Ÿäº†è®Šæ•…ã€‚""";
  accessibility = "åœ°æ–¹å‚³è (Local Legend)"; source_examples = ["è¥¿åŸŸNPC", "æ±Ÿæ¹–äººå£«(æåŠé‚ªæ´¾)", "ç‰¹å®šä»»å‹™"];
  related_entities = Some { npc_ids=Some ["blood_saber_patriarch(legendary)?"]; location_ids=Some ["xueshan_area(tibetan_plateau)"]; faction_ids=Some ["blood_saber_sect"]; item_ids=Some ["blood_saber(weapon)?"]; related_lore_ids=None };
  tags = ["è¡€åˆ€é–€", "é‚ªæ´¾", "è—é‚Š", "é›ªå±±", "è¡€åˆ€è€ç¥–"];
};;
(* let () = add_lore_entry lore_bloodsaber;; *)

(* --- é—œæ–¼ã€Œä¿ ä¹‹å¤§è€…ã€çš„è¨è«– --- *)
let lore_great_hero : lore_entry = {
  lore_id = "LORE_GREAT_HERO_CONCEPT_01"; title_keywords = "ä¿ ä¹‹å¤§è€… | ç‚ºåœ‹ç‚ºæ°‘ | ä¿ ç¾©ç²¾ç¥ | æ±Ÿæ¹–é“ç¾©"; category = "æ–‡åŒ–ç¿’ä¿— | åƒ¹å€¼è§€";
  content = """åœ¨æ­¦æ—ä¸­ï¼Œã€Œä¿ ã€ä¹‹ä¸€å­—æ„ç¾©é‡å¤§ã€‚ä½•ç‚ºã€Œä¿ ã€ï¼Ÿæœ‰äººèªç‚ºæ˜¯è·¯è¦‹ä¸å¹³æ‹”åˆ€ç›¸åŠ©ï¼Œæœ‰äººèªç‚ºæ˜¯å¿«æ„æ©ä»‡ç€Ÿç‘è‡ªåœ¨ã€‚ä½†æ›´æ·±ä¸€å±¤çš„ç†è§£ï¼Œå¦‚éƒ­é–å¤§ä¿ æ‰€è¨€ï¼Œã€Œä¿ ä¹‹å¤§è€…ï¼Œç‚ºåœ‹ç‚ºæ°‘ã€ã€‚çœŸæ­£çš„ä¿ ç¾©ï¼Œä¸åƒ…åœ¨æ–¼å€‹äººçš„æ­¦å‹‡èˆ‡æ©æ€¨ï¼Œæ›´åœ¨æ–¼å¿ƒæ‡·å¤©ä¸‹è’¼ç”Ÿï¼Œè‚©è² èµ·ä¿å®¶è¡›åœ‹çš„è²¬ä»»ã€‚é€™ç¨®ç†å¿µå½±éŸ¿äº†è¨±å¤šæ±Ÿæ¹–ä¸­äººï¼Œæˆç‚ºä»–å€‘è¡Œäº‹çš„æº–å‰‡å’Œè¿½æ±‚çš„ç›®æ¨™ï¼Œä½†ä¹Ÿå¸¸èˆ‡å€‹äººæƒ…æ„Ÿã€é–€æ´¾åˆ©ç›Šç™¼ç”Ÿè¡çªã€‚å¦‚ä½•æŠ‰æ“‡ï¼Œæ˜¯è¨±å¤šè‹±é›„éœ€è¦é¢å°çš„é›£é¡Œã€‚""";
  accessibility = "æ™®éçŸ¥è­˜ (Common Knowledge)"; source_examples = ["èˆ‡æ­£æ´¾NPCæ·±å…¥äº¤è«‡", "é–±è®€ç‰¹å®šæ›¸ç±(å¦‚è‹±é›„å‚³è¨˜)", "åŠ‡æƒ…è§¸ç™¼"];
  related_entities = Some { npc_ids=Some ["guo_jing(legendary)?"]; location_ids=None; faction_ids=None; item_ids=None; related_lore_ids=Some ["LORE_JINGKANG_INCIDENT_01"] };
  tags = ["ä¿ ç¾©", "åƒ¹å€¼è§€", "æ±Ÿæ¹–é“ç¾©", "ç‚ºåœ‹ç‚ºæ°‘", "éƒ­é–"];
};;
(* let () = add_lore_entry lore_great_hero;; *)

(* --- å‰æœå¯¶è—çš„å‚³èªª --- *)
let lore_treasure : lore_entry = {
  lore_id = "LORE_DYNASTY_TREASURE_01"; title_keywords = "å‰æœå¯¶è— | é—–ç‹å¯¶è— | é¾è„ˆ | è—å¯¶åœ–"; category = "åœ°é»å‚³èªª | ç‰©å“å‚³èªª";
  content = """æ±Ÿæ¹–å‚³è¨€ï¼Œå‰æœè¦†æ»…ä¹‹éš›ï¼Œæœ‰å¤§é‡çš„é‡‘éŠ€è²¡å¯¶è¢«ç§˜å¯†è—åŒ¿èµ·ä¾†ï¼Œç­‰å¾…æœ‰ç·£äººç™¼æ˜ï¼Œä»¥åœ–æ±å±±å†èµ·æˆ–ç”¨æ–¼æ¿Ÿä¸–å®‰æ°‘ã€‚é—œæ–¼å¯¶è—çš„åœ°é»çœ¾èªªç´›ç´œï¼Œæœ‰çš„èªªè—æ–¼æ·±å±±å¤å¢“ï¼Œæœ‰çš„èªªéš±æ–¼é¬§å¸‚å¯†å®¤ï¼Œé‚„æœ‰çš„èªªèˆ‡æ‰€è¬‚çš„ã€Œé¾è„ˆã€æœ‰é—œã€‚æ“šèªªé–‹å•Ÿå¯¶è—éœ€è¦é›†é½Šæ•¸å¼µç¥ç§˜çš„ã€Œè—å¯¶åœ–æ®˜ç‰‡ã€ã€‚å¤šå¹´ä¾†ï¼Œç„¡æ•¸äººç‚ºäº†å°‹æ‰¾å¯¶è—è€Œå¥”æ³¢ï¼Œå¼•ç™¼äº†è«¸å¤šçˆ­é¬¥èˆ‡é™°è¬€ã€‚""";
  accessibility = "å»£æ³›æµå‚³çš„ç§˜å¯† (Widespread Secret)"; source_examples = ["æ±Ÿæ¹–å‚³è", "èªªæ›¸äººæ•…äº‹", "ç‰¹å®šNPCï¼ˆçŸ¥æƒ…è€…/å°‹å¯¶è€…ï¼‰", "è—å¯¶åœ–æ®˜ç‰‡ç‰©å“"];
  related_entities = Some { npc_ids=None; location_ids=Some ["various_secret_locations?"]; faction_ids=None; item_ids=Some ["treasure_map_fragment_setX_partY"]; related_lore_ids=None };
  tags = ["å¯¶è—", "å‚³èªª", "è—å¯¶åœ–", "å‰æœ", "é¾è„ˆ", "è²¡å¯Œ"];
};;
(* let () = add_lore_entry lore_treasure;; *)

ğŸ”— ä¾è³´æ¨¡çµ„ (Dependencies)
(* èˆ‡è²æœ›ç³»çµ±éƒ¨åˆ†çš„ä¾è³´åˆ—è¡¨æœ‰æ‰€é‡ç–Šï¼Œå¯¦éš›æ‡‰ç”¨ä¸­éœ€çµ±ä¸€ç®¡ç† *)
let lore_depends_on = [
  "world_settings.ml";            (* ä¸–ç•ŒèƒŒæ™¯å’Œæ™‚é–“ *)
  "map_exploration_system.ml";    (* åœ°é»ä¿¡æ¯ *)
  "npc_stats_tracker.ml";         (* NPC çŸ¥è­˜åº« *)
  "ai_behavior_system.ml";        (* NPC è¡Œç‚ºå‹•æ©Ÿ *)
  "item_consumable_system.ml";    (* æ›¸ç±/ç‰©å“åŒ…å«ä¿¡æ¯ *)
  "equipment.ml";                 (* ç¥å…µå‚³èªª *)
  "skills_proficiency.ml";        (* çŸ¥è­˜æŠ€èƒ½å½±éŸ¿ç†è§£ *)
  "quest_event_system.ml";        (* ä»»å‹™èƒŒæ™¯/è§¸ç™¼ *)
  "reputation_system_comprehensive_v2_1_mod.ml"; (* é–€æ´¾æ­·å²/é™£ç‡Ÿç´°ç¯€ - æ›´æ–°æª”å *)
]
;;

ğŸ“˜ ä½¿ç”¨æç¤º (AI Guidance)
(*
AI ä½¿ç”¨æ­¤æ¨¡çµ„æ™‚æ‡‰æ³¨æ„ï¼š
- **å‹•æ…‹ä¿¡æ¯åº«:** éˆæ´»æå–å’Œå‘ˆç¾ä¿¡æ¯ã€‚
- **è‡ªç„¶èå…¥:** å°‡ä¿¡æ¯èå…¥å°è©±ã€æè¿°ã€ä»»å‹™èƒŒæ™¯ã€‚
- **ä¿¡æ¯å±¤æ¬¡:** æ ¹æ“šå¯åŠæ€§æ§åˆ¶ä¿¡æ¯é‡‹æ”¾ã€‚
- **çœŸå½é›£è¾¨:** é©ç•¶å¼•å…¥çŸ›ç›¾æˆ–æ¨¡ç³Šä¿¡æ¯ã€‚
- **å½±éŸ¿æ±ºç­–:** ç©å®¶äº†è§£çš„ä¿¡æ¯æ‡‰èƒ½å½±éŸ¿å…¶åˆ¤æ–·ã€‚
- **ç·šç´¢é—œè¯:** åˆ©ç”¨é—œè¯å¯¦é«”å’Œæ¨™ç±¤å»ºç«‹ä¿¡æ¯ç¶²çµ¡ã€‚
- **ç©å®¶çŸ¥è­˜è¿½è¹¤(æ¨è–¦):** è¨˜éŒ„ç©å®¶å·²çŸ¥ä¿¡æ¯ï¼Œé¿å…é‡è¤‡ä¸¦ç”¨æ–¼å¾ŒçºŒã€‚
*)

(* **ã€V2.1_modified æ•´åˆè¨»é‡‹ã€‘**
   æœ¬æ–‡ä»¶å·²å°‡ã€Œç¶œåˆè²æœ›ã€äººéš›é—œä¿‚èˆ‡åŠ‡æƒ…æ¨¡çµ„ã€çš„ V2.1 ç‰ˆæœ¬èˆ‡ã€Œç„¡ç›®æ“Šä¿®æ­£ V1.1ã€çš„æ ¸å¿ƒè¦å‰‡æ•´åˆã€‚
   - è²æœ›ã€é“å¾·ã€é™£ç‡Ÿç«‹å ´çš„è² é¢å½±éŸ¿è¨ˆç®—ï¼Œç¾åœ¨éœ€è¦ä¾è³´ã€æ½›è¡Œèˆ‡åµæ¸¬ç³»çµ±ã€‘çš„è¼¸å‡ºçµæœ `detection_result`ã€‚
   - PC åŸ·è¡Œçš„è² é¢è¡Œç‚ºè‹¥æœªè¢«ç™¼ç¾ä¸”ç„¡ç›´æ¥è­‰æ“šï¼Œå°‡ä¸æœƒå°è‡´å…¬é–‹è©•åƒ¹ï¼ˆé“å¾·ã€åè²ã€é™£ç‡Ÿç«‹å ´ï¼‰ä¸‹é™ï¼Œä¹Ÿä¸æœƒè§¸ç™¼ç›¸é—œå…¬é–‹æµè¨€ã€‚
   - ç§äººé—œä¿‚ï¼ˆå¦‚ç‰¹å®šç›®æ“Šè€…çš„å¥½æ„Ÿã€ä¿¡ä»»ï¼‰ä»å¯èƒ½å—åˆ°å½±éŸ¿ã€‚
   - æ–‡ä»¶ä¿ç•™äº† V2.1 çš„æ‰€æœ‰è©³ç´°çµæ§‹ï¼Œä»¥åŠå§“åå®¶æ—è¦å‰‡å’Œä¸–ç•Œå‚³èªªæ¨¡çµ„çš„å…§å®¹ã€‚
*)

;; (* === End of World Context Merged File === *)