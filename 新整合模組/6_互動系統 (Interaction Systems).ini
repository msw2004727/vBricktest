(* ============================================================ *)
(* ==      åˆä½µæ¨¡çµ„ Part 6: äº’å‹•ç³»çµ± (Interaction Systems)     == *)
(* ==      (å·²æ•´åˆ Stealth & Detection V1.1)                == *)
(* ============================================================ *)

(* === Content from: ğŸ’¬ å°è©±ç³»çµ±æ¨¡çµ„ (dialogue_system.ml).ini === *)
(* æ­¤éƒ¨åˆ†ä¿æŒä¸è®Š *)

# ğŸ’¬ å°è©±ç³»çµ±æ¨¡çµ„ (dialogue_system.ml)

## ğŸ“˜ æ¨¡çµ„èªªæ˜
æœ¬æ¨¡çµ„è² è²¬å®šç¾©å’Œç®¡ç†ç©å®¶è§’è‰² (PC) èˆ‡éç©å®¶è§’è‰² (NPC) ä¹‹é–“çš„å°è©±äº¤äº’ã€‚å®ƒæ”¯æŒåˆ†æ”¯å°è©±ã€åŸºæ–¼æ¢ä»¶çš„é¸é …é¡¯ç¤ºã€æŠ€èƒ½æª¢å®šä»¥åŠé€šéå°è©±è§¸ç™¼éŠæˆ²å…§æ•ˆæœï¼ˆå¦‚é—œä¿‚è®ŠåŒ–ã€ä»»å‹™æ›´æ–°ã€ä¿¡æ¯ç²å–ã€äº‹ä»¶è§¸ç™¼ç­‰ï¼‰ã€‚

---

## âš™ï¸ æ ¸å¿ƒæ©Ÿåˆ¶ï¼šå°è©±æµç¨‹å¼•æ“ (Conceptual)
```ml
(* æ¦‚å¿µæ€§æè¿° AI å¦‚ä½•è™•ç†å°è©± *)
let dialogue_flow_engine = {
  initiation_sources = ["ç©å®¶æŒ‡ä»¤ ([å°è©±] NPC)", "ä»»å‹™/äº‹ä»¶è§¸ç™¼", "NPC ä¸»å‹•ç™¼èµ·"];
  initiation_logic = "ç³»çµ±æ ¹æ“šè§¸ç™¼æ¢ä»¶ç¢ºå®šå°è©±èµ·å§‹ç¯€é» (start_node_id) å’Œåƒèˆ‡è€…";

  node_processing_logic = """
  1. è®€å–ç•¶å‰å°è©±ç¯€é» (current_node)ã€‚
  2. **æª¢æŸ¥ç¯€é»æ¢ä»¶ (conditions):** è‹¥ä¸æ»¿è¶³å‰‡è·³è½‰æˆ–çµæŸã€‚
  3. **åŸ·è¡Œç¯€é»æ•ˆæœ (effects):** å¦‚ NPC æƒ…ç·’è®ŠåŒ–ã€‚
  4. **é¡¯ç¤º NPC å°ç™½ (npc_line):** AI æ ¹æ“šæƒ…ç·’æ¨™ç±¤ ([æ†¤æ€’]) èª¿æ•´æè¿°ã€‚
  5. **è™•ç†ç©å®¶é¸é … (player_choices):**
     - éæ­·é¸é …ï¼Œæª¢æŸ¥é¡¯ç¤ºæ¢ä»¶ (conditions)ã€‚
     - å‘ˆç¾æ»¿è¶³æ¢ä»¶çš„é¸é …æ–‡æœ¬ (choice_text) åŠæç¤º (tooltip/hint)ã€‚
     - è‹¥ç„¡é¸é …ï¼ŒæŸ¥æ‰¾ next_node_id è‡ªå‹•è·³è½‰æˆ–çµæŸã€‚
  """;

  choice_handling_logic = """
  1. ç©å®¶é¸æ“‡å¾Œã€‚
  2. **åŸ·è¡Œé¸é …æ•ˆæœ (effects):**
     - æŠ€èƒ½æª¢å®š (SkillCheck)ã€‚
     - ä¿®æ”¹é—œä¿‚/è²æœ›/é“å¾· (ModifyRelationship/Reputation/Morality)ã€‚
     - æ›´æ–°ä»»å‹™ç‹€æ…‹ (UpdateQuest)ã€‚
     - ç²å¾—/å¤±å»ç‰©å“ (GrantItem/RemoveItem)ã€‚
     - è¨­ç½®æ¨™è¨˜ (SetFlag)ã€‚
     - è§¸ç™¼æˆ°é¬¥ (TriggerCombat)ã€‚
     - çµæŸå°è©± (EndDialogue)ã€‚
  3. **è·³è½‰åˆ°ä¸‹ä¸€ç¯€é»:** æ ¹æ“šé¸é …æŒ‡å®šçš„ next_node_id æˆ–æŠ€èƒ½æª¢å®šçµæœè¨­ç½®æ–°çš„ current_nodeã€‚
  """;

  termination_conditions = ["åˆ°é”ç„¡å¾ŒçºŒçš„ç¯€é»", "é¸æ“‡çµæŸå°è©±çš„é¸é …", "å¤–éƒ¨äº‹ä»¶ä¸­æ–· (å¦‚æˆ°é¬¥)"];
}
;;

ğŸŒ³ å°è©±æ¨¹æ•¸æ“šçµæ§‹ (Dialogue Tree Structure)
(* ä½¿ç”¨ Map æˆ–é¡ä¼¼çµæ§‹å­˜å„²å°è©±æ•¸æ“š *)
module DialogueNodeMap = Map.Make(String);;
module DialogueTreeMap = Map.Make(String);;

(* å°è©±æ•ˆæœåƒæ•¸çµæ§‹ (ç¤ºä¾‹) *)
type effect_parameter =
  | Skill of string
  | Difficulty of int
  | SuccessNode of string
  | FailureNode of string
  | SuccessMessage of string option
  | FailureMessage of string option
  | TargetNPC of string
  | AffinityChange of float
  | TrustChange of float
  | RespectChange of float
  | MoralityChange of float
  | QuestID of string
  | ObjectiveID of string option
  | FlagName of string
  | FlagValue of string (* æˆ– bool, int ç­‰ *)
  | EnemyGroup of string
  | ItemID of string
  | Quantity of int
  (* ... å…¶ä»–å¯èƒ½åƒæ•¸ ... *)
;;

(* å°è©±æ•ˆæœçµæ§‹ *)
type dialogue_effect = {
  effect: string; (* æ•ˆæœé¡å‹, e.g., "SkillCheck", "ModifyRelationship", "EndDialogue" *)
  parameters: (string * effect_parameter) list option; (* æ•ˆæœåƒæ•¸éµå€¼å° *)
};;

(* ç©å®¶é¸é …çµæ§‹ *)
type player_choice = {
  choice_text: string; (* é¸é …é¡¯ç¤ºæ–‡æœ¬ *)
  conditions: string list; (* é¡¯ç¤ºæ­¤é¸é …çš„æ¢ä»¶ *)
  tooltip: string option; (* (å¯é¸) æç¤ºä¿¡æ¯, e.g., "[éœ€è¦ åŠ›é‡ >= 15]" *)
  next_node_id: string option; (* é¸æ“‡å¾Œè·³è½‰çš„ç¯€é» ID *)
  effects: dialogue_effect list; (* é¸æ“‡æ­¤é¸é …è§¸ç™¼çš„æ•ˆæœ *)
};;

(* å°è©±ç¯€é»çµæ§‹ *)
type dialogue_node = {
  node_id: string; (* ç¯€é»å”¯ä¸€ ID *)
  speaker: string; (* NPC ID / "PC" / "Narrator" *)
  npc_line: string; (* NPC å°è© *)
  player_choices: player_choice list; (* ç©å®¶é¸é …åˆ—è¡¨ *)
  node_conditions: string list; (* é€²å…¥æ­¤ç¯€é»çš„æ¢ä»¶ *)
  node_effects: dialogue_effect list; (* åˆ°é”æ­¤ç¯€é»è§¸ç™¼çš„æ•ˆæœ *)
  auto_next_node_id: string option; (* è‹¥ç„¡ç©å®¶é¸é …ï¼Œè‡ªå‹•è·³è½‰çš„ç¯€é» ID *)
};;

(* (æ¦‚å¿µæ€§) å°è©±åº« *)
let dialogue_library : dialogue_node DialogueNodeMap.t DialogueTreeMap.t ref = ref DialogueTreeMap.empty;;

(* ç¯„ä¾‹ç¯€é» (åƒ…ç‚ºçµæ§‹ç¤ºæ„) *)
let guard_greet_01_node : dialogue_node = {
  node_id = "guard_greet_01"; speaker = "npc_guard_chen";
  npc_line = "[ç•¥é¡¯ä¸è€ç…©] ç«™ä½ï¼ä»€éº¼äººï¼Ÿå ±ä¸Šåä¾†ï¼Œèªªæ˜ä¾†æ„ã€‚";
  player_choices = [
    { choice_text = "åœ¨ä¸‹åªæ˜¯è·¯éï¼Œä¸¦ç„¡æƒ¡æ„ã€‚"; conditions = []; tooltip = None; next_node_id = Some "guard_question_purpose_01"; effects = [] };
    { choice_text = "[å‡ºç¤ºä»¤ç‰Œ] æˆ‘æ˜¯å¥‰å¤§ç•¶å®¶ä¹‹å‘½è¾¦äº‹ã€‚"; conditions = ["player.inventory['leader_token'] > 0"]; tooltip = Some "[éœ€è¦ é ­é ˜ä»¤ç‰Œ]"; next_node_id = Some "guard_respectful_01"; effects = [] };
    { choice_text = "[å˜—è©¦èªªæœ] é€™ä½å®˜çˆºè¡Œå€‹æ–¹ä¾¿..."; conditions = []; tooltip = Some "[éœ€è¦ å£æ‰]"; next_node_id = None; effects = [{effect="SkillCheck"; parameters=Some [("skill", Skill "èªªæœ"); ("difficulty", Difficulty 12); ("success_node", SuccessNode "guard_soften_01"); ("failure_node", FailureNode "guard_impatient_01")]}] };
    { choice_text = "[å˜—è©¦ç¡¬é—–]"; conditions = ["player.attributes.STR >= 15"]; tooltip = Some "[éœ€è¦ åŠ›é‡ >= 15] [å¯èƒ½è§¸ç™¼æˆ°é¬¥]"; next_node_id = None; effects = [{effect="TriggerCombat"; parameters=Some [("enemyGroup", EnemyGroup "gate_guards_normal")]}; {effect="EndDialogue"; parameters=None}] };
    { choice_text = "[è½‰èº«é›¢é–‹]"; conditions = []; tooltip = None; next_node_id = None; effects = [{effect="EndDialogue"; parameters=None}] };
  ];
  node_conditions = []; node_effects = []; auto_next_node_id = None;
};;
(* let () = (* ... å°‡ç¯€é»åŠ å…¥ dialogue_library ... *) ();; *)


ğŸ§© å°è©±ä¸»é¡Œèˆ‡è§¸ç™¼å™¨ (Dialogue Topics & Triggers)
(* å¯é¸æ©Ÿåˆ¶ï¼Œç”¨æ–¼ç®¡ç†è¤‡é›œå°è©± *)
type dialogue_topic = {
  topic_keyword: string; (* ç©å®¶å¯è©¢å•çš„é—œéµè© *)
  start_node_id: string; (* å°æ‡‰çš„èµ·å§‹å°è©±ç¯€é» *)
  conditions: string list; (* è«‡è«–æ­¤ä¸»é¡Œçš„æ¢ä»¶ *)
  priority: int; (* (å¯é¸) å„ªå…ˆç´š *)
};;

type contextual_trigger = {
  trigger_event: string; (* è§¸ç™¼äº‹ä»¶æè¿° *)
  start_node_id: string; (* è§¸ç™¼çš„å°è©±èµ·å§‹ç¯€é» *)
};;

type npc_dialogue_triggers = {
  npc_id: string;
  available_topics: dialogue_topic list; (* NPC å¯è«‡è«–çš„ä¸»é¡Œåˆ—è¡¨ *)
  contextual_triggers: contextual_trigger list; (* æƒ…å¢ƒè§¸ç™¼çš„ç‰¹æ®Šå°è©± *)
};;

(* (æ¦‚å¿µæ€§) NPC å°è©±è§¸ç™¼å™¨æ•¸æ“šåº« *)
module NpcTriggerMap = Map.Make(String);;
let npc_dialogue_trigger_db : npc_dialogue_triggers NpcTriggerMap.t ref = ref NpcTriggerMap.empty;;

(* ç¯„ä¾‹ *)
let chenqi_triggers : npc_dialogue_triggers = {
  npc_id = "chen_qi";
  available_topics = [
    { topic_keyword="å±±å¯¨æƒ…æ³"; start_node_id="chenqi_talk_fortress_status_01"; conditions=["player.relationship['chen_qi'].trust >= 0.5"]; priority=1 };
    { topic_keyword="ä½ çš„ä»»å‹™"; start_node_id="chenqi_talk_tasks_01"; conditions=[]; priority=2 };
    { topic_keyword="é—œæ–¼ä¸Šå®˜ç‰"; start_node_id="chenqi_talk_shangguanyu_01"; conditions=["world.flags['ShangguanYu_Arrived'] == true"]; priority=3 };
    { topic_keyword="é–’èŠ"; start_node_id="chenqi_smalltalk_random_01"; conditions=[]; priority=0 };
  ];
  contextual_triggers = [
    { trigger_event="player_interrupts_chenqi_scolding_subordinate"; start_node_id="chenqi_scolding_interrupted_01" };
  ];
};;
(* let () = npc_dialogue_trigger_db := NpcTriggerMap.add chenqi_triggers.npc_id chenqi_triggers !npc_dialogue_trigger_db;; *)

ğŸ”— ä¾è³´æ¨¡çµ„ (Dependencies)
let dialogue_depends_on = [
  "npc_stats_tracker.ml";               (* æä¾› NPC ID, ç‹€æ…‹, é—œä¿‚æ•¸æ“š *)
  "reputation_system_comprehensive.ml"; (* æä¾›é—œä¿‚å€¼, è²æœ›, é“å¾·ä½œç‚ºæ¢ä»¶å’Œæ•ˆæœ *)
  "emotion_psychology.ml";              (* æä¾› NPC æƒ…ç·’å½±éŸ¿èªæ°£å’Œåˆ†æ”¯ *)
  "skills_proficiency.ml";              (* æä¾›æŠ€èƒ½æª¢å®š *)
  "character_attributes.ml";            (* æä¾›å±¬æ€§æª¢å®š *)
  "quest_event_system.ml";              (* æä¾›ä»»å‹™ç‹€æ…‹ä½œç‚ºæ¢ä»¶ï¼Œè§¸ç™¼ä»»å‹™æ›´æ–° *)
  "dynamic_random_event_system.ml";     (* äº‹ä»¶è§¸ç™¼ç‰¹æ®Šå°è©± *)
  "item_consumable_system.ml";          (* ç‰©å“æ¬„ç‹€æ…‹ä½œç‚ºæ¢ä»¶ï¼Œå°è©±çµ¦äºˆ/ç§»é™¤ç‰©å“ *)
  "equipment.ml";                       (* åŒä¸Š *)
  "world_lore_history_system.ml";       (* å°è©±ä¸­æ¶‰åŠæˆ–æ­ç¤ºä¸–ç•Œå‚³èªª *)
  "ai_behavior_system.ml";              (* æ§åˆ¶ NPC ç™¼èµ·å°è©± *)
  "combat_system_wuxia.ml";             (* å°è©±è§¸ç™¼æˆ°é¬¥ *)
]
;;

--- (* åˆ†éš”ç·š *)
---

(* === ğŸ¤« æ½›è¡Œèˆ‡åµæ¸¬ç³»çµ±æ¨¡çµ„ (stealth_detection_system.ml) - ä¿®æ­£ç‰ˆ V1.1 === *)

## ğŸ“˜ æ¨¡çµ„èªªæ˜ (V1.1)
æœ¬æ¨¡çµ„è² è²¬è¨ˆç®—è§’è‰²åŸ·è¡Œæ½›è¡Œã€å·ç«Šã€å·çªºã€æš—æ®ºç­‰ç§˜å¯†è¡Œå‹•æ™‚ï¼Œè¢«å‘¨åœ NPC åµæ¸¬åˆ°çš„æ©Ÿç‡å’Œçµæœã€‚å…¶è¼¸å‡ºçµæœ (`detection_result`) å°‡ä½œç‚ºå…¶ä»–æ¨¡çµ„ï¼ˆå°¤å…¶æ˜¯è²æœ›ã€AIè¡Œç‚ºã€æµè¨€ç³»çµ±ï¼‰åˆ¤æ–·è¡Œå‹•å¾Œæœçš„é‡è¦ä¾æ“šã€‚V1.1 ç‰ˆæœ¬æ˜ç¢ºäº†è¼¸å‡ºçµæ§‹ï¼Œä»¥ä¾¿æ–¼è²æœ›ç³»çµ±æ‡‰ç”¨ã€Œç„¡ç›®æ“Šå‰‡ç„¡å…¬é–‹å¾Œæœã€è¦å‰‡ã€‚

---

## ğŸ•µï¸ æ ¸å¿ƒæ•¸æ“šçµæ§‹ (V1.1 æ–°å¢/å®šç¾©)

type stealth_action_type = (* æ½›è¡Œç›¸é—œçš„è¡Œå‹•é¡å‹ *)
  | MoveStealthily (* æ½›è¡Œç§»å‹• *)
  | Pickpocket (* å·ç«Š *)
  | Eavesdrop (* å·è½ *)
  | Peeking (* å·çªº *)
  | Lockpicking (* é–‹é– *)
  | TrapDisarming (* æ‹†é™¤é™·é˜± *)
  | AssassinationAttempt (* æš—æ®ºå˜—è©¦ *)
  | Hiding (* èº²è— *)
  | Sabotage (* ç ´å£ *)
;;

type detection_result = { (* V1.1 æ ¸å¿ƒè¼¸å‡º *)
  detected : bool;             (* è¡Œå‹•æ˜¯å¦è¢«è‡³å°‘ä¸€å€‹ NPC åµæ¸¬åˆ° *)
  witness_ids : string list;   (* åµæ¸¬åˆ°è¡Œå‹•çš„ NPC ID åˆ—è¡¨ *)
  detection_level : float;     (* è¢«åµæ¸¬çš„æ¸…æ™°ç¨‹åº¦ (0.0 - 1.0), å½±éŸ¿å¾ŒçºŒåæ‡‰å¼·åº¦ *)
  evidence_left : string list; (* è¡Œå‹•ç•™ä¸‹çš„ç‰©ç†è­‰æ“šæè¿° (ä¾‹å¦‚ï¼š"æ³¥åœ°ä¸Šçš„è…³å°", "è¢«æ’¬å‹•çš„é–€é–ç—•è·¡") *)
  notes: string option;        (* é¡å¤–èªªæ˜ï¼Œä¾‹å¦‚â€œåƒ…è½åˆ°è²éŸ³ä½†æœªè¦‹äººå½±â€ *)
};;

---

## âš™ï¸ æ½›è¡Œç‹€æ…‹ç®¡ç† (Stealth State Management)
(* ä¿ç•™è‡ª Base File *)
let stealth_rules = {
  enter_stealth = {
    command = "[æ½›è¡Œ]";
    prerequisites = ["éæˆ°é¬¥ç‹€æ…‹"; "éé‡å‚·/æ¥µåº¦ç–²å‹"];
    effects = ["ç§»å‹•é€Ÿåº¦é™ä½", "ç²å¾—æ½›è¡ŒæˆåŠŸç‡åŠ æˆ", "é«”åŠ›æ¶ˆè€—å¯èƒ½å¢åŠ ", "è¨­ç½® player.status.isStealth = true"];
  };
  exit_stealth = {
    triggers = ["ä¸»å‹•æŒ‡ä»¤[åœæ­¢æ½›è¡Œ]", "åŸ·è¡Œå¥”è·‘/æ”»æ“Š/å˜ˆé›œå‹•ä½œ", "è¢«å®Œå…¨åµæ¸¬(Detected)"];
    effects = ["æ¢å¾©æ­£å¸¸ç§»å‹•é€Ÿåº¦", "å¤±å»æ½›è¡ŒåŠ æˆ", "è¨­ç½® player.status.isStealth = false"];
  };
}
;;

---

## ğŸ§  æ½›è¡Œåµæ¸¬è¨ˆç®—é‚è¼¯ (Stealth Detection Calculation Logic - V1.1 æ ¸å¿ƒ)

(* æ¦‚å¿µæ€§æè¿°å¦‚ä½•è¨ˆç®—åµæ¸¬çµæœ *)
let stealth_detection_calculation_logic = {

  (** ä¸»è¦åŠŸèƒ½ï¼šæª¢æ¸¬æ½›è¡Œè¡Œå‹• (check_detection)
      è¼¸å…¥:
        - actor_id: è¡Œå‹•è€… ID (e.g., "player_azhai")
        - action_type: åŸ·è¡Œçš„ç§˜å¯†è¡Œå‹•é¡å‹ (ä¾†è‡ª stealth_action_type)
        - actor_stealth_skill: è¡Œå‹•è€…çš„ç›¸é—œæ½›è¡Œç¶œåˆèƒ½åŠ›å€¼ (float)
        - target_id: è¡Œå‹•ç›®æ¨™ ID (string option)
        - environment_factors: ç’°å¢ƒå› ç´ åˆ—è¡¨ (e.g., [("å…‰ç…§åº¦", 0.2); ("å™ªéŸ³æ°´å¹³", 0.8); ("é®è”½ç‰©", 0.6)])
        - observers: æ½›åœ¨è§€å¯Ÿè€…åˆ—è¡¨ï¼Œå«å…¶IDå’Œç¶œåˆæ„ŸçŸ¥èƒ½åŠ›å€¼ ( (string * float) list )
      è¼¸å‡º:
        - detection_result: åŒ…å«åµæ¸¬çµæœçš„è¨˜éŒ„
  *)
  check_detection_process = """
  1. **è¨ˆç®—åŸºç¤æˆåŠŸç‡ (Base Success Chance):**
     - æ ¹æ“šè¡Œå‹•é¡å‹ (action_type) è¨­ç½®åŸºç¤é›£åº¦ã€‚
     - ä¸»è¦å—è¡Œå‹•è€…æ½›è¡Œèƒ½åŠ› (actor_stealth_skill) å½±éŸ¿ã€‚
     - å—ç’°å¢ƒå› ç´ ä¿®æ­£ (å…‰ç…§ä½+, å™ªéŸ³å¤§+, é®è”½ç‰©å¤š+)ã€‚

  2. **éæ­·æ‰€æœ‰æ½›åœ¨è§€å¯Ÿè€… (observers):**
     - å°æ¯å€‹è§€å¯Ÿè€…ï¼Œè¨ˆç®—å…¶ã€åµæ¸¬å°æŠ—æª¢å®šã€‘ã€‚
     - æª¢å®šå—ä»¥ä¸‹å› ç´ å½±éŸ¿ï¼š
       * è§€å¯Ÿè€…çš„æ„ŸçŸ¥èƒ½åŠ› (observer_perception_skill)ã€‚
       * è§€å¯Ÿè€…èˆ‡è¡Œå‹•è€…çš„è·é›¢ã€‚
       * è§€å¯Ÿè€…çš„æ³¨æ„åŠ›ç‹€æ…‹ (è­¦æƒ•/åˆ†å¿ƒ)ã€‚
       * ç’°å¢ƒå› ç´ å°è§€å¯Ÿè€…çš„å½±éŸ¿ (å…‰ç…§ä½-, å™ªéŸ³å¤§-)ã€‚
       * è¡Œå‹•è€…æ½›è¡Œèƒ½åŠ› vs è§€å¯Ÿè€…æ„ŸçŸ¥èƒ½åŠ›çš„å°æŠ—ã€‚
       * è¡Œå‹•é¡å‹æœ¬èº«çš„æš´éœ²é¢¨éšª (action_type specific risk)ã€‚
     - è‹¥æª¢å®šå¤±æ•— (å³è§€å¯Ÿè€…æˆåŠŸåµæ¸¬)ï¼Œè¨˜éŒ„è§€å¯Ÿè€… ID åˆ° witness_ids åˆ—è¡¨ã€‚
     - æ ¹æ“šæª¢å®šæˆåŠŸçš„ç¨‹åº¦ï¼Œæ›´æ–° overall_detection_level (å–æœ€é«˜å€¼)ã€‚

  3. **åˆ¤æ–·æ˜¯å¦ç•™ä¸‹ç‰©ç†è­‰æ“š (evidence_left):**
     - æ ¹æ“šè¡Œå‹•é¡å‹ (action_type) å’Œç’°å¢ƒæ±ºå®šã€‚ (e.g., Lockpicking -> é–€é–ç—•è·¡, é›ªåœ° MoveStealthily -> è…³å°)
     - å°‡æè¿°æ€§å­—ä¸²åŠ å…¥ evidence_left åˆ—è¡¨ã€‚

  4. **ç¶œåˆçµæœ:**
     - æ ¹æ“š witness_ids æ˜¯å¦ç‚ºç©ºè¨­ç½® detected (true/false)ã€‚
     - æ ¹æ“š detection_level æ·»åŠ å¯èƒ½çš„ notes (e.g., "ä¼¼ä¹è¢«å¯Ÿè¦ºäº†å‹•éœ")ã€‚
     - è¿”å›åŒ…å«æ‰€æœ‰è¨ˆç®—çµæœçš„ detection_result è¨˜éŒ„ã€‚
  """;

  calculation_notes = "(* å…·é«”å…¬å¼å’Œé–¾å€¼éœ€è¦æ ¹æ“šéŠæˆ²å¹³è¡¡æ€§ä»”ç´°è¨­è¨ˆå’Œèª¿æ•´ *)";
}
;;

---

## ğŸ“Š å½±éŸ¿æ½›è¡Œèˆ‡åµæ¸¬çš„å› ç´  (Factors Influencing Stealth & Detection)
(* ä¿ç•™è‡ª Base Fileï¼Œèˆ‡ V1.1 è¨ˆç®—é‚è¼¯ä¸€è‡´ *)
let stealth_success_factors = {
  positive = ["é«˜[æ½›è¡Œ]æŠ€èƒ½", "é«˜[AGI]", "è¼•ä¾¿/æ·±è‰²è£å‚™", "é»‘æš—/é™°å½±/æ¿ƒéœ§/å¤§é›¨", "åˆ©ç”¨é®è”½ç‰©", "ç·©æ…¢ç§»å‹•", "ç›®æ¨™éè­¦æˆ’", "è·é›¢é "];
  negative = ["ä½[æ½›è¡Œ]æŠ€èƒ½", "ç¬¨é‡/ç™¼å…‰/äº®è‰²è£å‚™", "å…‰ç…§å……è¶³/ç©ºæ› ", "å¿«é€Ÿç§»å‹•/åŸ·è¡Œæ˜é¡¯å‹•ä½œ", "ç›®æ¨™è­¦æˆ’/æœç´¢", "è·é›¢è¿‘"];
}
;;
let detection_success_factors = {
  positive = ["é«˜[è§€å¯Ÿ]æŠ€èƒ½", "é«˜æ„ŸçŸ¥å±¬æ€§(INT?)", "NPCè­¦æˆ’/æœç´¢", "å…‰ç…§å……è¶³(è¦–è¦º)", "ç’°å¢ƒå®‰éœ(è½è¦º)", "è·é›¢è¿‘", "ç›®æ¨™è¡Œå‹•æ˜é¡¯/æœ‰å™ªéŸ³", "ç‰¹æ®Šåµæ¸¬èƒ½åŠ›"];
  negative = ["ä½[è§€å¯Ÿ]æŠ€èƒ½", "NPCåˆ†å¿ƒ/ç–²å‹/ç¡çœ ", "é»‘æš—/æ¿ƒéœ§/å¤§é›¨(è¦–è¦º)", "ç’°å¢ƒå˜ˆé›œ(è½è¦º)", "è·é›¢é ", "ç›®æ¨™åˆ©ç”¨é®è”½/å½è£"];
}
;;

---

## ğŸ‘ï¸ åµæ¸¬ç­‰ç´šèˆ‡å¾Œæœ (Detection Levels & Consequences)
(* ä¿ç•™è‡ª Base File *)
type detection_level_status = Unaware | Suspicious | Alert | Detected;; (* é‡å‘½åä»¥å€åˆ† detection_result.detection_level (float) *)

let detection_level_definitions = [
  (Unaware, "æœªå¯Ÿè¦º: NPCå®Œå…¨ä¸çŸ¥æƒ…ã€‚æ½›è¡Œè€…è¡Œå‹•è‡ªç”±ã€‚");
  (Suspicious, "æ‡·ç–‘: NPCå¯Ÿè¦ºç•°å¸¸ï¼ˆè²éŸ³/é™°å½±ï¼‰ï¼Œä½†ä¸ç¢ºå®šä¾†æº/å¨è„…ã€‚å¾Œæœï¼šå¯èƒ½è½‰å‘/å‰å¾€å¯ç–‘é»é€²è¡ŒçŸ­æš«ã€ä¸»å‹•åµæ¸¬ã€‘ã€‚è‹¥ç„¡ç™¼ç¾å‰‡å¯èƒ½æ¢å¾©Unawareã€‚");
  (Alert, "è­¦æˆ’: NPCç¢ºèªé™„è¿‘æœ‰å¨è„…ï¼Œä½†ä¸ç¢ºå®šä½ç½®ã€‚å¾Œæœï¼šé€²å…¥é«˜åº¦è­¦æˆ’ï¼Œæ‹”å‡ºæ­¦å™¨ï¼Œå¯èƒ½ç¤ºè­¦ï¼Œåœ¨å€åŸŸå…§é€²è¡Œæ›´å¾¹åº•çš„ã€ä¸»å‹•åµæ¸¬/æœç´¢ã€‘ã€‚");
  (Detected, "å·²ç™¼ç¾: NPCç¢ºå®šæ½›è¡Œè€…ä½ç½®å’Œèº«ä»½ã€‚å¾Œæœï¼šæ½›è¡Œè§£é™¤ï¼è§¸ç™¼æˆ°é¬¥/å‘¼å«æ´è»/å˜—è©¦æŠ“æ•/é€ƒè·‘ï¼ˆç”±AIè¡Œç‚ºæ¨¡çµ„æ±ºå®šï¼‰ã€‚");
]
;;

let detection_state_transition = {
  escalation = "æª¢å®šçµæœ (ä»¥åŠ detection_result.detection_level) æ±ºå®šç‹€æ…‹æ˜¯å¦æå‡ (Unaware -> Suspicious -> Alert -> Detected)ã€‚";
  de_escalation = "è‹¥æ½›è¡Œè€…é•·æ™‚é–“ä¿æŒéš±è”½ä¸”æœªè¢«é€²ä¸€æ­¥ç™¼ç¾ï¼Œè­¦æˆ’ç‹€æ…‹å¯èƒ½éš¨æ™‚é–“é™ä½ (Alert -> Suspicious -> Unaware)ã€‚";
}
;;

---

## ğŸ”ª æ½›è¡Œæ”»æ“Š (Sneak Attack)
(* ä¿ç•™è‡ª Base File *)
let sneak_attack_rules = {
  trigger_conditions = ["ç©å®¶è™•æ–¼æ½›è¡Œç‹€æ…‹", "ç›®æ¨™NPCè™•æ–¼ Unaware æˆ– Suspicious ç‹€æ…‹"];
  effects = [ (* æ•ˆæœå‚³éçµ¦ combat_system_wuxia.ml *)
    "ç²å¾—ä¸€æ¬¡æ”»æ“ŠåŠ æˆ (å¿…å®šå‘½ä¸­? / æé«˜æš´æ“Šç‡? / é¡å¤–å‚·å®³?)";
    "å¯èƒ½ä½¿ç›®æ¨™é¦–å›åˆæªæ‰‹ä¸åŠ (ç„¡æ³•æ ¼æ“‹/é–ƒé¿?)";
  ];
  consequences = "ç™¼å‹•æ½›è¡Œæ”»æ“Šé€šå¸¸ç«‹åˆ»è§£é™¤æ½›è¡Œç‹€æ…‹ï¼Œä¸¦é©šå‹•å‘¨åœNPCé€²å…¥ Alert æˆ– Detected ç‹€æ…‹ã€‚";
}
;;

---

## ğŸ”— ä¾è³´æ¨¡çµ„ (Dependencies)
(* ä¿ç•™è‡ª Base Fileï¼Œèˆ‡ V1.1 å…§å®¹ä¸€è‡´ *)
```ml
let stealth_depends_on = [
  "skills_proficiency.ml";        (* [æ½›è¡Œ] å’Œ [è§€å¯Ÿ] æŠ€èƒ½ *)
  "character_attributes.ml";      (* AGI, INT ç­‰å±¬æ€§ *)
  "equipment.ml";                 (* è£å‚™å½±éŸ¿å™ªéŸ³/å¯è¦‹åº¦ *)
  "map_exploration_system.ml";    (* å€åŸŸç’°å¢ƒä¿¡æ¯ (é®è”½ã€åœ°å½¢) *)
  "world_settings.ml";            (* å…‰ç…§ã€å¤©æ°£ *)
  "npc_stats_tracker.ml";         (* NPC è§€å¯ŸæŠ€èƒ½ã€å±¬æ€§ã€ç‹€æ…‹ *)
  "ai_behavior_system.ml";        (* NPC è­¦è¦ºç‹€æ…‹ã€åæ‡‰è¡Œç‚º *)
  "combat_system_wuxia.ml";       (* æ½›è¡Œæ”»æ“Šæ•ˆæœã€è¢«ç™¼ç¾å¾Œé€²å…¥æˆ°é¬¥ *)
  "reputation_system_comprehensive.ml"; (* ã€V1.1 é—œè¯ã€‘è¼¸å‡º detection_result çµ¦è²æœ›ç³»çµ± *)
  "rumor_gossip_system.ml";       (* ã€V1.1 é—œè¯ã€‘æ ¹æ“š detection_result è§¸ç™¼æµè¨€ *)
  (* "special_abilities.ml", *)   (* (å¯é¸) ç‰¹æ®Šåµæ¸¬èƒ½åŠ› *)
]
;;

(* **ã€V1.1 è¨»é‡‹ã€‘** æœ¬æ¨¡çµ„çš„æ ¸å¿ƒè·è²¬æ˜¯åˆ¤æ–·ã€æ˜¯å¦è¢«ç™¼ç¾ã€‘ä»¥åŠã€è¢«èª°ç™¼ç¾/ç•™ä¸‹ä½•ç¨®è­‰æ“šã€‘ã€‚
   å…¶è¼¸å‡ºçš„ `detection_result` ä¸­çš„ `detected` å’Œ `evidence_left` å­—æ®µï¼Œ
   å°‡è¢«ã€ç¶œåˆè²æœ›èˆ‡è©•åƒ¹ç³»çµ±æ¨¡çµ„ã€‘ç”¨æ–¼åˆ¤æ–·æ˜¯å¦å°æœªè¢«ç™¼ç¾çš„è² é¢è¡Œç‚ºæ–½åŠ å…¬é–‹çš„é“å¾·/è²æœ›æ‡²ç½°ï¼Œ
   ä¸¦å¯èƒ½å½±éŸ¿ã€æµè¨€ç³»çµ±ã€‘æ˜¯å¦ç”Ÿæˆç›¸é—œå‚³èã€‚
*)

(* ============================================================ *)
(* ==    åˆä½µæ¨¡çµ„ Part 6: äº’å‹•ç³»çµ± (Interaction Systems) çµæŸ   == *)
(* ============================================================ *)